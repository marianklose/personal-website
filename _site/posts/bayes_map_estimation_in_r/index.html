<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Marian Klose">
<meta name="dcterms.date" content="2025-03-31">
<meta name="description" content="How to perform Bayesian MAP estimation yourself using R and why you should care.">

<title>Reproducing NONMEM’s MAP estimation in R – Marian Klose</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../img/favicon.ico" rel="icon">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-ddd961a2510921635943dfbbd19534c4.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="../../site_libs/kePrint-0.0.1/kePrint.js"></script>

<link href="../../site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">


  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Marian Klose</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../publications/publications.html"> 
<span class="menu-text">Publications</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../cv/cv.html"> 
<span class="menu-text">CV</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../posts.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">Reproducing NONMEM’s MAP estimation in R</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
                  <div>
        <div class="description">
          How to perform Bayesian MAP estimation yourself using R and why you should care.
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">NONMEM</div>
                <div class="quarto-category">Bayes</div>
                <div class="quarto-category">MAP</div>
                <div class="quarto-category">EBE</div>
                <div class="quarto-category">Estimation</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p><a href="https://github.com/marianklose">Marian Klose</a> <a href="https://orcid.org/0009-0005-1706-6289" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">March 31, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#sec-motivation" id="toc-sec-motivation" class="nav-link active" data-scroll-target="#sec-motivation"><span class="header-section-number">1</span> Motivation</a></li>
  <li><a href="#sec-structure" id="toc-sec-structure" class="nav-link" data-scroll-target="#sec-structure"><span class="header-section-number">2</span> Structure</a></li>
  <li><a href="#sec-bayesian-idea" id="toc-sec-bayesian-idea" class="nav-link" data-scroll-target="#sec-bayesian-idea"><span class="header-section-number">3</span> The Bayesian Idea: Updating Beliefs</a>
  <ul class="collapse">
  <li><a href="#sec-bayesian-idea-example" id="toc-sec-bayesian-idea-example" class="nav-link" data-scroll-target="#sec-bayesian-idea-example"><span class="header-section-number">3.1</span> Starting with an example</a></li>
  <li><a href="#sec-bayesian-idea-terminology" id="toc-sec-bayesian-idea-terminology" class="nav-link" data-scroll-target="#sec-bayesian-idea-terminology"><span class="header-section-number">3.2</span> Terminology</a></li>
  <li><a href="#sec-bayesian-idea-goal" id="toc-sec-bayesian-idea-goal" class="nav-link" data-scroll-target="#sec-bayesian-idea-goal"><span class="header-section-number">3.3</span> Our goal in pharmacometrics</a></li>
  </ul></li>
  <li><a href="#sec-pharmex" id="toc-sec-pharmex" class="nav-link" data-scroll-target="#sec-pharmex"><span class="header-section-number">4</span> Pharmacometric example and reference solution</a>
  <ul class="collapse">
  <li><a href="#sec-pharmex-data" id="toc-sec-pharmex-data" class="nav-link" data-scroll-target="#sec-pharmex-data"><span class="header-section-number">4.1</span> Data and visualization</a></li>
  <li><a href="#sec-pharmex-nlme" id="toc-sec-pharmex-nlme" class="nav-link" data-scroll-target="#sec-pharmex-nlme"><span class="header-section-number">4.2</span> NLME model structure</a></li>
  <li><a href="#sec-pharmex-model" id="toc-sec-pharmex-model" class="nav-link" data-scroll-target="#sec-pharmex-model"><span class="header-section-number">4.3</span> NONMEM model</a></li>
  </ul></li>
  <li><a href="#sec-bayesth" id="toc-sec-bayesth" class="nav-link" data-scroll-target="#sec-bayesth"><span class="header-section-number">5</span> Bayesian Theory</a>
  <ul class="collapse">
  <li><a href="#sec-bayesth-general" id="toc-sec-bayesth-general" class="nav-link" data-scroll-target="#sec-bayesth-general"><span class="header-section-number">5.1</span> General form of Bayes’ theorem</a></li>
  <li><a href="#sec-bayesth-pharmetrx" id="toc-sec-bayesth-pharmetrx" class="nav-link" data-scroll-target="#sec-bayesth-pharmetrx"><span class="header-section-number">5.2</span> Pharmacometric context</a></li>
  <li><a href="#sec-bayesth-map" id="toc-sec-bayesth-map" class="nav-link" data-scroll-target="#sec-bayesth-map"><span class="header-section-number">5.3</span> MAP estimation</a>
  <ul class="collapse">
  <li><a href="#sec-bayesth-map-prior" id="toc-sec-bayesth-map-prior" class="nav-link" data-scroll-target="#sec-bayesth-map-prior"><span class="header-section-number">5.3.1</span> Prior term</a></li>
  <li><a href="#sec-bayesth-map-likelihood" id="toc-sec-bayesth-map-likelihood" class="nav-link" data-scroll-target="#sec-bayesth-map-likelihood"><span class="header-section-number">5.3.2</span> Likelihood term</a></li>
  </ul></li>
  <li><a href="#sec-bayesth-map-final" id="toc-sec-bayesth-map-final" class="nav-link" data-scroll-target="#sec-bayesth-map-final"><span class="header-section-number">5.4</span> Combining both terms</a></li>
  </ul></li>
  <li><a href="#sec-rrepro" id="toc-sec-rrepro" class="nav-link" data-scroll-target="#sec-rrepro"><span class="header-section-number">6</span> R-based MAP reproduction</a>
  <ul class="collapse">
  <li><a href="#sec-rrepro-prior" id="toc-sec-rrepro-prior" class="nav-link" data-scroll-target="#sec-rrepro-prior"><span class="header-section-number">6.1</span> Prior term</a></li>
  <li><a href="#sec-rrepro-likelihood" id="toc-sec-rrepro-likelihood" class="nav-link" data-scroll-target="#sec-rrepro-likelihood"><span class="header-section-number">6.2</span> Likelihood term</a></li>
  <li><a href="#map-rrepro-mapestim" id="toc-map-rrepro-mapestim" class="nav-link" data-scroll-target="#map-rrepro-mapestim"><span class="header-section-number">6.3</span> MAP estimation (posterior)</a></li>
  <li><a href="#sec-map-rrepro-comp" id="toc-sec-map-rrepro-comp" class="nav-link" data-scroll-target="#sec-map-rrepro-comp"><span class="header-section-number">6.4</span> Comparison of prior, likelihood, and posterior</a></li>
  </ul></li>
  <li><a href="#map-rrepro-conclusion" id="toc-map-rrepro-conclusion" class="nav-link" data-scroll-target="#map-rrepro-conclusion"><span class="header-section-number">7</span> Conclusion</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load packages</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr) </span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(xpose4)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="sec-motivation" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Motivation</h1>
<p>Bayesian estimation is a widely-used method in pharmacometrics. Many pharmacometricians utilize individual predictions (<code>IPRED</code>) in their diagnostics, which represent simulations based on the <em>maximum a-posteriori</em> (MAP) estimates <a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>. These estimates essentially represent the mode of the so-called <em>posterior</em> distribution, which combines prior knowledge about the population and new evidence about the particular individual at hand (more to that later). <code>MAP</code> estimates also play a crucial role in <em>Model-Informed Precision Dosing</em> (MIPD), where one aims to predict the concentration-time profile of an individual, given a pharmacokinetic NLME model and a set of drug concentrations measured through a <em>Therapeutic Drug Monitoring</em> (TDM) program. During model building, the underlying individualized <code>ETAs</code> are often used for covariate screening, provided that shrinkage permits it. As you can see, Bayesian estimation is quite prominent in pharmacometric workflows. Thomas Bayes would be proud of us!</p>
<div id="fig-thomas-bayes" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-thomas-bayes-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="media/Thomas_Bayes.gif" class="img-fluid figure-img" style="width:40.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-thomas-bayes-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Portrait of Thomas Bayes.
</figcaption>
</figure>
</div>
<p>In many scenarios, these Bayesian calculations happen automatically <em>under the hood</em> when fitting pharmacometric models (e.g., in NONMEM), making it quite easy to use Bayesian estimates without exploring the underlying concepts and calculations. I myself did this for quite some time. Reproducing calculations through equations is often the best way to grasp the underlying principles. Therefore, I have decided to write this blogpost, in which I want to explain the Bayesian idea and reproduce a simple Bayesian MAP estimation in R. I will mainly focus on the point estimates of the posterior distribution (<code>MAP</code> or <code>EBE</code>). Addressing the full <em>posterior</em> distribution is also important and might be covered in a future post. There are other nice blogposts which cover full Bayesian approaches in more detail, such as <span class="citation" data-cites="navarro2023">Navarro (<a href="#ref-navarro2023" role="doc-biblioref">2023</a>)</span>.</p>
<p>Please note: These are just my personal reflections and interpretations of Bayesian concepts. I cannot guarantee that my explanations, equations, or terminology are flawless. If you notice any inaccuracies, please let me know so I can correct them!</p>
</section>
<section id="sec-structure" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Structure</h1>
<p>Let me briefly outline how I structured this blogpost. The overall goal is to better understand the Bayesian concept behind MAP estimation and to derive an individualized clearance estimate for a virtual patient using R, step by step.</p>
<p>I start with my own little introduction of the Bayesian idea (<a href="#sec-bayesian-idea" class="quarto-xref">Section&nbsp;3</a>) using a real-world example and define the key components—prior, likelihood, and posterior.</p>
<p>This is then followed by a pharmacometric example using a simulated dataset (from my previous blogpost) and a simple one-compartment i.v. bolus PK model as reference (<a href="#sec-pharmex" class="quarto-xref">Section&nbsp;4</a>). This section also includes our NONMEM reference solution which is later used to validate our calculations in R.</p>
<p>Next, we try to explore the Bayesian theory a bit more, dealing with the mathematical formulation of MAP estimation and explaining how the prior and likelihood combine to form the posterior (<a href="#sec-bayesth" class="quarto-xref">Section&nbsp;5</a>).</p>
<p>Afterwards, we move on to the R-based MAP reproduction (<a href="#sec-rrepro" class="quarto-xref">Section&nbsp;6</a>). We implement the prior and likelihood functions, combine them into an optimization routine, and estimate the individual parameter from scratch. Finally, we are able to compare the R-based result to the NONMEM output and visualize how prior, likelihood, and posterior interact.</p>
<p>With that being said, let’s get started!</p>
</section>
<section id="sec-bayesian-idea" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> The Bayesian Idea: Updating Beliefs</h1>
<section id="sec-bayesian-idea-example" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="sec-bayesian-idea-example"><span class="header-section-number">3.1</span> Starting with an example</h2>
<p>I would say that many of us naturally think Bayesian, even if we are not aware of it or if we don’t label it that way. At its core, Bayesian statistics is about updating your beliefs once new data or information becomes available. Let’s consider an example from the real-world to illustrate this idea.</p>
<p>Imagine you drive to work every day. If someone would ask you “How long will it take you to get to work tomorrow?”, you would probably have a good idea, simply based on your past experiences. 30 minutes might be your best guess, but would you bet money that it will be exactly 30 minutes? Probably not, as you will always have some uncertainty associated with it. Perhaps something between 20 and 40 minutes would be reasonable based on your previous trips. Now, let’s assume you get into your car the next morning and after 25 minutes, you have made it halfway.</p>
<div id="fig-traffic-jam" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-traffic-jam-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="media/pexels-aayushsri-1445653.jpg" class="img-fluid figure-img" style="width:80.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-traffic-jam-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: A traffic jam on your way to work. Credits: Aayush Srivastava, Pexels.
</figcaption>
</figure>
</div>
<p>Would you stick to your initial belief that it will take you 30 minutes? Probably not, you would likely revise it (or try to break all speed limits). But would you simply double the 25 minutes to predict a 50-minute commute? This is also unlikely, given your experience suggesting that 40 minutes is usually the upper limit. So, maybe you would adjust your estimate to 38 minutes, assuming that the traffic will get better soon. This is Bayesian thinking in action: Updating your beliefs with new data. But so far without any equation and rather based on gut-feeling.</p>
</section>
<section id="sec-bayesian-idea-terminology" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="sec-bayesian-idea-terminology"><span class="header-section-number">3.2</span> Terminology</h2>
<p>Now, let’s map this real-world scenario to some Bayesian terminology. There are three key components in every Bayesian analysis:</p>
<ul>
<li><strong>Prior:</strong> Your initial belief - 30 minutes, plus some uncertainty.</li>
<li><strong>Likelihood:</strong> The new data - taking 25 min to cover half the distance and suggesting 50 min for the full trip.</li>
<li><strong>Posterior:</strong> Your updated estimate - now around 38 minutes, combining prior and likelihood.</li>
</ul>
<p>Bayesian analysis starts with a prior, which you revise using new data (likelihood) to obtain the posterior. In pharmacometrics, we often encounter two levels of complexity when it comes to Bayes:</p>
<ul>
<li><strong>MAP / EBE:</strong> Simply focuses on the mode of the posterior distribution and ignores its uncertainty.</li>
<li><strong>Full Bayesian:</strong> Considers the entire posterior distribution, not just the mode or a point estimate.</li>
</ul>
<p>Many pharmacometricians use MAP estimates due to their computational simplicity and their direct integration into standard NLME routines, while full Bayesian methods offer a more comprehensive view by integrating uncertainty even after new data became available. Full Bayesian methods are more and more used in the field, also thanks to some nice tutorials by <span class="citation" data-cites="margossianFlexibleEfficientBayesian2022">Margossian, Zhang, and Gillespie (<a href="#ref-margossianFlexibleEfficientBayesian2022" role="doc-biblioref">2022</a>)</span> for Stan/Torsten and by <span class="citation" data-cites="johnstonBayesianEstimationNONMEM2024">Johnston et al. (<a href="#ref-johnstonBayesianEstimationNONMEM2024" role="doc-biblioref">2024</a>)</span> for NONMEM itself, both from the Metrum Research Group.</p>
</section>
<section id="sec-bayesian-idea-goal" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="sec-bayesian-idea-goal"><span class="header-section-number">3.3</span> Our goal in pharmacometrics</h2>
<p>So, what role does Bayesian methodology play in pharmacometrics? Obviously it is not about optimizing your commute. Instead, we typically use Bayesian estimation to individualize the model parameters for a given individual <span class="math inline">\(i\)</span>, which has a set of unique observations <span class="math inline">\(Y_{i}\)</span>. This concept was first introduced to the pharmacometric community by <span class="citation" data-cites="sheiner1972">Sheiner, Rosenberg, and Melmon (<a href="#ref-sheiner1972" role="doc-biblioref">1972</a>)</span>, if I am not mistaken. On the one hand, <code>MAP</code> estimation happens during model building, at each iteration step <a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> and then after the actual estimation has finished, at the <code>POSTHOC</code> step. On the other hand, it is also used in MIPD settings as described above. The approach remains the same, and we will later have a look at a simple pharmacokinetic example to illustrate this.</p>
<p>So far we used a relatable example rather focusing on the intuition behind Bayesian thinking. Now we want to dive a bit into the mathematics behind it to be able to formally reproduce a simple Bayesian MAP estimation in R.</p>
</section>
</section>
<section id="sec-pharmex" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Pharmacometric example and reference solution</h1>
<section id="sec-pharmex-data" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="sec-pharmex-data"><span class="header-section-number">4.1</span> Data and visualization</h2>
<p>Without data, no Bayesian parameter individualization. For our MAP estimation, we are using the same simulated data set I have defined in the previous blogpost about NLME modelling. See <span class="citation" data-cites="klose2025">Klose (<a href="#ref-klose2025" role="doc-biblioref">2025</a>)</span> for more details about this data set. Let’s start by loading the simulated concentration-time data and showing the head of the data set:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># read in simulated dataset from previous blogpost</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>sim_data <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"./data/sim_data.csv"</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># show data </span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>sim_data <span class="sc">|&gt;</span>  </span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>() <span class="sc">|&gt;</span> </span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>() <span class="sc">|&gt;</span> </span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">ID</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">TIME</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">EVID</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">AMT</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">RATE</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">DV</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">MDV</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.0000</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.01</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">30.8160</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">3.00</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">24.5520</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">6.00</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">17.9250</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">12.00</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">10.1100</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">24.00</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">3.5975</td>
<td style="text-align: right;">0</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>We will focus on ID 5, which has lower simulated concentrations than the average individual, making it easier to observe differences between typical and individualized profiles. Here’s a plot to visualize these concentration-time profiles of ID 5 and the other IDs of the virtual population:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># show individual profiles</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>sim_data <span class="sc">|&gt;</span> </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(EVID <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">|&gt;</span> </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">flag =</span> <span class="fu">if_else</span>(ID <span class="sc">==</span> <span class="dv">5</span>, <span class="st">"Reference"</span>, <span class="st">"Others"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>TIME, <span class="at">y=</span>DV, <span class="at">group=</span>ID, <span class="at">color=</span><span class="fu">as.factor</span>(flag))) <span class="sc">+</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>()<span class="sc">+</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()<span class="sc">+</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="cn">NA</span>))<span class="sc">+</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x=</span><span class="st">"Time after last dose [h]"</span>, <span class="at">y=</span><span class="st">"Concentration [mg/L]"</span>)<span class="sc">+</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="st">"Individual"</span>, <span class="at">values=</span><span class="fu">c</span>(<span class="st">"grey"</span>, <span class="st">"darkblue"</span>))<span class="sc">+</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Simulated concentration time data after i.v. bolus injection"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-sim-vis" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-sim-vis-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="index_files/figure-html/fig-sim-vis-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-sim-vis-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Simulated concentration-time profiles for 10 individuals after i.v. bolus injection. ID 5 (blue) represents our exemplary ID.
</figcaption>
</figure>
</div>
</div>
</div>
<p>We will later need this data set when running the NONMEM-based MAP estimation, so we have to save it to file. Prior to that, we will filter the data set to only include the data for ID 5:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># define sim_data with ID == 5</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>sim_data_id5 <span class="ot">&lt;-</span> sim_data <span class="sc">|&gt;</span> </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(ID <span class="sc">==</span> <span class="dv">5</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co"># save data for NONMEM</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>sim_data_id5 <span class="sc">|&gt;</span> </span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_csv</span>(<span class="st">"./data/sim_data_ID5.csv"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>With that being done, we are all set to define the NLME model in NONMEM in a next step!</p>
</section>
<section id="sec-pharmex-nlme" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="sec-pharmex-nlme"><span class="header-section-number">4.2</span> NLME model structure</h2>
<p>For our example and reference, we’ll use a simple one-compartment IV model with first-order kinetics, previously fitted to similar data (<span class="citation" data-cites="klose2025">Klose (<a href="#ref-klose2025" role="doc-biblioref">2025</a>)</span>). Here’s a sketch of the simple model structure:</p>
<div id="fig-mod-struct" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-mod-struct-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="media/model_structure.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-mod-struct-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: Model structure of our simple 1 cmt i.v. bolus model with first order kinetics.
</figcaption>
</figure>
</div>
<p>Assuming our model is already fitted, our goal is to individualize parameters for ID 5. The model parameter estimates are based on the fitted model from the previous blogpost and are as follows:</p>
<ul>
<li><span class="math inline">\(CL\)</span> = 0.247 L/h</li>
<li><span class="math inline">\(V\)</span> = 3.15 L</li>
<li><span class="math inline">\(\omega^2_{CL}\)</span> = 0.11</li>
<li><span class="math inline">\(\sigma^2_{RUV\_ADD}\)</span> = 2.00</li>
<li><span class="math inline">\(\sigma^2_{RUV\_PROP}\)</span> = 0.50</li>
</ul>
<p>In a next step, we will translate this into a NONMEM model. Note that we added a proportional error term to the previously used model to better illustrate the differences among prior, likelihood, and posterior distributions <a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>. For the same reason, we increased the additive error to 2 mg/L. Let’s store this information, along with the 100 mg intravenous bolus dose administered to the individual, in a list object for easy retrieval during subsequent calculations:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># store model parameters in list</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>mod_par <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">tvcl =</span> <span class="fl">0.247</span>,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">tvvd =</span> <span class="fl">3.15</span>,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">omega2_CL =</span> <span class="fl">0.11</span>,</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">sigma2_add =</span> <span class="dv">2</span>,</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">sigma2_prop =</span> <span class="fl">0.50</span>, </span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">dose =</span> <span class="dv">100</span> </span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="co"># show </span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>mod_par </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>$tvcl
[1] 0.247

$tvvd
[1] 3.15

$omega2_CL
[1] 0.11

$sigma2_add
[1] 2

$sigma2_prop
[1] 0.5

$dose
[1] 100</code></pre>
</div>
</div>
<p>Great! Now we can go ahead and define the NONMEM model.</p>
</section>
<section id="sec-pharmex-model" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="sec-pharmex-model"><span class="header-section-number">4.3</span> NONMEM model</h2>
<p>We have updated our NONMEM model slightly from the last blogpost:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>1cmt_iv_map_est.mod</strong></pre>
</div>
<div class="sourceCode" id="cb7" data-filename="1cmt_iv_map_est.mod"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>PROBLEM <span class="dv">1</span>cmt_iv_map_est</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>INPUT ID TIME EVID AMT RATE DV MDV</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>DATA C<span class="sc">:</span>\Users\mklose\Desktop\GitHub\personal<span class="sc">-</span>website\posts\bayes_map_estimation_r\data\sim_data_ID5.csv IGNORE<span class="ot">=</span><span class="er">@</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="er">$</span>SUBROUTINES ADVAN1 TRANS2</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>PK</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>; define fixed effects parameters</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>CL <span class="ot">=</span> <span class="fu">THETA</span>(<span class="dv">1</span>) <span class="sc">*</span> <span class="fu">EXP</span>(<span class="fu">ETA</span>(<span class="dv">1</span>))</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>V <span class="ot">=</span> <span class="fu">THETA</span>(<span class="dv">2</span>)</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>; scaling</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>S1<span class="ot">=</span>V</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>THETA</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="fl">0.247</span> FIX               ; <span class="dv">1</span> TVCL</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a><span class="fl">3.15</span> FIX                ; <span class="dv">2</span> TVV</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>OMEGA </span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a><span class="fl">0.11</span> FIX                ; <span class="dv">1</span> OM_CL</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>SIGMA</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a><span class="fl">0.50</span> FIX                ; <span class="dv">1</span> SIG_PROP</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a><span class="fl">2.00</span> FIX                ; <span class="dv">2</span> SIG_ADD</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>ERROR </span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>; add residual unexplained variability</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>IPRED <span class="ot">=</span> F</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">=</span> IPRED <span class="sc">+</span> IPRED <span class="sc">*</span> <span class="fu">EPS</span>(<span class="dv">1</span>) <span class="sc">+</span> <span class="fu">EPS</span>(<span class="dv">2</span>)</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>ESTIMATION METHOD<span class="ot">=</span><span class="dv">1</span> INTERACTION MAXEVAL<span class="ot">=</span><span class="dv">0</span> SIGDIG<span class="ot">=</span><span class="dv">3</span> PRINT<span class="ot">=</span><span class="dv">1</span> NOABORT POSTHOC</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>TABLE ID TIME EVID AMT RATE DV PRED IPRED MDV ETA1 CL NOAPPEND ONEHEADER NOPRINT FILE<span class="ot">=</span>map_estim_out</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We have fixed the initial parameter estimates to the final estimates from before and incorporated a combined error model (as described above). By using <code>MAXEVAL=0</code>, we avoid any population parameter estimation and the model is simply being evaluated. The <code>POSTHOC</code> option computes individual MAP estimates as this is the core of our task. We need to make sure that we include the <code>INTERACTION</code> option in the <code>$ESTIMATION</code> block, as this tells NONMEM to include the effect of <code>ETA</code> on the residual error when performing MAP estimation <a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>. This is important as our error model now depends on <code>IPRED</code>, which in turn depends on <code>ETA.</code></p>
<p>After running the model, we’ll read the output through <code>map_estim_out</code>:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load simulated data</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>nm_out <span class="ot">&lt;-</span> <span class="fu">read_nm_table</span>(<span class="st">"./models/map_estim_out"</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co"># show simulated data</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>nm_out <span class="sc">|&gt;</span> </span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>() <span class="sc">|&gt;</span> </span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>() <span class="sc">|&gt;</span> </span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">ID</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">TIME</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">EVID</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">AMT</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">RATE</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">DV</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">PRED</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">IPRED</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">MDV</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">ETA1</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">CL</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">5</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.00000</td>
<td style="text-align: right;">31.7460</td>
<td style="text-align: right;">31.7460</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.55194</td>
<td style="text-align: right;">0.42894</td>
</tr>
<tr class="even">
<td style="text-align: right;">5</td>
<td style="text-align: right;">0.01</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">31.61900</td>
<td style="text-align: right;">31.7210</td>
<td style="text-align: right;">31.7030</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.55194</td>
<td style="text-align: right;">0.42894</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5</td>
<td style="text-align: right;">3.00</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">19.66000</td>
<td style="text-align: right;">25.0920</td>
<td style="text-align: right;">21.1000</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.55194</td>
<td style="text-align: right;">0.42894</td>
</tr>
<tr class="even">
<td style="text-align: right;">5</td>
<td style="text-align: right;">6.00</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">12.00700</td>
<td style="text-align: right;">19.8320</td>
<td style="text-align: right;">14.0230</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.55194</td>
<td style="text-align: right;">0.42894</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5</td>
<td style="text-align: right;">12.00</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">4.33360</td>
<td style="text-align: right;">12.3890</td>
<td style="text-align: right;">6.1947</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.55194</td>
<td style="text-align: right;">0.42894</td>
</tr>
<tr class="even">
<td style="text-align: right;">5</td>
<td style="text-align: right;">24.00</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.78148</td>
<td style="text-align: right;">4.8349</td>
<td style="text-align: right;">1.2088</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.55194</td>
<td style="text-align: right;">0.42894</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>The <code>ETA1</code> (= <span class="math inline">\(\eta_i\)</span>) value represents the individual random effect, while <code>CL</code> (= <span class="math inline">\(CL_i\)</span>) is the individual clearance estimate:</p>
<p><span id="eq-cl-individual"><span class="math display">\[CL_i = \theta_{TVCL} \cdot \exp(\eta_i) \tag{1}\]</span></span></p>
<p>Calculating this in R yields:</p>
<p><span id="eq-cl-individual-num"><span class="math display">\[CL_i = 0.247 \cdot \exp(0.55194) = 0.42894 \tag{2}\]</span></span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate individual MAP estimate</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>mod_par<span class="sc">$</span>tvcl<span class="sc">*</span><span class="fu">exp</span>(nm_out<span class="sc">$</span>ETA1 <span class="sc">|&gt;</span> <span class="fu">unique</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.4289448</code></pre>
</div>
</div>
<p>Great! We obtained our reference solution for the MAP parameter individualization. We can now visually compare <code>DV</code>, <code>PRED</code>, and <code>IPRED</code>:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot DV, PRED, IPRED</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>nm_out <span class="sc">|&gt;</span> </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(TIME <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">|&gt;</span> </span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols=</span><span class="fu">c</span>(PRED, IPRED, DV), <span class="at">names_to=</span><span class="st">"variable"</span>, <span class="at">values_to=</span><span class="st">"value"</span>) <span class="sc">|&gt;</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>TIME, <span class="at">y=</span>value, <span class="at">group=</span>variable, <span class="at">color=</span>variable))<span class="sc">+</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>()<span class="sc">+</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()<span class="sc">+</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Concentration [mg/L]"</span>,</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Time after last dose [h]"</span>,</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Comparison of DV, PRED and IPRED for ID 5"</span>,</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Source"</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-comp-dv-pred-ipred" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-comp-dv-pred-ipred-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="index_files/figure-html/fig-comp-dv-pred-ipred-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-comp-dv-pred-ipred-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: Comparison of observations (DV), population predictions (PRED), and individualized predictions based on the MAP estimate for CL (IPRED).
</figcaption>
</figure>
</div>
</div>
</div>
<p>Notably, our reference individual’s data (<code>DV</code>) diverges from typical predictions (<code>PRED</code>), while individualized predictions (<code>IPRED</code>) fall in between. Let’s dive deeper into the process to understand these differences.</p>
</section>
</section>
<section id="sec-bayesth" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Bayesian Theory</h1>
<section id="sec-bayesth-general" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="sec-bayesth-general"><span class="header-section-number">5.1</span> General form of Bayes’ theorem</h2>
<p>As described earlier, the primary goal of a Bayesian approach is to obtain the posterior distribution, either as the mode or as the complete distribution. Bayes’ theorem is commonly presented as follows:</p>
<p><span id="eq-bayes-general"><span class="math display">\[P(A|B) = \frac{P(A) \cdot P(B|A)}{P(B)} \tag{3}\]</span></span></p>
<p>Here, conditional probabilities are utilized, and <span class="math inline">\(P(A|B)\)</span> represents the probability of event <span class="math inline">\(A\)</span> given event <span class="math inline">\(B\)</span> has occurred. However, this remains quite theoretical. Let’s directly translate it into the context of a pharmacokinetic NLME model.</p>
</section>
<section id="sec-bayesth-pharmetrx" class="level2" data-number="5.2">
<h2 data-number="5.2" class="anchored" data-anchor-id="sec-bayesth-pharmetrx"><span class="header-section-number">5.2</span> Pharmacometric context</h2>
<p>In pharmacometrics, we aim to determine the most likely individual random effect <span class="math inline">\(\eta_i\)</span> (which translates to the individual parameter <span class="math inline">\(CL_i\)</span>), given the observed concentration data <span class="math inline">\(Y_{i}\)</span> for the individual. Therefore, we are mostly interested to find the posterior distribution of the individual random effect <span class="math inline">\(\eta_i\)</span> given the data <span class="math inline">\(Y_{i}\)</span>:</p>
<p><span id="eq-bayes-specific-norm"><span class="math display">\[p(\eta_i|Y_{i}) = \frac{p(\eta_i) \cdot p(Y_{i}|\eta_i)}{p(Y_i)} \tag{4}\]</span></span></p>
<p>with</p>
<ul>
<li><span class="math inline">\(p(\eta_i|Y_{i})\)</span>: posterior distribution of parameter <span class="math inline">\(\eta_i\)</span> given the individual data <span class="math inline">\(Y_{i}\)</span></li>
<li><span class="math inline">\(p(\eta_i)\)</span>: prior distribution of parameter <span class="math inline">\(\eta_i\)</span></li>
<li><span class="math inline">\(p(Y_{i}|\eta_i)\)</span>: likelihood of observing data <span class="math inline">\(Y_{i}\)</span> given parameter <span class="math inline">\(\eta_i\)</span></li>
<li><span class="math inline">\(p(Y_{i})\)</span>: marginal likelihood of data <span class="math inline">\(Y_{i}\)</span></li>
</ul>
<p>The marginal likelihood <span class="math inline">\(p(Y_{i})\)</span> is typically neglected because it just acts as a scaling factor, does not depend on <span class="math inline">\(\eta_i\)</span>, and is computationally difficult due to a high-dimensional integral. Thus, the formula is often simplified to:</p>
<p><span id="eq-bayes-specific-unnorm"><span class="math display">\[p(\eta_i|Y_{i}) \propto p(\eta_i) \cdot p(Y_{i}|\eta_i) \tag{5}\]</span></span></p>
<p>Removing the marginal likelihood gives an unnormalized posterior distribution, indicated by the proportional sign. Working with an unnormalized posterior is acceptable when our when we solely care about finding the mode of the posterior distribution (MAP estimate), as normalization is unnecessary in this scenario. But how exactly do we calculate the MAP estimate?</p>
</section>
<section id="sec-bayesth-map" class="level2" data-number="5.3">
<h2 data-number="5.3" class="anchored" data-anchor-id="sec-bayesth-map"><span class="header-section-number">5.3</span> MAP estimation</h2>
<p>To find the most likely parameter for an individual, we must identify the maximum of the posterior distribution (MAP estimate). Mathematically, this involves finding the parameter <span class="math inline">\(\eta_i^*\)</span> that maximizes the posterior:</p>
<p><span id="eq-map-norm"><span class="math display">\[\eta_i^* = \underset{\eta_i}{\mathrm{argmax}}~ p(\eta_i|Y_{i}) = \underset{\eta_i}{\mathrm{argmax}}~ p(\eta_i) \cdot \prod_{j=1}^{m} p(Y_{ij}|\eta_i) \tag{6}\]</span></span></p>
<p>Dealing with products of small probability densities can be cumbersome (and mathematically instable), so taking the logarithm simplifies the calculation:</p>
<p><span id="eq-map-log"><span class="math display">\[\eta_i^* = \underset{\eta_i}{\mathrm{argmax}}~ \log(p(\eta_i|Y_{i})) = \underset{\eta_i}{\mathrm{argmax}}~ \log(p(\eta_i)) + \sum_{j=1}^{m} \log(p(Y_{ij}|\eta_i)) \tag{7}\]</span></span></p>
<p>In the end, we would have to use a numerical optimizer function to explore the parameter space of <span class="math inline">\(\eta_i\)</span> and locate the maximum of the posterior distribution (<span class="math inline">\(\eta_i^*\)</span>). To fully express the equation, we must define both the log prior <span class="math inline">\(\log(p(\eta_i))\)</span> and log likelihood <span class="math inline">\(\log(p(Y_{ij}|\eta_i))\)</span> terms. Let’s explore these in detail.</p>
<section id="sec-bayesth-map-prior" class="level3" data-number="5.3.1">
<h3 data-number="5.3.1" class="anchored" data-anchor-id="sec-bayesth-map-prior"><span class="header-section-number">5.3.1</span> Prior term</h3>
<p>The prior distribution <span class="math inline">\(p(\eta_i)\)</span> captures our inital beliefs and uncertainties regarding <span class="math inline">\(\eta_i\)</span> before observing the data. Bayesian methods allow to incorporate prior knowledge through various distributions and parameters (which is why Bayesians are sometimes being criticized of being too subjective). In pharmacometrics, a common approach is using a prior based on a previously estimated model, typically a normal distribution with mean 0 and variance <span class="math inline">\(\omega^2_{CL}\)</span> estimated from the NLME model. In contrast to other disciplines, the choice of our priors is generally less controversial, although there has been recent discussion regarding whether this one-approach-fits-all is always appropriate or if priors should be adjusted (e.g., flattened compared to the NLME estimate) in certain situations. See <span class="citation" data-cites="hughes2021">Hughes and Keizer (<a href="#ref-hughes2021" role="doc-biblioref">2021</a>)</span> for more information. The general “role” of the prior term is that strong deviations from the “typical” individual should only be considered when it allows us do substantially better explain the observed data. I like to see it as some kind of penalty function which prevents us from doing a potentially flawed curve fitting exercise. The probability density function (PDF) of a normal distribution can be used to calculate its contribution:</p>
<p><span id="eq-prior-1"><span class="math display">\[p(\eta_i) = \frac{1}{\sqrt{2\pi\omega^2}} \cdot \exp\left(-\frac{(\eta_i-\mu)^2}{2\omega^2}\right) \tag{8}\]</span></span></p>
<p>Since <span class="math inline">\(\mu\)</span> is typically 0, this simplifies to:</p>
<p><span id="eq-prior-2"><span class="math display">\[p(\eta_i) = \frac{1}{\sqrt{2\pi\omega^2}} \cdot \exp\left(-\frac{\eta_i^2}{2\omega^2}\right) \tag{9}\]</span></span></p>
<p>Taking the log yields:</p>
<p><span id="eq-prior-3"><span class="math display">\[\log(p(\eta_i)) = -0.5 \log(2\pi\omega^2) - \frac{\eta_i^2}{2\omega^2} \tag{10}\]</span></span></p>
<p>Now, we can compute the prior term for any given individual <span class="math inline">\(\eta_i\)</span>, using variance <span class="math inline">\(\omega^2_{CL}\)</span> (e.g., 0.11) from our NLME model. If we have a good reason to believe that our prior should be different (e.g., we apply our model to another population), we could adjust the variance accordingly (as described in <span class="citation" data-cites="hughes2021">Hughes and Keizer (<a href="#ref-hughes2021" role="doc-biblioref">2021</a>)</span>).</p>
</section>
<section id="sec-bayesth-map-likelihood" class="level3" data-number="5.3.2">
<h3 data-number="5.3.2" class="anchored" data-anchor-id="sec-bayesth-map-likelihood"><span class="header-section-number">5.3.2</span> Likelihood term</h3>
<p>The likelihood term <span class="math inline">\(p(Y_{ij}|\eta_i)\)</span> is the probability of observing the data point <span class="math inline">\(Y_{ij}\)</span> given the parameter <span class="math inline">\(\eta_i\)</span>. As we usually assume the residuals of our model predictions to be normally distributed, we again use the normal distribution PDF:</p>
<p><span id="eq-likelihood-1"><span class="math display">\[p(Y_{ij}|\eta_i) = \frac{1}{\sqrt{2\pi\sigma^2}} \cdot \exp\left(-\frac{(Y_{ij}-f(x_{ij}; \eta_i))^2}{2\sigma^2}\right) \tag{11}\]</span></span></p>
<p>where</p>
<ul>
<li><span class="math inline">\(Y_{ij}\)</span>: observed data point for individual <span class="math inline">\(i\)</span> at time <span class="math inline">\(j\)</span></li>
<li><span class="math inline">\(f(x_{ij}; \eta_i)\)</span>: model prediction for individual <span class="math inline">\(i\)</span> at time <span class="math inline">\(j\)</span>, given parameter <span class="math inline">\(\eta_i\)</span></li>
<li><span class="math inline">\(\sigma^2\)</span>: variance representing residual unexplained variability (RUV)</li>
</ul>
<p>Taking the log yields:</p>
<p><span id="eq-likelihood-2"><span class="math display">\[\log(p(Y_{ij}|\eta_i)) = -0.5 \log(2\pi\sigma^2) - \frac{(Y_{ij}-f(x_{ij}; \eta_i))^2}{2\sigma^2} \tag{12}\]</span></span></p>
<p>Please note that in our case (a combined additive and proportional RUV model), <span class="math inline">\(\sigma^2\)</span> represents the combined variances at time <span class="math inline">\(t_{ij}\)</span> and prediction <span class="math inline">\(f(x_{ij})\)</span>. As the structural solution of our model, <span class="math inline">\(f(x_{ij})\)</span>, is a constant for a given <span class="math inline">\(t_{ij}\)</span>, we can compute the combined variance as</p>
<p><span id="eq-sigma2"><span class="math display">\[\sigma^2 = \sigma^2_{prop} \cdot f(x_{ij})^2 + \sigma^2_{add} \tag{13}\]</span></span></p>
<p>Therefore, we later have to calculate the <span class="math inline">\(\sigma^2\)</span> for each data point <span class="math inline">\(Y_{ij}\)</span> individually.</p>
</section>
</section>
<section id="sec-bayesth-map-final" class="level2" data-number="5.4">
<h2 data-number="5.4" class="anchored" data-anchor-id="sec-bayesth-map-final"><span class="header-section-number">5.4</span> Combining both terms</h2>
<p>Writing out the log prior (<a href="#eq-prior-3" class="quarto-xref">Equation&nbsp;10</a>) and log likelihood (<a href="#eq-likelihood-2" class="quarto-xref">Equation&nbsp;12</a>) terms in our MAP estimation objective function (<a href="#eq-map-log" class="quarto-xref">Equation&nbsp;7</a>), we obtain:</p>
<p><span id="eq-map-final"><span class="math display">\[\eta_i^* = \underset{\eta_i}{\mathrm{argmax}}~\left(\left[-0.5 \log(2\pi\omega^2) - \frac{\eta_i^2}{2\omega^2}\right] ~ + \sum_{j=1}^m \left[-0.5 \log(2\pi\sigma^2) - \frac{(Y_{ij}-f(x_{ij}; \eta_i))^2}{2\sigma^2}\right]\right) \tag{14}\]</span></span></p>
<p>This final equation will guide our numerical optimizer (<code>optim</code> function in R) to determine the maximum, providing us with the individual MAP estimate. Let’s implement this method in R and reproduce our NONMEM reference solution!</p>
</section>
</section>
<section id="sec-rrepro" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> R-based MAP reproduction</h1>
<section id="sec-rrepro-prior" class="level2" data-number="6.1">
<h2 data-number="6.1" class="anchored" data-anchor-id="sec-rrepro-prior"><span class="header-section-number">6.1</span> Prior term</h2>
<p>We start by defining a function to calculate the prior term given by <a href="#eq-prior-3" class="quarto-xref">Equation&nbsp;10</a>. Here, we simply pass the individual <span class="math inline">\(\eta_i\)</span> and the model parameters (including <span class="math inline">\(\omega^2_{CL}\)</span>) as input arguments, and the function returns the log probability of the given <span class="math inline">\(\eta_i\)</span> under the prior distribution:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>function: prior_fun()</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># define prior term function</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>prior_fun <span class="ot">&lt;-</span> <span class="cf">function</span>(eta_i, mod_par){</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># retrieve omega2 from model parameters</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  omega2 <span class="ot">&lt;-</span> mod_par<span class="sc">$</span>omega2_CL</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calculate probability</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  log_prob <span class="ot">&lt;-</span> <span class="sc">-</span> <span class="fl">0.5</span> <span class="sc">*</span> <span class="fu">log</span>(<span class="dv">2</span><span class="sc">*</span>pi<span class="sc">*</span>omega2) <span class="sc">-</span> eta_i<span class="sc">^</span><span class="dv">2</span><span class="sc">/</span>(<span class="dv">2</span><span class="sc">*</span>omega2)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># return log probability</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(log_prob)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>We can test this function by illustrating the prior term across a range of <span class="math inline">\(\eta_i\)</span> values:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># define range</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>eta_i <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">2</span>, <span class="dv">2</span>, <span class="fl">0.01</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate prior term</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>prior <span class="ot">&lt;-</span> <span class="fu">prior_fun</span>(<span class="at">eta_i =</span> eta_i, <span class="at">mod_par =</span> mod_par)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="co"># create tibble</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>prior_tibble <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">eta_i =</span> eta_i,</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">p =</span> prior,</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">source =</span> <span class="st">"prior"</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="co"># plot prior term</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>prior_tibble <span class="sc">|&gt;</span> </span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>eta_i, <span class="at">y=</span><span class="fu">exp</span>(p)))<span class="sc">+</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"darkblue"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>)<span class="sc">+</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"darkblue"</span>, <span class="at">linewidth =</span> <span class="fl">0.6</span>)<span class="sc">+</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">expression</span>(eta[i]),</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Probability density"</span>,</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Prior term (random effect)"</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>  )<span class="sc">+</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-prior-term" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-prior-term-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="index_files/figure-html/fig-prior-term-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-prior-term-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6: Probability density of different random effects given a normal distribution centered around 0 with a variance of 0.11.
</figcaption>
</figure>
</div>
</div>
</div>
<p>The following plot shows how these <span class="math inline">\(\eta_i\)</span> values map onto the clearance domain:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot prior term</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>prior_tibble <span class="sc">|&gt;</span> </span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>mod_par<span class="sc">$</span>tvcl<span class="sc">*</span><span class="fu">exp</span>(eta_i), <span class="at">y=</span><span class="fu">exp</span>(p)))<span class="sc">+</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"darkblue"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>)<span class="sc">+</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> mod_par<span class="sc">$</span>tvcl, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"darkblue"</span>, <span class="at">linewidth =</span> <span class="fl">0.6</span>)<span class="sc">+</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">expression</span>(CL[i]),</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Probability density"</span>,</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Prior term (clearance)"</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  )<span class="sc">+</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-prior-term-cl" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-prior-term-cl-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="index_files/figure-html/fig-prior-term-cl-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-prior-term-cl-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7: Probability density of different clearance values.
</figcaption>
</figure>
</div>
</div>
</div>
<p>From the plots, we see that certain values of <span class="math inline">\(\eta_i\)</span> and <span class="math inline">\(CL_i\)</span> are more likely than others, based on our prior beliefs derived from the NLME model estimates, before observing any individual data. Let’s continue with the likelihood term:</p>
</section>
<section id="sec-rrepro-likelihood" class="level2" data-number="6.2">
<h2 data-number="6.2" class="anchored" data-anchor-id="sec-rrepro-likelihood"><span class="header-section-number">6.2</span> Likelihood term</h2>
<p>To calculate the log likelihood term described in <a href="#eq-likelihood-2" class="quarto-xref">Equation&nbsp;12</a>, we first have to define a model prediction function. Given our simple one-compartment model, we use a closed-form expression, though the principles apply equally to ODE-based models. More details on the model prediction function can be found in the previous blogpost, see <span class="citation" data-cites="klose2025">Klose (<a href="#ref-klose2025" role="doc-biblioref">2025</a>)</span>.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>function: model_fun()</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># define model function</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>model_fun <span class="ot">&lt;-</span> <span class="cf">function</span>(eta_i, dose, vd, theta_tvcl, t) {</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  exp_eta_i <span class="ot">&lt;-</span> <span class="fu">exp</span>(eta_i)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  exponent <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">*</span> (theta_tvcl <span class="sc">*</span> exp_eta_i <span class="sc">/</span> vd) <span class="sc">*</span> t</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> (dose <span class="sc">/</span> vd) <span class="sc">*</span> <span class="fu">exp</span>(exponent)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(result)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Next, we construct the likelihood function for individual observations. Please note that we have to calculate the <span class="math inline">\(\sigma^2\)</span> for each data point <span class="math inline">\(Y_{ij}\)</span> individually, as the variance contains an element proportional to the model prediction <span class="math inline">\(f_i\)</span> (see <a href="#eq-likelihood-2" class="quarto-xref">Equation&nbsp;12</a>). The following equation calculates the log likelihood for a single observation:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>function: log_likelihood_fun_single()</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># define likelihood function for a single observation</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>log_likelihood_fun_single <span class="ot">&lt;-</span> <span class="cf">function</span>(eta_i, dose, vd, theta_tvcl, t_ij, Y_ij, sigma2_add, sigma2_prop){</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get model predictions</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  f_ij <span class="ot">&lt;-</span> <span class="fu">model_fun</span>(eta_i, dose, vd, theta_tvcl, t_ij)</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calculate resulting sigma2 for each timepoint (prop variance is scaled based on f_i^2)</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>  sigma2 <span class="ot">&lt;-</span> sigma2_prop <span class="sc">*</span> f_ij<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> sigma2_add</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calculate probability</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>  log_lik <span class="ot">&lt;-</span> <span class="sc">-</span> <span class="fl">0.5</span> <span class="sc">*</span> <span class="fu">log</span>(<span class="dv">2</span><span class="sc">*</span>pi<span class="sc">*</span>sigma2) <span class="sc">-</span> (Y_ij <span class="sc">-</span> f_ij)<span class="sc">^</span><span class="dv">2</span><span class="sc">/</span>(<span class="dv">2</span><span class="sc">*</span>sigma2)</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># return log likelihood</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(log_lik)</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>To illustrate this, we calculate the likelihood for each observation, then sum these to obtain the total likelihood for a given <span class="math inline">\(\eta_i\)</span>. We demonstrate this using an example with <span class="math inline">\(\eta_i = 0\)</span>:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate lok lik per row</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>sim_data_id5 <span class="ot">&lt;-</span> sim_data_id5 <span class="sc">|&gt;</span> </span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">|&gt;</span> </span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">log_lik =</span> <span class="fu">case_when</span>(</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>      EVID <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="fu">log_likelihood_fun_single</span>(</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">eta_i =</span> <span class="dv">0</span>, </span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">dose =</span> mod_par<span class="sc">$</span>dose, </span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">vd =</span> mod_par<span class="sc">$</span>tvvd, </span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">theta_tvcl =</span> mod_par<span class="sc">$</span>tvcl, </span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">t_ij =</span> TIME, </span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">Y_ij =</span> DV, </span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">sigma2_add =</span> mod_par<span class="sc">$</span>sigma2_add, </span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">sigma2_prop =</span> mod_par<span class="sc">$</span>sigma2_prop</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>      EVID <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="cn">NA_real_</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> </span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">sum_log_lik =</span> <span class="fu">sum</span>(log_lik, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a><span class="co"># show sim_data_id5</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>sim_data_id5 <span class="sc">|&gt;</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>() <span class="sc">|&gt;</span> </span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">ID</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">TIME</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">EVID</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">AMT</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">RATE</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">DV</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">MDV</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">log_lik</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">sum_log_lik</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">5</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.00000</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">-17.93624</td>
</tr>
<tr class="even">
<td style="text-align: right;">5</td>
<td style="text-align: right;">0.01</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">31.61900</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">-4.031343</td>
<td style="text-align: right;">-17.93624</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5</td>
<td style="text-align: right;">3.00</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">19.66000</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">-3.844624</td>
<td style="text-align: right;">-17.93624</td>
</tr>
<tr class="even">
<td style="text-align: right;">5</td>
<td style="text-align: right;">6.00</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">12.00700</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">-3.718827</td>
<td style="text-align: right;">-17.93624</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5</td>
<td style="text-align: right;">12.00</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">4.33360</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">-3.514076</td>
<td style="text-align: right;">-17.93624</td>
</tr>
<tr class="even">
<td style="text-align: right;">5</td>
<td style="text-align: right;">24.00</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.78148</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">-2.827369</td>
<td style="text-align: right;">-17.93624</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>We observe individual likelihood contributions and their sum. To streamline this process, we define a function that computes the summed likelihood across multiple observations:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>function: log_likelihood_fun_multiple()</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># define likelihood function for a set of observations</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>log_likelihood_fun_multiple <span class="ot">&lt;-</span> <span class="cf">function</span>(df, eta_i, mod_par){</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># retrieve information from mod_par</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  dose <span class="ot">&lt;-</span> mod_par<span class="sc">$</span>dose</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  vd <span class="ot">&lt;-</span> mod_par<span class="sc">$</span>tvvd</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  theta_tvcl <span class="ot">&lt;-</span> mod_par<span class="sc">$</span>tvcl</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  sigma2_add <span class="ot">&lt;-</span> mod_par<span class="sc">$</span>sigma2_add</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>  sigma2_prop <span class="ot">&lt;-</span> mod_par<span class="sc">$</span>sigma2_prop</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calculate log lik per row</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>  log_lik_sum <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rowwise</span>() <span class="sc">|&gt;</span> </span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">log_lik =</span> <span class="fu">case_when</span>(</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>        EVID <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="fu">log_likelihood_fun_single</span>(</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>          <span class="at">eta_i =</span> eta_i, </span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>          <span class="at">dose =</span> dose, </span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>          <span class="at">vd =</span> vd, </span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>          <span class="at">theta_tvcl =</span> theta_tvcl, </span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>          <span class="at">t_ij =</span> TIME, </span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>          <span class="at">Y_ij =</span> DV, </span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>          <span class="at">sigma2_add =</span> sigma2_add, </span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>          <span class="at">sigma2_prop =</span> sigma2_prop</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>        EVID <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="cn">NA_real_</span></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> </span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(log_lik) <span class="sc">|&gt;</span></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(<span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># return log likelihood sum</span></span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(log_lik_sum)</span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Testing this function quickly confirms consistency of the obtained summed up likelihood with the previous result from the table (see above):</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate likelihood</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">log_likelihood_fun_multiple</span>(</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">df =</span> sim_data_id5,</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">eta_i =</span> <span class="dv">0</span>,</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">mod_par =</span> mod_par</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -17.93624</code></pre>
</div>
</div>
<p>Now, we can visualize the likelihood term across a range of <span class="math inline">\(\eta_i\)</span> values, similar to what we have did for the prior term:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># define range</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>eta_i <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">2</span>, <span class="dv">2</span>, <span class="fl">0.01</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co"># empty list</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>ll_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="co"># loop over each element of eta_i</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(cur_eta_i <span class="cf">in</span> eta_i){</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calculate likelihood term</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  ll_list[[<span class="fu">as.character</span>(cur_eta_i)]] <span class="ot">&lt;-</span> <span class="fu">log_likelihood_fun_multiple</span>(</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">df =</span> sim_data_id5,</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">eta_i =</span> cur_eta_i,</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">mod_par =</span> mod_par</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a><span class="co"># convert to vector</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>ll_vector <span class="ot">&lt;-</span> ll_list <span class="sc">|&gt;</span> <span class="fu">unlist</span>() <span class="sc">|&gt;</span> <span class="fu">unname</span>()</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a><span class="co"># create tibble</span></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>likelihood_tibble <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">eta_i =</span> eta_i,</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">p =</span> ll_vector,</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">source =</span> <span class="st">"likelihood"</span></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a><span class="co"># plot likelihood term</span></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>likelihood_tibble <span class="sc">|&gt;</span> </span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>eta_i, <span class="at">y=</span><span class="fu">exp</span>(p)))<span class="sc">+</span></span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"darkred"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>)<span class="sc">+</span></span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> eta_i[<span class="fu">which.max</span>(ll_vector)], <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"darkred"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>)<span class="sc">+</span></span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">expression</span>(eta[i]),</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Likelihood"</span>,</span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Likelihood term"</span></span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>  )<span class="sc">+</span></span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-likelihood-term" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-likelihood-term-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="index_files/figure-html/fig-likelihood-term-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-likelihood-term-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8: Likelihood of different random effects given the observed datapoints of our exemplary individual.
</figcaption>
</figure>
</div>
</div>
</div>
<p>The likelihood plot clearly indicates which <span class="math inline">\(\eta_i\)</span> values best describe the observed data. Identifying the maximum likelihood <span class="math inline">\(\eta_i\)</span> is straightforward:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get eta_i with highest likelihood</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>eta_i_max_likelihood <span class="ot">&lt;-</span> eta_i[<span class="fu">which.max</span>(ll_vector)]</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co"># show</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>eta_i_max_likelihood</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.94</code></pre>
</div>
</div>
<p>The optimal <span class="math inline">\(\eta_i\)</span> value according to the likelihood term (and ignoring any prior information) is 0.94. Please note: As the likelihood is the product of many probabilities, each between 0 and 1, we typically deal with extremely small numerical values. Therefore, it is common practice to use logarithmic transformations for numerical stability. Next, we combine the prior and likelihood terms to perform MAP estimation.</p>
</section>
<section id="map-rrepro-mapestim" class="level2" data-number="6.3">
<h2 data-number="6.3" class="anchored" data-anchor-id="map-rrepro-mapestim"><span class="header-section-number">6.3</span> MAP estimation (posterior)</h2>
<p>We now have to define an objective function for numerical optimization, combining prior and likelihood terms to estimate the posterior (as shown in <a href="#eq-map-final" class="quarto-xref">Equation&nbsp;14</a>).</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>function: map_obj_fun()</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># define MAP estimation objective function</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>map_obj_fun <span class="ot">&lt;-</span> <span class="cf">function</span>(eta_i, df, mod_par){</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calculate log prior term</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  log_prior <span class="ot">&lt;-</span> <span class="fu">prior_fun</span>(</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">eta_i =</span> eta_i, </span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">mod_par =</span> mod_par</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calculate log likelihood term</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>  log_likelihood <span class="ot">&lt;-</span> <span class="fu">log_likelihood_fun_multiple</span>(</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">df =</span> df,</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">eta_i =</span> eta_i,</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">mod_par =</span> mod_par</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># combine both</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>  log_posterior <span class="ot">&lt;-</span> log_prior <span class="sc">+</span> log_likelihood</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># return negative log posterior</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="sc">-</span>log_posterior)</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Please note that we are returning the negative log posterior as it is easier to minimize a function than to maximize it. Using R’s <code>optim</code> function, we estimate the MAP numerically. Here is the output form the <code>optim</code> call:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># run optimization</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>map_est <span class="ot">&lt;-</span> <span class="fu">optim</span>(</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">par =</span> <span class="dv">0</span>, </span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">fn =</span> map_obj_fun, </span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">df =</span> sim_data_id5,</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">mod_par =</span> mod_par,</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"BFGS"</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="co"># show estimation results</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>map_est </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>$par
[1] 0.5519271

$value
[1] 16.08691

$counts
function gradient 
      13        7 

$convergence
[1] 0

$message
NULL</code></pre>
</div>
</div>
<p>The resulting MAP estimate for <span class="math inline">\(\eta_i\)</span> is 0.5519271, closely matching the reference solution (0.55194) with an acceptable difference (-0.0000128887). Similarly to the other terms, we can visualize the posterior term across a range of <span class="math inline">\(\eta_i\)</span> values:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># define range</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>eta_i <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">2</span>, <span class="dv">2</span>, <span class="fl">0.01</span>)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="co"># empty list</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>post_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="co"># loop over each element of eta_i</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(cur_eta_i <span class="cf">in</span> eta_i){</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calculate likelihood term</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>  post_list[[<span class="fu">as.character</span>(cur_eta_i)]] <span class="ot">&lt;-</span> <span class="fu">map_obj_fun</span>(</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">eta_i =</span> cur_eta_i,</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">df =</span> sim_data_id5,</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">mod_par =</span> mod_par</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a><span class="co"># convert to vector</span></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>post_vector <span class="ot">&lt;-</span> post_list <span class="sc">|&gt;</span> <span class="fu">unlist</span>() <span class="sc">|&gt;</span> <span class="fu">unname</span>()</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a><span class="co"># create tibble</span></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>posterior_tibble <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">eta_i =</span> eta_i,</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">p =</span> <span class="sc">-</span>post_vector,</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">source =</span> <span class="st">"posterior"</span></span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a><span class="co"># plot likelihood term</span></span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>posterior_tibble <span class="sc">|&gt;</span> </span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>eta_i, <span class="at">y=</span><span class="fu">exp</span>(p)))<span class="sc">+</span></span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"darkgreen"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>)<span class="sc">+</span></span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> map_est<span class="sc">$</span>par, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"darkgreen"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>)<span class="sc">+</span></span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">expression</span>(eta[i]),</span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Unnormalized posterior density"</span>,</span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Posterior distribution"</span></span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a>  )<span class="sc">+</span></span>
<span id="cb27-37"><a href="#cb27-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-posterior-term" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-posterior-term-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="index_files/figure-html/fig-posterior-term-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-posterior-term-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;9: The unnormalized posterior density.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="sec-map-rrepro-comp" class="level2" data-number="6.4">
<h2 data-number="6.4" class="anchored" data-anchor-id="sec-map-rrepro-comp"><span class="header-section-number">6.4</span> Comparison of prior, likelihood, and posterior</h2>
<p>Finally, we compare the MAP estimate (mode of the posterior) with prior and likelihood terms visually:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># combine likelihood and prior</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>comp_tibble <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  prior_tibble,</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  likelihood_tibble,</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  posterior_tibble</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">source =</span> <span class="fu">factor</span>(source, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"prior"</span>, <span class="st">"posterior"</span>, <span class="st">"likelihood"</span>)))</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="co"># define linewidth</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>linewidth <span class="ot">&lt;-</span> <span class="fl">0.8</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a><span class="co"># plot both distributions with different colors and fill</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>comp_tibble <span class="sc">|&gt;</span>  </span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>eta_i, <span class="at">y=</span><span class="fu">exp</span>(p), <span class="at">fill =</span> source, <span class="at">color =</span> source))<span class="sc">+</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">2</span>,<span class="sc">-</span><span class="dv">1</span>,<span class="dv">0</span>, <span class="fu">signif</span>(map_est<span class="sc">$</span>par,<span class="dv">2</span>), <span class="fu">signif</span>(eta_i_max_likelihood,<span class="dv">2</span>), <span class="dv">2</span>))<span class="sc">+</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> linewidth)<span class="sc">+</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">data.frame</span>(<span class="at">source =</span> <span class="fu">factor</span>(<span class="st">"prior"</span>, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"prior"</span>, <span class="st">"posterior"</span>, <span class="st">"likelihood"</span>))),</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">xintercept =</span> <span class="dv">0</span>),</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"darkblue"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">linewidth =</span> linewidth</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">data.frame</span>(<span class="at">source =</span> <span class="fu">factor</span>(<span class="st">"posterior"</span>, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"prior"</span>, <span class="st">"posterior"</span>, <span class="st">"likelihood"</span>))),</span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">xintercept =</span> map_est<span class="sc">$</span>par),</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"darkgreen"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">linewidth =</span> linewidth</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(</span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">data.frame</span>(<span class="at">source =</span> <span class="fu">factor</span>(<span class="st">"likelihood"</span>, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"prior"</span>, <span class="st">"posterior"</span>, <span class="st">"likelihood"</span>))),</span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">xintercept =</span> eta_i_max_likelihood),</span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"darkred"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">linewidth =</span> linewidth</span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="at">prior =</span> <span class="st">"darkblue"</span>, </span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>                                <span class="at">posterior =</span> <span class="st">"darkgreen"</span>, </span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>                                <span class="at">likelihood =</span> <span class="st">"darkred"</span>)) <span class="sc">+</span></span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>source, <span class="at">scales =</span> <span class="st">"free"</span>, <span class="at">ncol =</span> <span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">expression</span>(eta[i]),</span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"(Unnormalized) probability density"</span>,</span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Comparison of prior, likelihood, and posterior"</span>,</span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Source"</span></span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-comparison-prior-ll-post-term" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-comparison-prior-ll-post-term-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="index_files/figure-html/fig-comparison-prior-ll-post-term-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-comparison-prior-ll-post-term-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;10: Comparison of prior, likelihood, and posterior.
</figcaption>
</figure>
</div>
</div>
</div>
<p>This clearly demonstrates how the posterior is influenced by both the prior and the likelihood, with the MAP estimate (mode of the posterior, green dashed line) reflecting a balance between these two sources of information.</p>
</section>
</section>
<section id="map-rrepro-conclusion" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> Conclusion</h1>
<p>This simple example illustrates how to estimate the individual parameter <span class="math inline">\(\eta_i\)</span> (which translates to an individual clearance <span class="math inline">\(CL_i\)</span>) for a single subject using a Bayesian approach. We have seen that the posterior distribution, often summarized by its mode (the MAP or EBE estimate), represents a compromise between the prior and the likelihood. This powerful technique enables the continuous integration of prior knowledge with new data and is very useful for many pharmacometric workflows. With that, I conclude this blog post and hope you enjoyed it. If you have any questions or feedback, please feel free to leave a comment.</p>


<!-- -->


</section>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-hughes2021" class="csl-entry" role="listitem">
Hughes, Jasmine H., and Ron J. Keizer. 2021. <span>“A Hybrid Machine Learning/Pharmacokinetic Approach Outperforms Maximum a Posteriori <span>Bayesian</span> Estimation by Selectively Flattening Model Priors.”</span> <em>CPT: Pharmacometrics &amp; Systems Pharmacology</em> 10 (10): 1150–60. <a href="https://doi.org/10.1002/psp4.12684">https://doi.org/10.1002/psp4.12684</a>.
</div>
<div id="ref-johnstonBayesianEstimationNONMEM2024" class="csl-entry" role="listitem">
Johnston, Curtis K., Timothy Waterhouse, Matthew Wiens, John Mondick, Jonathan French, and William R. Gillespie. 2024. <span>“Bayesian Estimation in <span>NONMEM</span>.”</span> <em>CPT: Pharmacometrics &amp; Systems Pharmacology</em> 13 (2): 192–207. <a href="https://doi.org/10.1002/psp4.13088">https://doi.org/10.1002/psp4.13088</a>.
</div>
<div id="ref-klose2025" class="csl-entry" role="listitem">
Klose, Marian. 2025. <span>“My Attempt to Understand the <span>NLME</span> Estimation Algorithm Behind <span>NONMEM</span>.”</span> https://marian-klose.com/posts/understanding_nlme_estimation/index.html.
</div>
<div id="ref-margossianFlexibleEfficientBayesian2022" class="csl-entry" role="listitem">
Margossian, Charles C., Yi Zhang, and William R. Gillespie. 2022. <span>“Flexible and Efficient <span>Bayesian</span> Pharmacometrics Modeling Using <span>Stan</span> and <span>Torsten</span>, <span>Part I</span>.”</span> <em>CPT: Pharmacometrics &amp; Systems Pharmacology</em> 11 (9): 1151–69. <a href="https://doi.org/10.1002/psp4.12812">https://doi.org/10.1002/psp4.12812</a>.
</div>
<div id="ref-navarro2023" class="csl-entry" role="listitem">
Navarro, Danielle. 2023. <span>“Building a Population Pharmacokinetic Model with <span>Stan</span>.”</span> https://blog.djnavarro.net/posts/2023-06-10_pop-pk-models/.
</div>
<div id="ref-sheiner1972" class="csl-entry" role="listitem">
Sheiner, Lewis B., Barr Rosenberg, and Kenneth L. Melmon. 1972. <span>“Modelling of Individual Pharmacokinetics for Computer-Aided Drug Dosage.”</span> <em>Computers and Biomedical Research</em> 5 (5): 441–59. <a href="https://doi.org/10.1016/0010-4809(72)90051-1">https://doi.org/10.1016/0010-4809(72)90051-1</a>.
</div>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p><em>MAP</em> estimates are also known as <em>Empirical Bayes Estimates</em> (EBE).<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>Depending on the estimation algorithm.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>The dense sampling in combination with a simple additive error model for RUV led to a scenario where the posterior was nearly equal to the likelihood. Therefore, I have increased the additive error and introduced a proportional term as well. This places the posterior in the middle and I can recycle the old dataset I have simulated before.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>Actually, this took me quite some time to figure out. I was using the model from the previous blogpost, which only had an additive error and was missing the <code>INTERACTION</code> option (which doesn’t matter if you are just using a constant additive error). With the newly introduced proportional error, I then had a mismatch between my calculations and the reference and I couldn’t figure out why. The missing <code>INTERACTION</code> was the solution, as with the introduction of the proportional error the RUV does not remain constant (which NONMEM is assuming when <code>INTERACTION</code> is missing). Lesson learned!<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{klose2025,
  author = {Klose, Marian},
  title = {Reproducing {NONMEM’s} {MAP} Estimation in {R}},
  date = {2025-03-31},
  url = {https://marian-klose.com/posts/bayes_map_estimation_in_r/index.html},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-klose2025" class="csl-entry quarto-appendix-citeas" role="listitem">
Klose, Marian. 2025. <span>“Reproducing NONMEM’s MAP Estimation in
R.”</span> March 31, 2025. <a href="https://marian-klose.com/posts/bayes_map_estimation_in_r/index.html">https://marian-klose.com/posts/bayes_map_estimation_in_r/index.html</a>.
</div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://giscus.app/client.js" data-repo="marianklose/personal-website" data-repo-id="R_kgDOLLh1WA" data-category="Comments" data-category-id="DIC_kwDOLLh1WM4CjMUX" data-mapping="pathname" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script>
<input type="hidden" id="giscus-base-theme" value="light">
<input type="hidden" id="giscus-alt-theme" value="dark"><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb29" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Reproducing NONMEM's MAP estimation in R"</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="an">description:</span><span class="co"> "How to perform Bayesian MAP estimation yourself using R and why you should care. "</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="co">  - name: Marian Klose</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="co">    url: https://github.com/marianklose</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="co">    orcid: 0009-0005-1706-6289</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> 03-31-2025  # MM-DD-YYYY</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="an">categories:</span><span class="co"> [NONMEM, Bayes, MAP, EBE, Estimation] </span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="an">image:</span><span class="co"> preview.gif</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a><span class="an">draft:</span><span class="co"> false </span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a><span class="an">echo:</span><span class="co"> true</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a><span class="co">  freeze: true # never re-render during project render (dependencies might change over time)</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a><span class="co">  echo: true</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a><span class="co">  message: false</span></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a><span class="co">  warning: false</span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a><span class="an">citation:</span><span class="co"> </span></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a><span class="co">  url: https://marian-klose.com/posts/bayes_map_estimation_in_r/index.html</span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a><span class="co">    number-sections: true</span></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: true</span></span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a><span class="co"># load packages</span></span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr) </span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(xpose4)</span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-42"><a href="#cb29-42" aria-hidden="true" tabindex="-1"></a><span class="fu"># Motivation {#sec-motivation}</span></span>
<span id="cb29-43"><a href="#cb29-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-44"><a href="#cb29-44" aria-hidden="true" tabindex="-1"></a>Bayesian estimation is a widely-used method in pharmacometrics. Many pharmacometricians utilize individual predictions (<span class="in">`IPRED`</span>) in their diagnostics, which represent simulations based on the *maximum a-posteriori* (MAP) estimates [^1]. These estimates essentially represent the mode of the so-called *posterior* distribution, which combines prior knowledge about the population and new evidence about the particular individual at hand (more to that later). `MAP` estimates also play a crucial role in *Model-Informed Precision Dosing* (MIPD), where one aims to predict the concentration-time profile of an individual, given a pharmacokinetic NLME model and a set of drug concentrations measured through a *Therapeutic Drug Monitoring* (TDM) program. During model building, the underlying individualized <span class="in">`ETAs`</span> are often used for covariate screening, provided that shrinkage permits it. As you can see, Bayesian estimation is quite prominent in pharmacometric workflows. Thomas Bayes would be proud of us!</span>
<span id="cb29-45"><a href="#cb29-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-46"><a href="#cb29-46" aria-hidden="true" tabindex="-1"></a><span class="al">![Portrait of Thomas Bayes.](media/Thomas_Bayes.gif)</span>{width=40% #fig-thomas-bayes}  </span>
<span id="cb29-47"><a href="#cb29-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-48"><a href="#cb29-48" aria-hidden="true" tabindex="-1"></a>In many scenarios, these Bayesian calculations happen automatically *under the hood* when fitting pharmacometric models (e.g., in NONMEM), making it quite easy to use Bayesian estimates without exploring the underlying concepts and calculations. I myself did this for quite some time. Reproducing  calculations through equations is often the best way to grasp the underlying principles. Therefore, I have decided to write this blogpost, in which I want to explain the Bayesian idea and reproduce a simple Bayesian MAP estimation in R. I will mainly focus on the point estimates of the posterior distribution (`MAP` or `EBE`). Addressing the full *posterior* distribution is also important and might be covered in a future post. There are other nice blogposts which cover full Bayesian approaches in more detail, such as @navarro2023.</span>
<span id="cb29-49"><a href="#cb29-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-50"><a href="#cb29-50" aria-hidden="true" tabindex="-1"></a>Please note: These are just my personal reflections and interpretations of Bayesian concepts. I cannot guarantee that my explanations, equations, or terminology are flawless. If you notice any inaccuracies, please let me know so I can correct them! </span>
<span id="cb29-51"><a href="#cb29-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-52"><a href="#cb29-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-53"><a href="#cb29-53" aria-hidden="true" tabindex="-1"></a><span class="fu"># Structure {#sec-structure}</span></span>
<span id="cb29-54"><a href="#cb29-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-55"><a href="#cb29-55" aria-hidden="true" tabindex="-1"></a>Let me briefly outline how I structured this blogpost. The overall goal is to better understand the Bayesian concept behind MAP estimation and to derive an individualized clearance estimate for a virtual patient using R, step by step.</span>
<span id="cb29-56"><a href="#cb29-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-57"><a href="#cb29-57" aria-hidden="true" tabindex="-1"></a>I start with my own little introduction of the Bayesian idea (@sec-bayesian-idea) using a real-world example and define the key components—prior, likelihood, and posterior. </span>
<span id="cb29-58"><a href="#cb29-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-59"><a href="#cb29-59" aria-hidden="true" tabindex="-1"></a>This is then followed by a pharmacometric example using a simulated dataset (from my previous blogpost) and a simple one-compartment i.v. bolus PK model as reference (@sec-pharmex). This section also includes our NONMEM reference solution which is later used to validate our calculations in R.</span>
<span id="cb29-60"><a href="#cb29-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-61"><a href="#cb29-61" aria-hidden="true" tabindex="-1"></a>Next, we try to explore the Bayesian theory a bit more, dealing with the mathematical formulation of MAP estimation and explaining how the prior and likelihood combine to form the posterior (@sec-bayesth).</span>
<span id="cb29-62"><a href="#cb29-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-63"><a href="#cb29-63" aria-hidden="true" tabindex="-1"></a>Afterwards, we move on to the R-based MAP reproduction (@sec-rrepro). We implement the prior and likelihood functions, combine them into an optimization routine, and estimate the individual parameter from scratch. Finally, we are able to compare the R-based result to the NONMEM output and visualize how prior, likelihood, and posterior interact.</span>
<span id="cb29-64"><a href="#cb29-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-65"><a href="#cb29-65" aria-hidden="true" tabindex="-1"></a>With that being said, let's get started!</span>
<span id="cb29-66"><a href="#cb29-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-67"><a href="#cb29-67" aria-hidden="true" tabindex="-1"></a><span class="fu"># The Bayesian Idea: Updating Beliefs {#sec-bayesian-idea}</span></span>
<span id="cb29-68"><a href="#cb29-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-69"><a href="#cb29-69" aria-hidden="true" tabindex="-1"></a><span class="fu">## Starting with an example {#sec-bayesian-idea-example}</span></span>
<span id="cb29-70"><a href="#cb29-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-71"><a href="#cb29-71" aria-hidden="true" tabindex="-1"></a>I would say that many of us naturally think Bayesian, even if we are not aware of it or if we don't label it that way. At its core, Bayesian statistics is about updating your beliefs once new data or information becomes available. Let’s consider an example from the real-world to illustrate this idea.</span>
<span id="cb29-72"><a href="#cb29-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-73"><a href="#cb29-73" aria-hidden="true" tabindex="-1"></a>Imagine you drive to work every day. If someone would ask you "How long will it take you to get to work tomorrow?", you would probably have a good idea, simply based on your past experiences. 30 minutes might be your best guess, but would you bet money that it will be exactly 30 minutes? Probably not, as you will always have some uncertainty associated with it. Perhaps something between 20 and 40 minutes would be reasonable based on your previous trips. Now, let's assume you get into your car the next morning and after 25 minutes, you have made it halfway.</span>
<span id="cb29-74"><a href="#cb29-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-75"><a href="#cb29-75" aria-hidden="true" tabindex="-1"></a><span class="al">![A traffic jam on your way to work. Credits: Aayush Srivastava, Pexels.](media/pexels-aayushsri-1445653.jpg)</span>{width=80% #fig-traffic-jam}</span>
<span id="cb29-76"><a href="#cb29-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-77"><a href="#cb29-77" aria-hidden="true" tabindex="-1"></a>Would you stick to your initial belief that it will take you 30 minutes? Probably not, you would likely revise it (or try to break all speed limits). But would you simply double the 25 minutes to predict a 50-minute commute? This is also unlikely, given your experience suggesting that 40 minutes is usually the upper limit. So, maybe you would adjust your estimate to 38 minutes, assuming that the traffic will get better soon. This is Bayesian thinking in action: Updating your beliefs with new data. But so far without any equation and rather based on gut-feeling.</span>
<span id="cb29-78"><a href="#cb29-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-79"><a href="#cb29-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-80"><a href="#cb29-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-81"><a href="#cb29-81" aria-hidden="true" tabindex="-1"></a><span class="fu">## Terminology {#sec-bayesian-idea-terminology}</span></span>
<span id="cb29-82"><a href="#cb29-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-83"><a href="#cb29-83" aria-hidden="true" tabindex="-1"></a>Now, let’s map this real-world scenario to some Bayesian terminology. There are three key components in every Bayesian analysis:</span>
<span id="cb29-84"><a href="#cb29-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-85"><a href="#cb29-85" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Prior:** Your initial belief - 30 minutes, plus some uncertainty.</span>
<span id="cb29-86"><a href="#cb29-86" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Likelihood:** The new data - taking 25 min to cover half the distance and suggesting 50 min for the full trip.</span>
<span id="cb29-87"><a href="#cb29-87" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Posterior:** Your updated estimate - now around 38 minutes, combining prior and likelihood.</span>
<span id="cb29-88"><a href="#cb29-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-89"><a href="#cb29-89" aria-hidden="true" tabindex="-1"></a>Bayesian analysis starts with a prior, which you revise using new data (likelihood) to obtain the posterior. In pharmacometrics, we often encounter two levels of complexity when it comes to Bayes:</span>
<span id="cb29-90"><a href="#cb29-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-91"><a href="#cb29-91" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**MAP / EBE:** Simply focuses on the mode of the posterior distribution and ignores its uncertainty.</span>
<span id="cb29-92"><a href="#cb29-92" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Full Bayesian:** Considers the entire posterior distribution, not just the mode or a point estimate.</span>
<span id="cb29-93"><a href="#cb29-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-94"><a href="#cb29-94" aria-hidden="true" tabindex="-1"></a>Many pharmacometricians use MAP estimates due to their computational simplicity and their direct integration into standard NLME routines, while full Bayesian methods offer a more comprehensive view by integrating uncertainty even after new data became available. Full Bayesian methods are more and more used in the field, also thanks to some nice tutorials by @margossianFlexibleEfficientBayesian2022 for Stan/Torsten and by @johnstonBayesianEstimationNONMEM2024 for NONMEM itself, both from the Metrum Research Group.</span>
<span id="cb29-95"><a href="#cb29-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-96"><a href="#cb29-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-97"><a href="#cb29-97" aria-hidden="true" tabindex="-1"></a><span class="fu">## Our goal in pharmacometrics {#sec-bayesian-idea-goal}</span></span>
<span id="cb29-98"><a href="#cb29-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-99"><a href="#cb29-99" aria-hidden="true" tabindex="-1"></a>So, what role does Bayesian methodology play in pharmacometrics? Obviously it is not about optimizing your commute.  Instead, we typically use Bayesian estimation to individualize the model parameters for a given individual $i$, which has a set of unique observations $Y_{i}$. This concept was first introduced to the pharmacometric community by @sheiner1972, if I am not mistaken. On the one hand, <span class="in">`MAP`</span> estimation happens during model building, at each iteration step <span class="ot">[^2]</span> and then after the actual estimation has finished, at the <span class="in">`POSTHOC`</span> step. On the other hand, it is also used in MIPD settings as described above. The approach remains the same, and we will later have a look at a simple pharmacokinetic example to illustrate this.</span>
<span id="cb29-100"><a href="#cb29-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-101"><a href="#cb29-101" aria-hidden="true" tabindex="-1"></a>So far we used a relatable example rather focusing on the intuition behind Bayesian thinking. Now we want to dive a bit into the mathematics behind it to be able to formally reproduce a simple Bayesian MAP estimation in R.</span>
<span id="cb29-102"><a href="#cb29-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-103"><a href="#cb29-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-104"><a href="#cb29-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-105"><a href="#cb29-105" aria-hidden="true" tabindex="-1"></a><span class="fu"># Pharmacometric example and reference solution {#sec-pharmex}</span></span>
<span id="cb29-106"><a href="#cb29-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-107"><a href="#cb29-107" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data and visualization {#sec-pharmex-data}</span></span>
<span id="cb29-108"><a href="#cb29-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-109"><a href="#cb29-109" aria-hidden="true" tabindex="-1"></a>Without data, no Bayesian parameter individualization. For our MAP estimation, we are using the same simulated data set I have defined in the previous blogpost about NLME modelling. See @klose2025 for more details about this data set. Let's start by loading the simulated concentration-time data and showing the head of the data set:</span>
<span id="cb29-110"><a href="#cb29-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-113"><a href="#cb29-113" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb29-114"><a href="#cb29-114" aria-hidden="true" tabindex="-1"></a><span class="co"># read in simulated dataset from previous blogpost</span></span>
<span id="cb29-115"><a href="#cb29-115" aria-hidden="true" tabindex="-1"></a>sim_data <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"./data/sim_data.csv"</span>)</span>
<span id="cb29-116"><a href="#cb29-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-117"><a href="#cb29-117" aria-hidden="true" tabindex="-1"></a><span class="co"># show data </span></span>
<span id="cb29-118"><a href="#cb29-118" aria-hidden="true" tabindex="-1"></a>sim_data <span class="sc">|&gt;</span>  </span>
<span id="cb29-119"><a href="#cb29-119" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>() <span class="sc">|&gt;</span> </span>
<span id="cb29-120"><a href="#cb29-120" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>() <span class="sc">|&gt;</span> </span>
<span id="cb29-121"><a href="#cb29-121" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span>
<span id="cb29-122"><a href="#cb29-122" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-123"><a href="#cb29-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-124"><a href="#cb29-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-125"><a href="#cb29-125" aria-hidden="true" tabindex="-1"></a>We will focus on ID 5, which has lower simulated concentrations than the average individual, making it easier to observe differences between typical and individualized profiles. Here's a plot to visualize these concentration-time profiles of ID 5 and the other IDs of the virtual population:</span>
<span id="cb29-126"><a href="#cb29-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-129"><a href="#cb29-129" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb29-130"><a href="#cb29-130" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-sim-vis</span></span>
<span id="cb29-131"><a href="#cb29-131" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Simulated concentration-time profiles for 10 individuals after i.v. bolus injection. ID 5 (blue) represents our exemplary ID."</span></span>
<span id="cb29-132"><a href="#cb29-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-133"><a href="#cb29-133" aria-hidden="true" tabindex="-1"></a><span class="co"># show individual profiles</span></span>
<span id="cb29-134"><a href="#cb29-134" aria-hidden="true" tabindex="-1"></a>sim_data <span class="sc">|&gt;</span> </span>
<span id="cb29-135"><a href="#cb29-135" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(EVID <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">|&gt;</span> </span>
<span id="cb29-136"><a href="#cb29-136" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">flag =</span> <span class="fu">if_else</span>(ID <span class="sc">==</span> <span class="dv">5</span>, <span class="st">"Reference"</span>, <span class="st">"Others"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb29-137"><a href="#cb29-137" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>TIME, <span class="at">y=</span>DV, <span class="at">group=</span>ID, <span class="at">color=</span><span class="fu">as.factor</span>(flag))) <span class="sc">+</span></span>
<span id="cb29-138"><a href="#cb29-138" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>()<span class="sc">+</span></span>
<span id="cb29-139"><a href="#cb29-139" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()<span class="sc">+</span></span>
<span id="cb29-140"><a href="#cb29-140" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb29-141"><a href="#cb29-141" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="cn">NA</span>))<span class="sc">+</span></span>
<span id="cb29-142"><a href="#cb29-142" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x=</span><span class="st">"Time after last dose [h]"</span>, <span class="at">y=</span><span class="st">"Concentration [mg/L]"</span>)<span class="sc">+</span></span>
<span id="cb29-143"><a href="#cb29-143" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="st">"Individual"</span>, <span class="at">values=</span><span class="fu">c</span>(<span class="st">"grey"</span>, <span class="st">"darkblue"</span>))<span class="sc">+</span></span>
<span id="cb29-144"><a href="#cb29-144" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Simulated concentration time data after i.v. bolus injection"</span>)</span>
<span id="cb29-145"><a href="#cb29-145" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-146"><a href="#cb29-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-147"><a href="#cb29-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-148"><a href="#cb29-148" aria-hidden="true" tabindex="-1"></a>We will later need this data set when running the NONMEM-based MAP estimation, so we have to save it to file. Prior to that, we will filter the data set to only include the data for ID 5:</span>
<span id="cb29-149"><a href="#cb29-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-152"><a href="#cb29-152" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb29-153"><a href="#cb29-153" aria-hidden="true" tabindex="-1"></a><span class="co"># define sim_data with ID == 5</span></span>
<span id="cb29-154"><a href="#cb29-154" aria-hidden="true" tabindex="-1"></a>sim_data_id5 <span class="ot">&lt;-</span> sim_data <span class="sc">|&gt;</span> </span>
<span id="cb29-155"><a href="#cb29-155" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(ID <span class="sc">==</span> <span class="dv">5</span>)</span>
<span id="cb29-156"><a href="#cb29-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-157"><a href="#cb29-157" aria-hidden="true" tabindex="-1"></a><span class="co"># save data for NONMEM</span></span>
<span id="cb29-158"><a href="#cb29-158" aria-hidden="true" tabindex="-1"></a>sim_data_id5 <span class="sc">|&gt;</span> </span>
<span id="cb29-159"><a href="#cb29-159" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_csv</span>(<span class="st">"./data/sim_data_ID5.csv"</span>) </span>
<span id="cb29-160"><a href="#cb29-160" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-161"><a href="#cb29-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-162"><a href="#cb29-162" aria-hidden="true" tabindex="-1"></a>With that being done, we are all set to define the NLME model in NONMEM in a next step!</span>
<span id="cb29-163"><a href="#cb29-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-164"><a href="#cb29-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-165"><a href="#cb29-165" aria-hidden="true" tabindex="-1"></a><span class="fu">## NLME model structure {#sec-pharmex-nlme}</span></span>
<span id="cb29-166"><a href="#cb29-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-167"><a href="#cb29-167" aria-hidden="true" tabindex="-1"></a>For our example and reference, we'll use a simple one-compartment IV model with first-order kinetics, previously fitted to similar data (@klose2025). Here's a sketch of the simple model structure:</span>
<span id="cb29-168"><a href="#cb29-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-169"><a href="#cb29-169" aria-hidden="true" tabindex="-1"></a><span class="al">![Model structure of our simple 1 cmt i.v. bolus model with first order kinetics.](media/model_structure.png)</span>{width=100% #fig-mod-struct}</span>
<span id="cb29-170"><a href="#cb29-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-171"><a href="#cb29-171" aria-hidden="true" tabindex="-1"></a>Assuming our model is already fitted, our goal is to individualize parameters for ID 5. The model parameter estimates are based on the fitted model from the previous blogpost and are as follows:</span>
<span id="cb29-172"><a href="#cb29-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-173"><a href="#cb29-173" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$CL$ = 0.247 L/h</span>
<span id="cb29-174"><a href="#cb29-174" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$V$ = 3.15 L</span>
<span id="cb29-175"><a href="#cb29-175" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\omega^2_{CL}$ = 0.11</span>
<span id="cb29-176"><a href="#cb29-176" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\sigma^2_{RUV<span class="sc">\_</span>ADD}$ = 2.00</span>
<span id="cb29-177"><a href="#cb29-177" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\sigma^2_{RUV<span class="sc">\_</span>PROP}$ = 0.50</span>
<span id="cb29-178"><a href="#cb29-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-179"><a href="#cb29-179" aria-hidden="true" tabindex="-1"></a>In a next step, we will translate this into a NONMEM model. Note that we added a proportional error term to the previously used model to better illustrate the differences among prior, likelihood, and posterior distributions <span class="ot">[^3]</span>. For the same reason, we increased the additive error to 2 mg/L. Let's store this information, along with the 100 mg intravenous bolus dose administered to the individual, in a list object for easy retrieval during subsequent calculations:</span>
<span id="cb29-180"><a href="#cb29-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-183"><a href="#cb29-183" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb29-184"><a href="#cb29-184" aria-hidden="true" tabindex="-1"></a><span class="co"># store model parameters in list</span></span>
<span id="cb29-185"><a href="#cb29-185" aria-hidden="true" tabindex="-1"></a>mod_par <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb29-186"><a href="#cb29-186" aria-hidden="true" tabindex="-1"></a>  <span class="at">tvcl =</span> <span class="fl">0.247</span>,</span>
<span id="cb29-187"><a href="#cb29-187" aria-hidden="true" tabindex="-1"></a>  <span class="at">tvvd =</span> <span class="fl">3.15</span>,</span>
<span id="cb29-188"><a href="#cb29-188" aria-hidden="true" tabindex="-1"></a>  <span class="at">omega2_CL =</span> <span class="fl">0.11</span>,</span>
<span id="cb29-189"><a href="#cb29-189" aria-hidden="true" tabindex="-1"></a>  <span class="at">sigma2_add =</span> <span class="dv">2</span>,</span>
<span id="cb29-190"><a href="#cb29-190" aria-hidden="true" tabindex="-1"></a>  <span class="at">sigma2_prop =</span> <span class="fl">0.50</span>, </span>
<span id="cb29-191"><a href="#cb29-191" aria-hidden="true" tabindex="-1"></a>  <span class="at">dose =</span> <span class="dv">100</span> </span>
<span id="cb29-192"><a href="#cb29-192" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-193"><a href="#cb29-193" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb29-194"><a href="#cb29-194" aria-hidden="true" tabindex="-1"></a><span class="co"># show </span></span>
<span id="cb29-195"><a href="#cb29-195" aria-hidden="true" tabindex="-1"></a>mod_par </span>
<span id="cb29-196"><a href="#cb29-196" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-197"><a href="#cb29-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-198"><a href="#cb29-198" aria-hidden="true" tabindex="-1"></a>Great! Now we can go ahead and define the NONMEM model.</span>
<span id="cb29-199"><a href="#cb29-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-200"><a href="#cb29-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-201"><a href="#cb29-201" aria-hidden="true" tabindex="-1"></a><span class="fu">## NONMEM model {#sec-pharmex-model}</span></span>
<span id="cb29-202"><a href="#cb29-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-203"><a href="#cb29-203" aria-hidden="true" tabindex="-1"></a>We have updated our NONMEM model slightly from the last blogpost:</span>
<span id="cb29-204"><a href="#cb29-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-205"><a href="#cb29-205" aria-hidden="true" tabindex="-1"></a><span class="in">```{.r filename="1cmt_iv_map_est.mod"}</span></span>
<span id="cb29-206"><a href="#cb29-206" aria-hidden="true" tabindex="-1"></a><span class="in">$PROBLEM 1cmt_iv_map_est</span></span>
<span id="cb29-207"><a href="#cb29-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-208"><a href="#cb29-208" aria-hidden="true" tabindex="-1"></a><span class="in">$INPUT ID TIME EVID AMT RATE DV MDV</span></span>
<span id="cb29-209"><a href="#cb29-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-210"><a href="#cb29-210" aria-hidden="true" tabindex="-1"></a><span class="in">$DATA C:\Users\mklose\Desktop\GitHub\personal-website\posts\bayes_map_estimation_r\data\sim_data_ID5.csv IGNORE=@</span></span>
<span id="cb29-211"><a href="#cb29-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-212"><a href="#cb29-212" aria-hidden="true" tabindex="-1"></a><span class="in">$SUBROUTINES ADVAN1 TRANS2</span></span>
<span id="cb29-213"><a href="#cb29-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-214"><a href="#cb29-214" aria-hidden="true" tabindex="-1"></a><span class="in">$PK</span></span>
<span id="cb29-215"><a href="#cb29-215" aria-hidden="true" tabindex="-1"></a><span class="in">; define fixed effects parameters</span></span>
<span id="cb29-216"><a href="#cb29-216" aria-hidden="true" tabindex="-1"></a><span class="in">CL = THETA(1) * EXP(ETA(1))</span></span>
<span id="cb29-217"><a href="#cb29-217" aria-hidden="true" tabindex="-1"></a><span class="in">V = THETA(2)</span></span>
<span id="cb29-218"><a href="#cb29-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-219"><a href="#cb29-219" aria-hidden="true" tabindex="-1"></a><span class="in">; scaling</span></span>
<span id="cb29-220"><a href="#cb29-220" aria-hidden="true" tabindex="-1"></a><span class="in">S1=V</span></span>
<span id="cb29-221"><a href="#cb29-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-222"><a href="#cb29-222" aria-hidden="true" tabindex="-1"></a><span class="in">$THETA</span></span>
<span id="cb29-223"><a href="#cb29-223" aria-hidden="true" tabindex="-1"></a><span class="in">0.247 FIX               ; 1 TVCL</span></span>
<span id="cb29-224"><a href="#cb29-224" aria-hidden="true" tabindex="-1"></a><span class="in">3.15 FIX                ; 2 TVV</span></span>
<span id="cb29-225"><a href="#cb29-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-226"><a href="#cb29-226" aria-hidden="true" tabindex="-1"></a><span class="in">$OMEGA </span></span>
<span id="cb29-227"><a href="#cb29-227" aria-hidden="true" tabindex="-1"></a><span class="in">0.11 FIX                ; 1 OM_CL</span></span>
<span id="cb29-228"><a href="#cb29-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-229"><a href="#cb29-229" aria-hidden="true" tabindex="-1"></a><span class="in">$SIGMA</span></span>
<span id="cb29-230"><a href="#cb29-230" aria-hidden="true" tabindex="-1"></a><span class="in">0.50 FIX                ; 1 SIG_PROP</span></span>
<span id="cb29-231"><a href="#cb29-231" aria-hidden="true" tabindex="-1"></a><span class="in">2.00 FIX                ; 2 SIG_ADD</span></span>
<span id="cb29-232"><a href="#cb29-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-233"><a href="#cb29-233" aria-hidden="true" tabindex="-1"></a><span class="in">$ERROR </span></span>
<span id="cb29-234"><a href="#cb29-234" aria-hidden="true" tabindex="-1"></a><span class="in">; add residual unexplained variability</span></span>
<span id="cb29-235"><a href="#cb29-235" aria-hidden="true" tabindex="-1"></a><span class="in">IPRED = F</span></span>
<span id="cb29-236"><a href="#cb29-236" aria-hidden="true" tabindex="-1"></a><span class="in">Y = IPRED + IPRED * EPS(1) + EPS(2)</span></span>
<span id="cb29-237"><a href="#cb29-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-238"><a href="#cb29-238" aria-hidden="true" tabindex="-1"></a><span class="in">$ESTIMATION METHOD=1 INTERACTION MAXEVAL=0 SIGDIG=3 PRINT=1 NOABORT POSTHOC</span></span>
<span id="cb29-239"><a href="#cb29-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-240"><a href="#cb29-240" aria-hidden="true" tabindex="-1"></a><span class="in">$TABLE ID TIME EVID AMT RATE DV PRED IPRED MDV ETA1 CL NOAPPEND ONEHEADER NOPRINT FILE=map_estim_out</span></span>
<span id="cb29-241"><a href="#cb29-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-242"><a href="#cb29-242" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-243"><a href="#cb29-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-244"><a href="#cb29-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-245"><a href="#cb29-245" aria-hidden="true" tabindex="-1"></a>We have fixed the initial parameter estimates to the final estimates from before and incorporated a combined error model (as described above). By using <span class="in">`MAXEVAL=0`</span>, we avoid any population parameter estimation and the model is simply being evaluated. The <span class="in">`POSTHOC`</span> option computes individual MAP estimates as this is the core of our task. We need to make sure that we include the <span class="in">`INTERACTION`</span> option in the <span class="in">`$ESTIMATION`</span> block, as this tells NONMEM to include the effect of <span class="in">`ETA`</span> on the residual error when performing MAP estimation <span class="ot">[^4]</span>. This is important as our error model now depends on <span class="in">`IPRED`</span>, which in turn depends on <span class="in">`ETA.`</span> </span>
<span id="cb29-246"><a href="#cb29-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-247"><a href="#cb29-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-248"><a href="#cb29-248" aria-hidden="true" tabindex="-1"></a>After running the model, we'll read the output through <span class="in">`map_estim_out`</span>:</span>
<span id="cb29-249"><a href="#cb29-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-252"><a href="#cb29-252" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb29-253"><a href="#cb29-253" aria-hidden="true" tabindex="-1"></a><span class="co"># load simulated data</span></span>
<span id="cb29-254"><a href="#cb29-254" aria-hidden="true" tabindex="-1"></a>nm_out <span class="ot">&lt;-</span> <span class="fu">read_nm_table</span>(<span class="st">"./models/map_estim_out"</span>)</span>
<span id="cb29-255"><a href="#cb29-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-256"><a href="#cb29-256" aria-hidden="true" tabindex="-1"></a><span class="co"># show simulated data</span></span>
<span id="cb29-257"><a href="#cb29-257" aria-hidden="true" tabindex="-1"></a>nm_out <span class="sc">|&gt;</span> </span>
<span id="cb29-258"><a href="#cb29-258" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>() <span class="sc">|&gt;</span> </span>
<span id="cb29-259"><a href="#cb29-259" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>() <span class="sc">|&gt;</span> </span>
<span id="cb29-260"><a href="#cb29-260" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span>
<span id="cb29-261"><a href="#cb29-261" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-262"><a href="#cb29-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-263"><a href="#cb29-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-264"><a href="#cb29-264" aria-hidden="true" tabindex="-1"></a>The <span class="in">`ETA1`</span> (= $\eta_i$) value represents the individual random effect, while <span class="in">`CL`</span> (= $CL_i$) is the individual clearance estimate:</span>
<span id="cb29-265"><a href="#cb29-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-266"><a href="#cb29-266" aria-hidden="true" tabindex="-1"></a>$$CL_i = \theta_{TVCL} \cdot \exp(\eta_i)$$  {#eq-cl-individual}</span>
<span id="cb29-267"><a href="#cb29-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-268"><a href="#cb29-268" aria-hidden="true" tabindex="-1"></a>Calculating this in R yields:</span>
<span id="cb29-269"><a href="#cb29-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-270"><a href="#cb29-270" aria-hidden="true" tabindex="-1"></a>$$CL_i = 0.247 \cdot \exp(0.55194) = 0.42894$$ {#eq-cl-individual-num}</span>
<span id="cb29-271"><a href="#cb29-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-272"><a href="#cb29-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-275"><a href="#cb29-275" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb29-276"><a href="#cb29-276" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: FALSE</span></span>
<span id="cb29-277"><a href="#cb29-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-278"><a href="#cb29-278" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate individual MAP estimate</span></span>
<span id="cb29-279"><a href="#cb29-279" aria-hidden="true" tabindex="-1"></a>mod_par<span class="sc">$</span>tvcl<span class="sc">*</span><span class="fu">exp</span>(nm_out<span class="sc">$</span>ETA1 <span class="sc">|&gt;</span> <span class="fu">unique</span>())</span>
<span id="cb29-280"><a href="#cb29-280" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-281"><a href="#cb29-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-282"><a href="#cb29-282" aria-hidden="true" tabindex="-1"></a>Great! We obtained our reference solution for the MAP parameter individualization. We can now visually compare <span class="in">`DV`</span>, <span class="in">`PRED`</span>, and <span class="in">`IPRED`</span>:</span>
<span id="cb29-283"><a href="#cb29-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-286"><a href="#cb29-286" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb29-287"><a href="#cb29-287" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-comp-dv-pred-ipred</span></span>
<span id="cb29-288"><a href="#cb29-288" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Comparison of observations (DV), population predictions (PRED), and individualized predictions based on the MAP estimate for CL (IPRED)."</span></span>
<span id="cb29-289"><a href="#cb29-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-290"><a href="#cb29-290" aria-hidden="true" tabindex="-1"></a><span class="co"># plot DV, PRED, IPRED</span></span>
<span id="cb29-291"><a href="#cb29-291" aria-hidden="true" tabindex="-1"></a>nm_out <span class="sc">|&gt;</span> </span>
<span id="cb29-292"><a href="#cb29-292" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(TIME <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">|&gt;</span> </span>
<span id="cb29-293"><a href="#cb29-293" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols=</span><span class="fu">c</span>(PRED, IPRED, DV), <span class="at">names_to=</span><span class="st">"variable"</span>, <span class="at">values_to=</span><span class="st">"value"</span>) <span class="sc">|&gt;</span></span>
<span id="cb29-294"><a href="#cb29-294" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>TIME, <span class="at">y=</span>value, <span class="at">group=</span>variable, <span class="at">color=</span>variable))<span class="sc">+</span></span>
<span id="cb29-295"><a href="#cb29-295" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>()<span class="sc">+</span></span>
<span id="cb29-296"><a href="#cb29-296" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()<span class="sc">+</span></span>
<span id="cb29-297"><a href="#cb29-297" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb29-298"><a href="#cb29-298" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Concentration [mg/L]"</span>,</span>
<span id="cb29-299"><a href="#cb29-299" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Time after last dose [h]"</span>,</span>
<span id="cb29-300"><a href="#cb29-300" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Comparison of DV, PRED and IPRED for ID 5"</span>,</span>
<span id="cb29-301"><a href="#cb29-301" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Source"</span></span>
<span id="cb29-302"><a href="#cb29-302" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb29-303"><a href="#cb29-303" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() </span>
<span id="cb29-304"><a href="#cb29-304" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-305"><a href="#cb29-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-306"><a href="#cb29-306" aria-hidden="true" tabindex="-1"></a>Notably, our reference individual's data (<span class="in">`DV`</span>) diverges from typical predictions (<span class="in">`PRED`</span>), while individualized predictions (<span class="in">`IPRED`</span>) fall in between. Let's dive deeper into the process to understand these differences.</span>
<span id="cb29-307"><a href="#cb29-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-308"><a href="#cb29-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-309"><a href="#cb29-309" aria-hidden="true" tabindex="-1"></a><span class="fu"># Bayesian Theory {#sec-bayesth}</span></span>
<span id="cb29-310"><a href="#cb29-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-311"><a href="#cb29-311" aria-hidden="true" tabindex="-1"></a><span class="fu">## General form of Bayes' theorem {#sec-bayesth-general}</span></span>
<span id="cb29-312"><a href="#cb29-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-313"><a href="#cb29-313" aria-hidden="true" tabindex="-1"></a>As described earlier, the primary goal of a Bayesian approach is to obtain the posterior distribution, either as the mode or as the complete distribution. Bayes' theorem is commonly presented as follows:</span>
<span id="cb29-314"><a href="#cb29-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-315"><a href="#cb29-315" aria-hidden="true" tabindex="-1"></a>$$P(A|B) = \frac{P(A) \cdot P(B|A)}{P(B)}$$ {#eq-bayes-general}</span>
<span id="cb29-316"><a href="#cb29-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-317"><a href="#cb29-317" aria-hidden="true" tabindex="-1"></a>Here, conditional probabilities are utilized, and $P(A|B)$ represents the probability of event $A$ given event $B$ has occurred. However, this remains quite theoretical. Let's directly translate it into the context of a pharmacokinetic NLME model.</span>
<span id="cb29-318"><a href="#cb29-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-319"><a href="#cb29-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-320"><a href="#cb29-320" aria-hidden="true" tabindex="-1"></a><span class="fu">## Pharmacometric context {#sec-bayesth-pharmetrx}</span></span>
<span id="cb29-321"><a href="#cb29-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-322"><a href="#cb29-322" aria-hidden="true" tabindex="-1"></a>In pharmacometrics, we aim to determine the most likely individual random effect $\eta_i$ (which translates to the individual parameter $CL_i$), given the observed concentration data $Y_{i}$ for the individual. Therefore, we are mostly interested to find the posterior distribution of the individual random effect $\eta_i$ given the data $Y_{i}$:</span>
<span id="cb29-323"><a href="#cb29-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-324"><a href="#cb29-324" aria-hidden="true" tabindex="-1"></a>$$p(\eta_i|Y_{i}) = \frac{p(\eta_i) \cdot p(Y_{i}|\eta_i)}{p(Y_i)}$$  {#eq-bayes-specific-norm}</span>
<span id="cb29-325"><a href="#cb29-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-326"><a href="#cb29-326" aria-hidden="true" tabindex="-1"></a>with </span>
<span id="cb29-327"><a href="#cb29-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-328"><a href="#cb29-328" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$p(\eta_i|Y_{i})$: posterior distribution of parameter $\eta_i$ given the individual data $Y_{i}$</span>
<span id="cb29-329"><a href="#cb29-329" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$p(\eta_i)$: prior distribution of parameter $\eta_i$</span>
<span id="cb29-330"><a href="#cb29-330" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$p(Y_{i}|\eta_i)$: likelihood of observing data $Y_{i}$ given parameter $\eta_i$</span>
<span id="cb29-331"><a href="#cb29-331" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$p(Y_{i})$: marginal likelihood of data $Y_{i}$</span>
<span id="cb29-332"><a href="#cb29-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-333"><a href="#cb29-333" aria-hidden="true" tabindex="-1"></a>The marginal likelihood $p(Y_{i})$ is typically neglected because it just acts as a scaling factor, does not depend on $\eta_i$, and is computationally difficult due to a high-dimensional integral. Thus, the formula is often simplified to:</span>
<span id="cb29-334"><a href="#cb29-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-335"><a href="#cb29-335" aria-hidden="true" tabindex="-1"></a>$$p(\eta_i|Y_{i}) \propto p(\eta_i) \cdot p(Y_{i}|\eta_i)$$ {#eq-bayes-specific-unnorm}</span>
<span id="cb29-336"><a href="#cb29-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-337"><a href="#cb29-337" aria-hidden="true" tabindex="-1"></a>Removing the marginal likelihood gives an unnormalized posterior distribution, indicated by the proportional sign. Working with an unnormalized posterior is acceptable when our when we solely care about finding the mode of the posterior distribution (MAP estimate), as normalization is unnecessary in this scenario. But how exactly do we calculate the MAP estimate?</span>
<span id="cb29-338"><a href="#cb29-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-339"><a href="#cb29-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-340"><a href="#cb29-340" aria-hidden="true" tabindex="-1"></a><span class="fu">## MAP estimation {#sec-bayesth-map}</span></span>
<span id="cb29-341"><a href="#cb29-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-342"><a href="#cb29-342" aria-hidden="true" tabindex="-1"></a>To find the most likely parameter for an individual, we must identify the maximum of the posterior distribution (MAP estimate). Mathematically, this involves finding the parameter $\eta_i^*$ that maximizes the posterior:</span>
<span id="cb29-343"><a href="#cb29-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-344"><a href="#cb29-344" aria-hidden="true" tabindex="-1"></a>$$\eta_i^* = \underset{\eta_i}{\mathrm{argmax}}~ p(\eta_i|Y_{i}) = \underset{\eta_i}{\mathrm{argmax}}~ p(\eta_i) \cdot \prod_{j=1}^{m} p(Y_{ij}|\eta_i)$$ {#eq-map-norm}</span>
<span id="cb29-345"><a href="#cb29-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-346"><a href="#cb29-346" aria-hidden="true" tabindex="-1"></a>Dealing with products of small probability densities can be cumbersome (and mathematically instable), so taking the logarithm simplifies the calculation:</span>
<span id="cb29-347"><a href="#cb29-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-348"><a href="#cb29-348" aria-hidden="true" tabindex="-1"></a>$$\eta_i^* = \underset{\eta_i}{\mathrm{argmax}}~ \log(p(\eta_i|Y_{i})) = \underset{\eta_i}{\mathrm{argmax}}~ \log(p(\eta_i)) + \sum_{j=1}^{m} \log(p(Y_{ij}|\eta_i))$$ {#eq-map-log}</span>
<span id="cb29-349"><a href="#cb29-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-350"><a href="#cb29-350" aria-hidden="true" tabindex="-1"></a>In the end, we would have to use a numerical optimizer function to explore the parameter space of $\eta_i$ and locate the maximum of the posterior distribution ($\eta_i^*$). To fully express the equation, we must define both the log prior $\log(p(\eta_i))$ and log likelihood $\log(p(Y_{ij}|\eta_i))$ terms. Let's explore these in detail.</span>
<span id="cb29-351"><a href="#cb29-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-352"><a href="#cb29-352" aria-hidden="true" tabindex="-1"></a><span class="fu">### Prior term {#sec-bayesth-map-prior}</span></span>
<span id="cb29-353"><a href="#cb29-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-354"><a href="#cb29-354" aria-hidden="true" tabindex="-1"></a>The prior distribution $p(\eta_i)$ captures our inital beliefs and uncertainties regarding $\eta_i$ before observing the data. Bayesian methods allow to  incorporate prior knowledge through various distributions and parameters (which is why Bayesians are sometimes being criticized of being too subjective). In pharmacometrics, a common approach is using a prior based on a previously estimated model, typically a normal distribution with mean 0 and variance $\omega^2_{CL}$ estimated from the NLME model. In contrast to other disciplines, the choice of our priors is generally less controversial, although there has been recent discussion regarding whether this one-approach-fits-all is always appropriate or if priors should be adjusted (e.g., flattened compared to the NLME estimate) in certain situations. See @hughes2021 for more information. The general "role" of the prior term is that strong deviations from the "typical" individual should only be considered when it allows us do substantially better explain the observed data. I like to see it as some kind of penalty function which prevents us from doing a potentially flawed curve fitting exercise. The probability density function (PDF) of a normal distribution can be used to calculate its contribution:</span>
<span id="cb29-355"><a href="#cb29-355" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb29-356"><a href="#cb29-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-357"><a href="#cb29-357" aria-hidden="true" tabindex="-1"></a>$$p(\eta_i) = \frac{1}{\sqrt{2\pi\omega^2}} \cdot \exp\left(-\frac{(\eta_i-\mu)^2}{2\omega^2}\right)$$  {#eq-prior-1}</span>
<span id="cb29-358"><a href="#cb29-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-359"><a href="#cb29-359" aria-hidden="true" tabindex="-1"></a>Since $\mu$ is typically 0, this simplifies to:</span>
<span id="cb29-360"><a href="#cb29-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-361"><a href="#cb29-361" aria-hidden="true" tabindex="-1"></a>$$p(\eta_i) = \frac{1}{\sqrt{2\pi\omega^2}} \cdot \exp\left(-\frac{\eta_i^2}{2\omega^2}\right)$$ {#eq-prior-2}</span>
<span id="cb29-362"><a href="#cb29-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-363"><a href="#cb29-363" aria-hidden="true" tabindex="-1"></a>Taking the log yields:</span>
<span id="cb29-364"><a href="#cb29-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-365"><a href="#cb29-365" aria-hidden="true" tabindex="-1"></a>$$\log(p(\eta_i)) = -0.5 \log(2\pi\omega^2) - \frac{\eta_i^2}{2\omega^2}$$ {#eq-prior-3}</span>
<span id="cb29-366"><a href="#cb29-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-367"><a href="#cb29-367" aria-hidden="true" tabindex="-1"></a>Now, we can compute the prior term for any given individual $\eta_i$, using variance $\omega^2_{CL}$ (e.g., 0.11) from our NLME model. If we have a good reason to believe that our prior should be different (e.g., we apply our model to another population), we could adjust the variance accordingly (as described in @hughes2021).</span>
<span id="cb29-368"><a href="#cb29-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-369"><a href="#cb29-369" aria-hidden="true" tabindex="-1"></a><span class="fu">### Likelihood term {#sec-bayesth-map-likelihood}</span></span>
<span id="cb29-370"><a href="#cb29-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-371"><a href="#cb29-371" aria-hidden="true" tabindex="-1"></a>The likelihood term $p(Y_{ij}|\eta_i)$ is the probability of observing the data point $Y_{ij}$ given the parameter $\eta_i$. As we usually assume the residuals of our model predictions to be normally distributed, we again use the normal distribution PDF:</span>
<span id="cb29-372"><a href="#cb29-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-373"><a href="#cb29-373" aria-hidden="true" tabindex="-1"></a>$$p(Y_{ij}|\eta_i) = \frac{1}{\sqrt{2\pi\sigma^2}} \cdot \exp\left(-\frac{(Y_{ij}-f(x_{ij}; \eta_i))^2}{2\sigma^2}\right)$$ {#eq-likelihood-1}</span>
<span id="cb29-374"><a href="#cb29-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-375"><a href="#cb29-375" aria-hidden="true" tabindex="-1"></a>where</span>
<span id="cb29-376"><a href="#cb29-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-377"><a href="#cb29-377" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$Y_{ij}$: observed data point for individual $i$ at time $j$</span>
<span id="cb29-378"><a href="#cb29-378" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$f(x_{ij}; \eta_i)$: model prediction for individual $i$ at time $j$, given parameter $\eta_i$</span>
<span id="cb29-379"><a href="#cb29-379" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\sigma^2$: variance representing residual unexplained variability (RUV)</span>
<span id="cb29-380"><a href="#cb29-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-381"><a href="#cb29-381" aria-hidden="true" tabindex="-1"></a>Taking the log yields:</span>
<span id="cb29-382"><a href="#cb29-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-383"><a href="#cb29-383" aria-hidden="true" tabindex="-1"></a>$$\log(p(Y_{ij}|\eta_i)) = -0.5 \log(2\pi\sigma^2) - \frac{(Y_{ij}-f(x_{ij}; \eta_i))^2}{2\sigma^2}$$ {#eq-likelihood-2}</span>
<span id="cb29-384"><a href="#cb29-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-385"><a href="#cb29-385" aria-hidden="true" tabindex="-1"></a>Please note that in our case (a combined additive and proportional RUV model), $\sigma^2$ represents the combined variances at time $t_{ij}$ and prediction $f(x_{ij})$. As the structural solution of our model, $f(x_{ij})$, is a constant for a given $t_{ij}$, we can compute the combined variance as </span>
<span id="cb29-386"><a href="#cb29-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-387"><a href="#cb29-387" aria-hidden="true" tabindex="-1"></a>$$\sigma^2 = \sigma^2_{prop} \cdot f(x_{ij})^2 + \sigma^2_{add}$$ {#eq-sigma2}</span>
<span id="cb29-388"><a href="#cb29-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-389"><a href="#cb29-389" aria-hidden="true" tabindex="-1"></a>Therefore, we later have to calculate the $\sigma^2$ for each data point $Y_{ij}$ individually.</span>
<span id="cb29-390"><a href="#cb29-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-391"><a href="#cb29-391" aria-hidden="true" tabindex="-1"></a><span class="fu">## Combining both terms {#sec-bayesth-map-final}</span></span>
<span id="cb29-392"><a href="#cb29-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-393"><a href="#cb29-393" aria-hidden="true" tabindex="-1"></a>Writing out the log prior (@eq-prior-3) and log likelihood (@eq-likelihood-2) terms in our MAP estimation objective function (@eq-map-log), we obtain:</span>
<span id="cb29-394"><a href="#cb29-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-395"><a href="#cb29-395" aria-hidden="true" tabindex="-1"></a>$$\eta_i^* = \underset{\eta_i}{\mathrm{argmax}}~\left(\left<span class="co">[</span><span class="ot">-0.5 \log(2\pi\omega^2) - \frac{\eta_i^2}{2\omega^2}\right</span><span class="co">]</span> ~ + \sum_{j=1}^m \left<span class="co">[</span><span class="ot">-0.5 \log(2\pi\sigma^2) - \frac{(Y_{ij}-f(x_{ij}; \eta_i))^2}{2\sigma^2}\right</span><span class="co">]</span>\right)$$ {#eq-map-final}</span>
<span id="cb29-396"><a href="#cb29-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-397"><a href="#cb29-397" aria-hidden="true" tabindex="-1"></a>This final equation will guide our numerical optimizer (<span class="in">`optim`</span> function in R) to determine the maximum, providing us with the individual MAP estimate. Let's implement this method in R and reproduce our NONMEM reference solution!  </span>
<span id="cb29-398"><a href="#cb29-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-399"><a href="#cb29-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-400"><a href="#cb29-400" aria-hidden="true" tabindex="-1"></a><span class="fu"># R-based MAP reproduction {#sec-rrepro}</span></span>
<span id="cb29-401"><a href="#cb29-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-402"><a href="#cb29-402" aria-hidden="true" tabindex="-1"></a><span class="fu">## Prior term {#sec-rrepro-prior}</span></span>
<span id="cb29-403"><a href="#cb29-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-404"><a href="#cb29-404" aria-hidden="true" tabindex="-1"></a>We start by defining a function to calculate the prior term given by @eq-prior-3. Here, we simply pass the individual $\eta_i$ and the model parameters (including $\omega^2_{CL}$) as input arguments, and the function returns the log probability of the given $\eta_i$ under the prior distribution:</span>
<span id="cb29-405"><a href="#cb29-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-406"><a href="#cb29-406" aria-hidden="true" tabindex="-1"></a><span class="in">```{r filename="function: prior_fun()"}</span></span>
<span id="cb29-407"><a href="#cb29-407" aria-hidden="true" tabindex="-1"></a><span class="in">#| echo: true</span></span>
<span id="cb29-408"><a href="#cb29-408" aria-hidden="true" tabindex="-1"></a><span class="in">#| collapse: false</span></span>
<span id="cb29-409"><a href="#cb29-409" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: false</span></span>
<span id="cb29-410"><a href="#cb29-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-411"><a href="#cb29-411" aria-hidden="true" tabindex="-1"></a><span class="in"># define prior term function</span></span>
<span id="cb29-412"><a href="#cb29-412" aria-hidden="true" tabindex="-1"></a><span class="in">prior_fun &lt;- function(eta_i, mod_par){</span></span>
<span id="cb29-413"><a href="#cb29-413" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb29-414"><a href="#cb29-414" aria-hidden="true" tabindex="-1"></a><span class="in">  # retrieve omega2 from model parameters</span></span>
<span id="cb29-415"><a href="#cb29-415" aria-hidden="true" tabindex="-1"></a><span class="in">  omega2 &lt;- mod_par$omega2_CL</span></span>
<span id="cb29-416"><a href="#cb29-416" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb29-417"><a href="#cb29-417" aria-hidden="true" tabindex="-1"></a><span class="in">  # calculate probability</span></span>
<span id="cb29-418"><a href="#cb29-418" aria-hidden="true" tabindex="-1"></a><span class="in">  log_prob &lt;- - 0.5 * log(2*pi*omega2) - eta_i^2/(2*omega2)</span></span>
<span id="cb29-419"><a href="#cb29-419" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb29-420"><a href="#cb29-420" aria-hidden="true" tabindex="-1"></a><span class="in">  # return log probability</span></span>
<span id="cb29-421"><a href="#cb29-421" aria-hidden="true" tabindex="-1"></a><span class="in">  return(log_prob)</span></span>
<span id="cb29-422"><a href="#cb29-422" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb29-423"><a href="#cb29-423" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-424"><a href="#cb29-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-425"><a href="#cb29-425" aria-hidden="true" tabindex="-1"></a>We can test this function by illustrating the prior term across a range of $\eta_i$ values:</span>
<span id="cb29-426"><a href="#cb29-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-429"><a href="#cb29-429" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb29-430"><a href="#cb29-430" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-prior-term</span></span>
<span id="cb29-431"><a href="#cb29-431" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Probability density of different random effects given a normal distribution centered around 0 with a variance of 0.11."</span></span>
<span id="cb29-432"><a href="#cb29-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-433"><a href="#cb29-433" aria-hidden="true" tabindex="-1"></a><span class="co"># define range</span></span>
<span id="cb29-434"><a href="#cb29-434" aria-hidden="true" tabindex="-1"></a>eta_i <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">2</span>, <span class="dv">2</span>, <span class="fl">0.01</span>)</span>
<span id="cb29-435"><a href="#cb29-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-436"><a href="#cb29-436" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate prior term</span></span>
<span id="cb29-437"><a href="#cb29-437" aria-hidden="true" tabindex="-1"></a>prior <span class="ot">&lt;-</span> <span class="fu">prior_fun</span>(<span class="at">eta_i =</span> eta_i, <span class="at">mod_par =</span> mod_par)</span>
<span id="cb29-438"><a href="#cb29-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-439"><a href="#cb29-439" aria-hidden="true" tabindex="-1"></a><span class="co"># create tibble</span></span>
<span id="cb29-440"><a href="#cb29-440" aria-hidden="true" tabindex="-1"></a>prior_tibble <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb29-441"><a href="#cb29-441" aria-hidden="true" tabindex="-1"></a>  <span class="at">eta_i =</span> eta_i,</span>
<span id="cb29-442"><a href="#cb29-442" aria-hidden="true" tabindex="-1"></a>  <span class="at">p =</span> prior,</span>
<span id="cb29-443"><a href="#cb29-443" aria-hidden="true" tabindex="-1"></a>  <span class="at">source =</span> <span class="st">"prior"</span></span>
<span id="cb29-444"><a href="#cb29-444" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-445"><a href="#cb29-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-446"><a href="#cb29-446" aria-hidden="true" tabindex="-1"></a><span class="co"># plot prior term</span></span>
<span id="cb29-447"><a href="#cb29-447" aria-hidden="true" tabindex="-1"></a>prior_tibble <span class="sc">|&gt;</span> </span>
<span id="cb29-448"><a href="#cb29-448" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>eta_i, <span class="at">y=</span><span class="fu">exp</span>(p)))<span class="sc">+</span></span>
<span id="cb29-449"><a href="#cb29-449" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"darkblue"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>)<span class="sc">+</span></span>
<span id="cb29-450"><a href="#cb29-450" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"darkblue"</span>, <span class="at">linewidth =</span> <span class="fl">0.6</span>)<span class="sc">+</span></span>
<span id="cb29-451"><a href="#cb29-451" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb29-452"><a href="#cb29-452" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">expression</span>(eta[i]),</span>
<span id="cb29-453"><a href="#cb29-453" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Probability density"</span>,</span>
<span id="cb29-454"><a href="#cb29-454" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Prior term (random effect)"</span></span>
<span id="cb29-455"><a href="#cb29-455" aria-hidden="true" tabindex="-1"></a>  )<span class="sc">+</span></span>
<span id="cb29-456"><a href="#cb29-456" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb29-457"><a href="#cb29-457" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-458"><a href="#cb29-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-459"><a href="#cb29-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-460"><a href="#cb29-460" aria-hidden="true" tabindex="-1"></a>The following plot shows how these $\eta_i$ values map onto the clearance domain:</span>
<span id="cb29-461"><a href="#cb29-461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-464"><a href="#cb29-464" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb29-465"><a href="#cb29-465" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-prior-term-cl</span></span>
<span id="cb29-466"><a href="#cb29-466" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Probability density of different clearance values."</span></span>
<span id="cb29-467"><a href="#cb29-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-468"><a href="#cb29-468" aria-hidden="true" tabindex="-1"></a><span class="co"># plot prior term</span></span>
<span id="cb29-469"><a href="#cb29-469" aria-hidden="true" tabindex="-1"></a>prior_tibble <span class="sc">|&gt;</span> </span>
<span id="cb29-470"><a href="#cb29-470" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>mod_par<span class="sc">$</span>tvcl<span class="sc">*</span><span class="fu">exp</span>(eta_i), <span class="at">y=</span><span class="fu">exp</span>(p)))<span class="sc">+</span></span>
<span id="cb29-471"><a href="#cb29-471" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"darkblue"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>)<span class="sc">+</span></span>
<span id="cb29-472"><a href="#cb29-472" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> mod_par<span class="sc">$</span>tvcl, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"darkblue"</span>, <span class="at">linewidth =</span> <span class="fl">0.6</span>)<span class="sc">+</span></span>
<span id="cb29-473"><a href="#cb29-473" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb29-474"><a href="#cb29-474" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">expression</span>(CL[i]),</span>
<span id="cb29-475"><a href="#cb29-475" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Probability density"</span>,</span>
<span id="cb29-476"><a href="#cb29-476" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Prior term (clearance)"</span></span>
<span id="cb29-477"><a href="#cb29-477" aria-hidden="true" tabindex="-1"></a>  )<span class="sc">+</span></span>
<span id="cb29-478"><a href="#cb29-478" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb29-479"><a href="#cb29-479" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-480"><a href="#cb29-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-481"><a href="#cb29-481" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb29-482"><a href="#cb29-482" aria-hidden="true" tabindex="-1"></a>From the plots, we see that certain values of $\eta_i$ and $CL_i$ are more likely than others, based on our prior beliefs derived from the NLME model estimates, before observing any individual data. Let's continue with the likelihood term:</span>
<span id="cb29-483"><a href="#cb29-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-484"><a href="#cb29-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-485"><a href="#cb29-485" aria-hidden="true" tabindex="-1"></a><span class="fu">## Likelihood term {#sec-rrepro-likelihood}</span></span>
<span id="cb29-486"><a href="#cb29-486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-487"><a href="#cb29-487" aria-hidden="true" tabindex="-1"></a>To calculate the log likelihood term described in @eq-likelihood-2, we first have to define a model prediction function. Given our simple one-compartment model, we use a closed-form expression, though the principles apply equally to ODE-based models. More details on the model prediction function can be found in the previous blogpost, see @klose2025.</span>
<span id="cb29-488"><a href="#cb29-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-489"><a href="#cb29-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-490"><a href="#cb29-490" aria-hidden="true" tabindex="-1"></a><span class="in">```{r filename="function: model_fun()"}</span></span>
<span id="cb29-491"><a href="#cb29-491" aria-hidden="true" tabindex="-1"></a><span class="in">#| echo: true</span></span>
<span id="cb29-492"><a href="#cb29-492" aria-hidden="true" tabindex="-1"></a><span class="in">#| collapse: false</span></span>
<span id="cb29-493"><a href="#cb29-493" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: false</span></span>
<span id="cb29-494"><a href="#cb29-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-495"><a href="#cb29-495" aria-hidden="true" tabindex="-1"></a><span class="in"># define model function</span></span>
<span id="cb29-496"><a href="#cb29-496" aria-hidden="true" tabindex="-1"></a><span class="in">model_fun &lt;- function(eta_i, dose, vd, theta_tvcl, t) {</span></span>
<span id="cb29-497"><a href="#cb29-497" aria-hidden="true" tabindex="-1"></a><span class="in">  exp_eta_i &lt;- exp(eta_i)</span></span>
<span id="cb29-498"><a href="#cb29-498" aria-hidden="true" tabindex="-1"></a><span class="in">  exponent &lt;- -1 * (theta_tvcl * exp_eta_i / vd) * t</span></span>
<span id="cb29-499"><a href="#cb29-499" aria-hidden="true" tabindex="-1"></a><span class="in">  result &lt;- (dose / vd) * exp(exponent)</span></span>
<span id="cb29-500"><a href="#cb29-500" aria-hidden="true" tabindex="-1"></a><span class="in">  return(result)</span></span>
<span id="cb29-501"><a href="#cb29-501" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb29-502"><a href="#cb29-502" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-503"><a href="#cb29-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-504"><a href="#cb29-504" aria-hidden="true" tabindex="-1"></a>Next, we construct the likelihood function for individual observations. Please note that we have to calculate the $\sigma^2$ for each data point $Y_{ij}$ individually, as the variance contains an element proportional to the model prediction $f_i$ (see @eq-likelihood-2). The following equation calculates the log likelihood for a single observation:</span>
<span id="cb29-505"><a href="#cb29-505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-506"><a href="#cb29-506" aria-hidden="true" tabindex="-1"></a><span class="in">```{r filename="function: log_likelihood_fun_single()"}</span></span>
<span id="cb29-507"><a href="#cb29-507" aria-hidden="true" tabindex="-1"></a><span class="in">#| echo: true</span></span>
<span id="cb29-508"><a href="#cb29-508" aria-hidden="true" tabindex="-1"></a><span class="in">#| collapse: false</span></span>
<span id="cb29-509"><a href="#cb29-509" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: false</span></span>
<span id="cb29-510"><a href="#cb29-510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-511"><a href="#cb29-511" aria-hidden="true" tabindex="-1"></a><span class="in"># define likelihood function for a single observation</span></span>
<span id="cb29-512"><a href="#cb29-512" aria-hidden="true" tabindex="-1"></a><span class="in">log_likelihood_fun_single &lt;- function(eta_i, dose, vd, theta_tvcl, t_ij, Y_ij, sigma2_add, sigma2_prop){</span></span>
<span id="cb29-513"><a href="#cb29-513" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb29-514"><a href="#cb29-514" aria-hidden="true" tabindex="-1"></a><span class="in">  # get model predictions</span></span>
<span id="cb29-515"><a href="#cb29-515" aria-hidden="true" tabindex="-1"></a><span class="in">  f_ij &lt;- model_fun(eta_i, dose, vd, theta_tvcl, t_ij)</span></span>
<span id="cb29-516"><a href="#cb29-516" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb29-517"><a href="#cb29-517" aria-hidden="true" tabindex="-1"></a><span class="in">  # calculate resulting sigma2 for each timepoint (prop variance is scaled based on f_i^2)</span></span>
<span id="cb29-518"><a href="#cb29-518" aria-hidden="true" tabindex="-1"></a><span class="in">  sigma2 &lt;- sigma2_prop * f_ij^2 + sigma2_add</span></span>
<span id="cb29-519"><a href="#cb29-519" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb29-520"><a href="#cb29-520" aria-hidden="true" tabindex="-1"></a><span class="in">  # calculate probability</span></span>
<span id="cb29-521"><a href="#cb29-521" aria-hidden="true" tabindex="-1"></a><span class="in">  log_lik &lt;- - 0.5 * log(2*pi*sigma2) - (Y_ij - f_ij)^2/(2*sigma2)</span></span>
<span id="cb29-522"><a href="#cb29-522" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb29-523"><a href="#cb29-523" aria-hidden="true" tabindex="-1"></a><span class="in">  # return log likelihood</span></span>
<span id="cb29-524"><a href="#cb29-524" aria-hidden="true" tabindex="-1"></a><span class="in">  return(log_lik)</span></span>
<span id="cb29-525"><a href="#cb29-525" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb29-526"><a href="#cb29-526" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-527"><a href="#cb29-527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-528"><a href="#cb29-528" aria-hidden="true" tabindex="-1"></a>To illustrate this, we calculate the likelihood for each observation, then sum these to obtain the total likelihood for a given $\eta_i$. We demonstrate this using an example with $\eta_i = 0$:</span>
<span id="cb29-529"><a href="#cb29-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-530"><a href="#cb29-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-533"><a href="#cb29-533" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb29-534"><a href="#cb29-534" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate lok lik per row</span></span>
<span id="cb29-535"><a href="#cb29-535" aria-hidden="true" tabindex="-1"></a>sim_data_id5 <span class="ot">&lt;-</span> sim_data_id5 <span class="sc">|&gt;</span> </span>
<span id="cb29-536"><a href="#cb29-536" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">|&gt;</span> </span>
<span id="cb29-537"><a href="#cb29-537" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb29-538"><a href="#cb29-538" aria-hidden="true" tabindex="-1"></a>    <span class="at">log_lik =</span> <span class="fu">case_when</span>(</span>
<span id="cb29-539"><a href="#cb29-539" aria-hidden="true" tabindex="-1"></a>      EVID <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="fu">log_likelihood_fun_single</span>(</span>
<span id="cb29-540"><a href="#cb29-540" aria-hidden="true" tabindex="-1"></a>        <span class="at">eta_i =</span> <span class="dv">0</span>, </span>
<span id="cb29-541"><a href="#cb29-541" aria-hidden="true" tabindex="-1"></a>        <span class="at">dose =</span> mod_par<span class="sc">$</span>dose, </span>
<span id="cb29-542"><a href="#cb29-542" aria-hidden="true" tabindex="-1"></a>        <span class="at">vd =</span> mod_par<span class="sc">$</span>tvvd, </span>
<span id="cb29-543"><a href="#cb29-543" aria-hidden="true" tabindex="-1"></a>        <span class="at">theta_tvcl =</span> mod_par<span class="sc">$</span>tvcl, </span>
<span id="cb29-544"><a href="#cb29-544" aria-hidden="true" tabindex="-1"></a>        <span class="at">t_ij =</span> TIME, </span>
<span id="cb29-545"><a href="#cb29-545" aria-hidden="true" tabindex="-1"></a>        <span class="at">Y_ij =</span> DV, </span>
<span id="cb29-546"><a href="#cb29-546" aria-hidden="true" tabindex="-1"></a>        <span class="at">sigma2_add =</span> mod_par<span class="sc">$</span>sigma2_add, </span>
<span id="cb29-547"><a href="#cb29-547" aria-hidden="true" tabindex="-1"></a>        <span class="at">sigma2_prop =</span> mod_par<span class="sc">$</span>sigma2_prop</span>
<span id="cb29-548"><a href="#cb29-548" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb29-549"><a href="#cb29-549" aria-hidden="true" tabindex="-1"></a>      EVID <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="cn">NA_real_</span></span>
<span id="cb29-550"><a href="#cb29-550" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb29-551"><a href="#cb29-551" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb29-552"><a href="#cb29-552" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> </span>
<span id="cb29-553"><a href="#cb29-553" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb29-554"><a href="#cb29-554" aria-hidden="true" tabindex="-1"></a>    <span class="at">sum_log_lik =</span> <span class="fu">sum</span>(log_lik, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb29-555"><a href="#cb29-555" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb29-556"><a href="#cb29-556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-557"><a href="#cb29-557" aria-hidden="true" tabindex="-1"></a><span class="co"># show sim_data_id5</span></span>
<span id="cb29-558"><a href="#cb29-558" aria-hidden="true" tabindex="-1"></a>sim_data_id5 <span class="sc">|&gt;</span></span>
<span id="cb29-559"><a href="#cb29-559" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>() <span class="sc">|&gt;</span> </span>
<span id="cb29-560"><a href="#cb29-560" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span>
<span id="cb29-561"><a href="#cb29-561" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-562"><a href="#cb29-562" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-563"><a href="#cb29-563" aria-hidden="true" tabindex="-1"></a>We observe individual likelihood contributions and their sum. To streamline this process, we define a function that computes the summed likelihood across multiple observations:</span>
<span id="cb29-564"><a href="#cb29-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-565"><a href="#cb29-565" aria-hidden="true" tabindex="-1"></a><span class="in">```{r filename="function: log_likelihood_fun_multiple()"}</span></span>
<span id="cb29-566"><a href="#cb29-566" aria-hidden="true" tabindex="-1"></a><span class="in">#| echo: true</span></span>
<span id="cb29-567"><a href="#cb29-567" aria-hidden="true" tabindex="-1"></a><span class="in">#| collapse: false</span></span>
<span id="cb29-568"><a href="#cb29-568" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: false</span></span>
<span id="cb29-569"><a href="#cb29-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-570"><a href="#cb29-570" aria-hidden="true" tabindex="-1"></a><span class="in"># define likelihood function for a set of observations</span></span>
<span id="cb29-571"><a href="#cb29-571" aria-hidden="true" tabindex="-1"></a><span class="in">log_likelihood_fun_multiple &lt;- function(df, eta_i, mod_par){</span></span>
<span id="cb29-572"><a href="#cb29-572" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb29-573"><a href="#cb29-573" aria-hidden="true" tabindex="-1"></a><span class="in">  # retrieve information from mod_par</span></span>
<span id="cb29-574"><a href="#cb29-574" aria-hidden="true" tabindex="-1"></a><span class="in">  dose &lt;- mod_par$dose</span></span>
<span id="cb29-575"><a href="#cb29-575" aria-hidden="true" tabindex="-1"></a><span class="in">  vd &lt;- mod_par$tvvd</span></span>
<span id="cb29-576"><a href="#cb29-576" aria-hidden="true" tabindex="-1"></a><span class="in">  theta_tvcl &lt;- mod_par$tvcl</span></span>
<span id="cb29-577"><a href="#cb29-577" aria-hidden="true" tabindex="-1"></a><span class="in">  sigma2_add &lt;- mod_par$sigma2_add</span></span>
<span id="cb29-578"><a href="#cb29-578" aria-hidden="true" tabindex="-1"></a><span class="in">  sigma2_prop &lt;- mod_par$sigma2_prop</span></span>
<span id="cb29-579"><a href="#cb29-579" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb29-580"><a href="#cb29-580" aria-hidden="true" tabindex="-1"></a><span class="in">  # calculate log lik per row</span></span>
<span id="cb29-581"><a href="#cb29-581" aria-hidden="true" tabindex="-1"></a><span class="in">  log_lik_sum &lt;- df |&gt;</span></span>
<span id="cb29-582"><a href="#cb29-582" aria-hidden="true" tabindex="-1"></a><span class="in">    rowwise() |&gt; </span></span>
<span id="cb29-583"><a href="#cb29-583" aria-hidden="true" tabindex="-1"></a><span class="in">    mutate(</span></span>
<span id="cb29-584"><a href="#cb29-584" aria-hidden="true" tabindex="-1"></a><span class="in">      log_lik = case_when(</span></span>
<span id="cb29-585"><a href="#cb29-585" aria-hidden="true" tabindex="-1"></a><span class="in">        EVID == 0 ~ log_likelihood_fun_single(</span></span>
<span id="cb29-586"><a href="#cb29-586" aria-hidden="true" tabindex="-1"></a><span class="in">          eta_i = eta_i, </span></span>
<span id="cb29-587"><a href="#cb29-587" aria-hidden="true" tabindex="-1"></a><span class="in">          dose = dose, </span></span>
<span id="cb29-588"><a href="#cb29-588" aria-hidden="true" tabindex="-1"></a><span class="in">          vd = vd, </span></span>
<span id="cb29-589"><a href="#cb29-589" aria-hidden="true" tabindex="-1"></a><span class="in">          theta_tvcl = theta_tvcl, </span></span>
<span id="cb29-590"><a href="#cb29-590" aria-hidden="true" tabindex="-1"></a><span class="in">          t_ij = TIME, </span></span>
<span id="cb29-591"><a href="#cb29-591" aria-hidden="true" tabindex="-1"></a><span class="in">          Y_ij = DV, </span></span>
<span id="cb29-592"><a href="#cb29-592" aria-hidden="true" tabindex="-1"></a><span class="in">          sigma2_add = sigma2_add, </span></span>
<span id="cb29-593"><a href="#cb29-593" aria-hidden="true" tabindex="-1"></a><span class="in">          sigma2_prop = sigma2_prop</span></span>
<span id="cb29-594"><a href="#cb29-594" aria-hidden="true" tabindex="-1"></a><span class="in">        ),</span></span>
<span id="cb29-595"><a href="#cb29-595" aria-hidden="true" tabindex="-1"></a><span class="in">        EVID == 1 ~ NA_real_</span></span>
<span id="cb29-596"><a href="#cb29-596" aria-hidden="true" tabindex="-1"></a><span class="in">      )</span></span>
<span id="cb29-597"><a href="#cb29-597" aria-hidden="true" tabindex="-1"></a><span class="in">    ) |&gt; </span></span>
<span id="cb29-598"><a href="#cb29-598" aria-hidden="true" tabindex="-1"></a><span class="in">    ungroup() |&gt; </span></span>
<span id="cb29-599"><a href="#cb29-599" aria-hidden="true" tabindex="-1"></a><span class="in">    pull(log_lik) |&gt;</span></span>
<span id="cb29-600"><a href="#cb29-600" aria-hidden="true" tabindex="-1"></a><span class="in">    sum(na.rm = TRUE)</span></span>
<span id="cb29-601"><a href="#cb29-601" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb29-602"><a href="#cb29-602" aria-hidden="true" tabindex="-1"></a><span class="in">  # return log likelihood sum</span></span>
<span id="cb29-603"><a href="#cb29-603" aria-hidden="true" tabindex="-1"></a><span class="in">  return(log_lik_sum)</span></span>
<span id="cb29-604"><a href="#cb29-604" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb29-605"><a href="#cb29-605" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-606"><a href="#cb29-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-607"><a href="#cb29-607" aria-hidden="true" tabindex="-1"></a>Testing this function quickly confirms consistency of the obtained summed up likelihood with the previous result from the table (see above):</span>
<span id="cb29-608"><a href="#cb29-608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-611"><a href="#cb29-611" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb29-612"><a href="#cb29-612" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate likelihood</span></span>
<span id="cb29-613"><a href="#cb29-613" aria-hidden="true" tabindex="-1"></a><span class="fu">log_likelihood_fun_multiple</span>(</span>
<span id="cb29-614"><a href="#cb29-614" aria-hidden="true" tabindex="-1"></a>  <span class="at">df =</span> sim_data_id5,</span>
<span id="cb29-615"><a href="#cb29-615" aria-hidden="true" tabindex="-1"></a>  <span class="at">eta_i =</span> <span class="dv">0</span>,</span>
<span id="cb29-616"><a href="#cb29-616" aria-hidden="true" tabindex="-1"></a>  <span class="at">mod_par =</span> mod_par</span>
<span id="cb29-617"><a href="#cb29-617" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-618"><a href="#cb29-618" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-619"><a href="#cb29-619" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-620"><a href="#cb29-620" aria-hidden="true" tabindex="-1"></a>Now, we can visualize the likelihood term across a range of $\eta_i$ values, similar to what we have did for the prior term:</span>
<span id="cb29-621"><a href="#cb29-621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-624"><a href="#cb29-624" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb29-625"><a href="#cb29-625" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-likelihood-term</span></span>
<span id="cb29-626"><a href="#cb29-626" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Likelihood of different random effects given the observed datapoints of our exemplary individual."</span></span>
<span id="cb29-627"><a href="#cb29-627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-628"><a href="#cb29-628" aria-hidden="true" tabindex="-1"></a><span class="co"># define range</span></span>
<span id="cb29-629"><a href="#cb29-629" aria-hidden="true" tabindex="-1"></a>eta_i <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">2</span>, <span class="dv">2</span>, <span class="fl">0.01</span>)</span>
<span id="cb29-630"><a href="#cb29-630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-631"><a href="#cb29-631" aria-hidden="true" tabindex="-1"></a><span class="co"># empty list</span></span>
<span id="cb29-632"><a href="#cb29-632" aria-hidden="true" tabindex="-1"></a>ll_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb29-633"><a href="#cb29-633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-634"><a href="#cb29-634" aria-hidden="true" tabindex="-1"></a><span class="co"># loop over each element of eta_i</span></span>
<span id="cb29-635"><a href="#cb29-635" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(cur_eta_i <span class="cf">in</span> eta_i){</span>
<span id="cb29-636"><a href="#cb29-636" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calculate likelihood term</span></span>
<span id="cb29-637"><a href="#cb29-637" aria-hidden="true" tabindex="-1"></a>  ll_list[[<span class="fu">as.character</span>(cur_eta_i)]] <span class="ot">&lt;-</span> <span class="fu">log_likelihood_fun_multiple</span>(</span>
<span id="cb29-638"><a href="#cb29-638" aria-hidden="true" tabindex="-1"></a>    <span class="at">df =</span> sim_data_id5,</span>
<span id="cb29-639"><a href="#cb29-639" aria-hidden="true" tabindex="-1"></a>    <span class="at">eta_i =</span> cur_eta_i,</span>
<span id="cb29-640"><a href="#cb29-640" aria-hidden="true" tabindex="-1"></a>    <span class="at">mod_par =</span> mod_par</span>
<span id="cb29-641"><a href="#cb29-641" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb29-642"><a href="#cb29-642" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-643"><a href="#cb29-643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-644"><a href="#cb29-644" aria-hidden="true" tabindex="-1"></a><span class="co"># convert to vector</span></span>
<span id="cb29-645"><a href="#cb29-645" aria-hidden="true" tabindex="-1"></a>ll_vector <span class="ot">&lt;-</span> ll_list <span class="sc">|&gt;</span> <span class="fu">unlist</span>() <span class="sc">|&gt;</span> <span class="fu">unname</span>()</span>
<span id="cb29-646"><a href="#cb29-646" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-647"><a href="#cb29-647" aria-hidden="true" tabindex="-1"></a><span class="co"># create tibble</span></span>
<span id="cb29-648"><a href="#cb29-648" aria-hidden="true" tabindex="-1"></a>likelihood_tibble <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb29-649"><a href="#cb29-649" aria-hidden="true" tabindex="-1"></a>  <span class="at">eta_i =</span> eta_i,</span>
<span id="cb29-650"><a href="#cb29-650" aria-hidden="true" tabindex="-1"></a>  <span class="at">p =</span> ll_vector,</span>
<span id="cb29-651"><a href="#cb29-651" aria-hidden="true" tabindex="-1"></a>  <span class="at">source =</span> <span class="st">"likelihood"</span></span>
<span id="cb29-652"><a href="#cb29-652" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-653"><a href="#cb29-653" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-654"><a href="#cb29-654" aria-hidden="true" tabindex="-1"></a><span class="co"># plot likelihood term</span></span>
<span id="cb29-655"><a href="#cb29-655" aria-hidden="true" tabindex="-1"></a>likelihood_tibble <span class="sc">|&gt;</span> </span>
<span id="cb29-656"><a href="#cb29-656" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>eta_i, <span class="at">y=</span><span class="fu">exp</span>(p)))<span class="sc">+</span></span>
<span id="cb29-657"><a href="#cb29-657" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"darkred"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>)<span class="sc">+</span></span>
<span id="cb29-658"><a href="#cb29-658" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> eta_i[<span class="fu">which.max</span>(ll_vector)], <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"darkred"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>)<span class="sc">+</span></span>
<span id="cb29-659"><a href="#cb29-659" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb29-660"><a href="#cb29-660" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">expression</span>(eta[i]),</span>
<span id="cb29-661"><a href="#cb29-661" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Likelihood"</span>,</span>
<span id="cb29-662"><a href="#cb29-662" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Likelihood term"</span></span>
<span id="cb29-663"><a href="#cb29-663" aria-hidden="true" tabindex="-1"></a>  )<span class="sc">+</span></span>
<span id="cb29-664"><a href="#cb29-664" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb29-665"><a href="#cb29-665" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-666"><a href="#cb29-666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-667"><a href="#cb29-667" aria-hidden="true" tabindex="-1"></a>The likelihood plot clearly indicates which $\eta_i$ values best describe the observed data. Identifying the maximum likelihood $\eta_i$ is straightforward:</span>
<span id="cb29-668"><a href="#cb29-668" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-671"><a href="#cb29-671" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb29-672"><a href="#cb29-672" aria-hidden="true" tabindex="-1"></a><span class="co"># get eta_i with highest likelihood</span></span>
<span id="cb29-673"><a href="#cb29-673" aria-hidden="true" tabindex="-1"></a>eta_i_max_likelihood <span class="ot">&lt;-</span> eta_i[<span class="fu">which.max</span>(ll_vector)]</span>
<span id="cb29-674"><a href="#cb29-674" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-675"><a href="#cb29-675" aria-hidden="true" tabindex="-1"></a><span class="co"># show</span></span>
<span id="cb29-676"><a href="#cb29-676" aria-hidden="true" tabindex="-1"></a>eta_i_max_likelihood</span>
<span id="cb29-677"><a href="#cb29-677" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-678"><a href="#cb29-678" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-679"><a href="#cb29-679" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-680"><a href="#cb29-680" aria-hidden="true" tabindex="-1"></a>The optimal $\eta_i$ value according to the likelihood term (and ignoring any prior information) is <span class="in">`r eta_i_max_likelihood`</span>. Please note: As the likelihood is the product of many probabilities, each between 0 and 1, we typically deal with extremely small numerical values. Therefore, it is common practice to use logarithmic transformations for numerical stability. Next, we combine the prior and likelihood terms to perform MAP estimation.</span>
<span id="cb29-681"><a href="#cb29-681" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-682"><a href="#cb29-682" aria-hidden="true" tabindex="-1"></a><span class="fu">## MAP estimation (posterior) {#map-rrepro-mapestim}</span></span>
<span id="cb29-683"><a href="#cb29-683" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-684"><a href="#cb29-684" aria-hidden="true" tabindex="-1"></a>We now have to define an objective function for numerical optimization, combining prior and likelihood terms to estimate the posterior (as shown in @eq-map-final).</span>
<span id="cb29-685"><a href="#cb29-685" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-686"><a href="#cb29-686" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-687"><a href="#cb29-687" aria-hidden="true" tabindex="-1"></a><span class="in">```{r filename="function: map_obj_fun()"}</span></span>
<span id="cb29-688"><a href="#cb29-688" aria-hidden="true" tabindex="-1"></a><span class="in">#| echo: true</span></span>
<span id="cb29-689"><a href="#cb29-689" aria-hidden="true" tabindex="-1"></a><span class="in">#| collapse: false</span></span>
<span id="cb29-690"><a href="#cb29-690" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: false</span></span>
<span id="cb29-691"><a href="#cb29-691" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-692"><a href="#cb29-692" aria-hidden="true" tabindex="-1"></a><span class="in"># define MAP estimation objective function</span></span>
<span id="cb29-693"><a href="#cb29-693" aria-hidden="true" tabindex="-1"></a><span class="in">map_obj_fun &lt;- function(eta_i, df, mod_par){</span></span>
<span id="cb29-694"><a href="#cb29-694" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb29-695"><a href="#cb29-695" aria-hidden="true" tabindex="-1"></a><span class="in">  # calculate log prior term</span></span>
<span id="cb29-696"><a href="#cb29-696" aria-hidden="true" tabindex="-1"></a><span class="in">  log_prior &lt;- prior_fun(</span></span>
<span id="cb29-697"><a href="#cb29-697" aria-hidden="true" tabindex="-1"></a><span class="in">    eta_i = eta_i, </span></span>
<span id="cb29-698"><a href="#cb29-698" aria-hidden="true" tabindex="-1"></a><span class="in">    mod_par = mod_par</span></span>
<span id="cb29-699"><a href="#cb29-699" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb29-700"><a href="#cb29-700" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb29-701"><a href="#cb29-701" aria-hidden="true" tabindex="-1"></a><span class="in">  # calculate log likelihood term</span></span>
<span id="cb29-702"><a href="#cb29-702" aria-hidden="true" tabindex="-1"></a><span class="in">  log_likelihood &lt;- log_likelihood_fun_multiple(</span></span>
<span id="cb29-703"><a href="#cb29-703" aria-hidden="true" tabindex="-1"></a><span class="in">    df = df,</span></span>
<span id="cb29-704"><a href="#cb29-704" aria-hidden="true" tabindex="-1"></a><span class="in">    eta_i = eta_i,</span></span>
<span id="cb29-705"><a href="#cb29-705" aria-hidden="true" tabindex="-1"></a><span class="in">    mod_par = mod_par</span></span>
<span id="cb29-706"><a href="#cb29-706" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb29-707"><a href="#cb29-707" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb29-708"><a href="#cb29-708" aria-hidden="true" tabindex="-1"></a><span class="in">  # combine both</span></span>
<span id="cb29-709"><a href="#cb29-709" aria-hidden="true" tabindex="-1"></a><span class="in">  log_posterior &lt;- log_prior + log_likelihood</span></span>
<span id="cb29-710"><a href="#cb29-710" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb29-711"><a href="#cb29-711" aria-hidden="true" tabindex="-1"></a><span class="in">  # return negative log posterior</span></span>
<span id="cb29-712"><a href="#cb29-712" aria-hidden="true" tabindex="-1"></a><span class="in">  return(-log_posterior)</span></span>
<span id="cb29-713"><a href="#cb29-713" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb29-714"><a href="#cb29-714" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-715"><a href="#cb29-715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-716"><a href="#cb29-716" aria-hidden="true" tabindex="-1"></a>Please note that we are returning the negative log posterior as it is easier to minimize a function than to maximize it. Using R's <span class="in">`optim`</span> function, we estimate the MAP numerically. Here is the output form the <span class="in">`optim`</span> call:</span>
<span id="cb29-717"><a href="#cb29-717" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-720"><a href="#cb29-720" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb29-721"><a href="#cb29-721" aria-hidden="true" tabindex="-1"></a><span class="co"># run optimization</span></span>
<span id="cb29-722"><a href="#cb29-722" aria-hidden="true" tabindex="-1"></a>map_est <span class="ot">&lt;-</span> <span class="fu">optim</span>(</span>
<span id="cb29-723"><a href="#cb29-723" aria-hidden="true" tabindex="-1"></a>  <span class="at">par =</span> <span class="dv">0</span>, </span>
<span id="cb29-724"><a href="#cb29-724" aria-hidden="true" tabindex="-1"></a>  <span class="at">fn =</span> map_obj_fun, </span>
<span id="cb29-725"><a href="#cb29-725" aria-hidden="true" tabindex="-1"></a>  <span class="at">df =</span> sim_data_id5,</span>
<span id="cb29-726"><a href="#cb29-726" aria-hidden="true" tabindex="-1"></a>  <span class="at">mod_par =</span> mod_par,</span>
<span id="cb29-727"><a href="#cb29-727" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"BFGS"</span></span>
<span id="cb29-728"><a href="#cb29-728" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-729"><a href="#cb29-729" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-730"><a href="#cb29-730" aria-hidden="true" tabindex="-1"></a><span class="co"># show estimation results</span></span>
<span id="cb29-731"><a href="#cb29-731" aria-hidden="true" tabindex="-1"></a>map_est </span>
<span id="cb29-732"><a href="#cb29-732" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-733"><a href="#cb29-733" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-734"><a href="#cb29-734" aria-hidden="true" tabindex="-1"></a>The resulting MAP estimate for $\eta_i$ is <span class="in">`r map_est$par`</span>, closely matching the reference solution (<span class="in">`r nm_out$ETA1 |&gt; unique()`</span>) with an acceptable difference (<span class="in">`r format(map_est$par - (nm_out$ETA1 |&gt; unique()), scientific = FALSE)`</span>). Similarly to the other terms, we can visualize the posterior term across a range of $\eta_i$ values:</span>
<span id="cb29-735"><a href="#cb29-735" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-736"><a href="#cb29-736" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-739"><a href="#cb29-739" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb29-740"><a href="#cb29-740" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-posterior-term</span></span>
<span id="cb29-741"><a href="#cb29-741" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "The unnormalized posterior density."</span></span>
<span id="cb29-742"><a href="#cb29-742" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-743"><a href="#cb29-743" aria-hidden="true" tabindex="-1"></a><span class="co"># define range</span></span>
<span id="cb29-744"><a href="#cb29-744" aria-hidden="true" tabindex="-1"></a>eta_i <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">2</span>, <span class="dv">2</span>, <span class="fl">0.01</span>)</span>
<span id="cb29-745"><a href="#cb29-745" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-746"><a href="#cb29-746" aria-hidden="true" tabindex="-1"></a><span class="co"># empty list</span></span>
<span id="cb29-747"><a href="#cb29-747" aria-hidden="true" tabindex="-1"></a>post_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb29-748"><a href="#cb29-748" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-749"><a href="#cb29-749" aria-hidden="true" tabindex="-1"></a><span class="co"># loop over each element of eta_i</span></span>
<span id="cb29-750"><a href="#cb29-750" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(cur_eta_i <span class="cf">in</span> eta_i){</span>
<span id="cb29-751"><a href="#cb29-751" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calculate likelihood term</span></span>
<span id="cb29-752"><a href="#cb29-752" aria-hidden="true" tabindex="-1"></a>  post_list[[<span class="fu">as.character</span>(cur_eta_i)]] <span class="ot">&lt;-</span> <span class="fu">map_obj_fun</span>(</span>
<span id="cb29-753"><a href="#cb29-753" aria-hidden="true" tabindex="-1"></a>    <span class="at">eta_i =</span> cur_eta_i,</span>
<span id="cb29-754"><a href="#cb29-754" aria-hidden="true" tabindex="-1"></a>    <span class="at">df =</span> sim_data_id5,</span>
<span id="cb29-755"><a href="#cb29-755" aria-hidden="true" tabindex="-1"></a>    <span class="at">mod_par =</span> mod_par</span>
<span id="cb29-756"><a href="#cb29-756" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb29-757"><a href="#cb29-757" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-758"><a href="#cb29-758" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-759"><a href="#cb29-759" aria-hidden="true" tabindex="-1"></a><span class="co"># convert to vector</span></span>
<span id="cb29-760"><a href="#cb29-760" aria-hidden="true" tabindex="-1"></a>post_vector <span class="ot">&lt;-</span> post_list <span class="sc">|&gt;</span> <span class="fu">unlist</span>() <span class="sc">|&gt;</span> <span class="fu">unname</span>()</span>
<span id="cb29-761"><a href="#cb29-761" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-762"><a href="#cb29-762" aria-hidden="true" tabindex="-1"></a><span class="co"># create tibble</span></span>
<span id="cb29-763"><a href="#cb29-763" aria-hidden="true" tabindex="-1"></a>posterior_tibble <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb29-764"><a href="#cb29-764" aria-hidden="true" tabindex="-1"></a>  <span class="at">eta_i =</span> eta_i,</span>
<span id="cb29-765"><a href="#cb29-765" aria-hidden="true" tabindex="-1"></a>  <span class="at">p =</span> <span class="sc">-</span>post_vector,</span>
<span id="cb29-766"><a href="#cb29-766" aria-hidden="true" tabindex="-1"></a>  <span class="at">source =</span> <span class="st">"posterior"</span></span>
<span id="cb29-767"><a href="#cb29-767" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-768"><a href="#cb29-768" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-769"><a href="#cb29-769" aria-hidden="true" tabindex="-1"></a><span class="co"># plot likelihood term</span></span>
<span id="cb29-770"><a href="#cb29-770" aria-hidden="true" tabindex="-1"></a>posterior_tibble <span class="sc">|&gt;</span> </span>
<span id="cb29-771"><a href="#cb29-771" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>eta_i, <span class="at">y=</span><span class="fu">exp</span>(p)))<span class="sc">+</span></span>
<span id="cb29-772"><a href="#cb29-772" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"darkgreen"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>)<span class="sc">+</span></span>
<span id="cb29-773"><a href="#cb29-773" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> map_est<span class="sc">$</span>par, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"darkgreen"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>)<span class="sc">+</span></span>
<span id="cb29-774"><a href="#cb29-774" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb29-775"><a href="#cb29-775" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">expression</span>(eta[i]),</span>
<span id="cb29-776"><a href="#cb29-776" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Unnormalized posterior density"</span>,</span>
<span id="cb29-777"><a href="#cb29-777" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Posterior distribution"</span></span>
<span id="cb29-778"><a href="#cb29-778" aria-hidden="true" tabindex="-1"></a>  )<span class="sc">+</span></span>
<span id="cb29-779"><a href="#cb29-779" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb29-780"><a href="#cb29-780" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-781"><a href="#cb29-781" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-782"><a href="#cb29-782" aria-hidden="true" tabindex="-1"></a><span class="fu">## Comparison of prior, likelihood, and posterior {#sec-map-rrepro-comp} </span></span>
<span id="cb29-783"><a href="#cb29-783" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-784"><a href="#cb29-784" aria-hidden="true" tabindex="-1"></a>Finally, we compare the MAP estimate (mode of the posterior) with prior and likelihood terms visually:</span>
<span id="cb29-785"><a href="#cb29-785" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-788"><a href="#cb29-788" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb29-789"><a href="#cb29-789" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-comparison-prior-ll-post-term</span></span>
<span id="cb29-790"><a href="#cb29-790" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Comparison of prior, likelihood, and posterior."</span></span>
<span id="cb29-791"><a href="#cb29-791" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-792"><a href="#cb29-792" aria-hidden="true" tabindex="-1"></a><span class="co"># combine likelihood and prior</span></span>
<span id="cb29-793"><a href="#cb29-793" aria-hidden="true" tabindex="-1"></a>comp_tibble <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb29-794"><a href="#cb29-794" aria-hidden="true" tabindex="-1"></a>  prior_tibble,</span>
<span id="cb29-795"><a href="#cb29-795" aria-hidden="true" tabindex="-1"></a>  likelihood_tibble,</span>
<span id="cb29-796"><a href="#cb29-796" aria-hidden="true" tabindex="-1"></a>  posterior_tibble</span>
<span id="cb29-797"><a href="#cb29-797" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb29-798"><a href="#cb29-798" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">source =</span> <span class="fu">factor</span>(source, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"prior"</span>, <span class="st">"posterior"</span>, <span class="st">"likelihood"</span>)))</span>
<span id="cb29-799"><a href="#cb29-799" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-800"><a href="#cb29-800" aria-hidden="true" tabindex="-1"></a><span class="co"># define linewidth</span></span>
<span id="cb29-801"><a href="#cb29-801" aria-hidden="true" tabindex="-1"></a>linewidth <span class="ot">&lt;-</span> <span class="fl">0.8</span></span>
<span id="cb29-802"><a href="#cb29-802" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-803"><a href="#cb29-803" aria-hidden="true" tabindex="-1"></a><span class="co"># plot both distributions with different colors and fill</span></span>
<span id="cb29-804"><a href="#cb29-804" aria-hidden="true" tabindex="-1"></a>comp_tibble <span class="sc">|&gt;</span>  </span>
<span id="cb29-805"><a href="#cb29-805" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>eta_i, <span class="at">y=</span><span class="fu">exp</span>(p), <span class="at">fill =</span> source, <span class="at">color =</span> source))<span class="sc">+</span></span>
<span id="cb29-806"><a href="#cb29-806" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">2</span>,<span class="sc">-</span><span class="dv">1</span>,<span class="dv">0</span>, <span class="fu">signif</span>(map_est<span class="sc">$</span>par,<span class="dv">2</span>), <span class="fu">signif</span>(eta_i_max_likelihood,<span class="dv">2</span>), <span class="dv">2</span>))<span class="sc">+</span></span>
<span id="cb29-807"><a href="#cb29-807" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> linewidth)<span class="sc">+</span></span>
<span id="cb29-808"><a href="#cb29-808" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(</span>
<span id="cb29-809"><a href="#cb29-809" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">data.frame</span>(<span class="at">source =</span> <span class="fu">factor</span>(<span class="st">"prior"</span>, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"prior"</span>, <span class="st">"posterior"</span>, <span class="st">"likelihood"</span>))),</span>
<span id="cb29-810"><a href="#cb29-810" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">xintercept =</span> <span class="dv">0</span>),</span>
<span id="cb29-811"><a href="#cb29-811" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"darkblue"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">linewidth =</span> linewidth</span>
<span id="cb29-812"><a href="#cb29-812" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb29-813"><a href="#cb29-813" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(</span>
<span id="cb29-814"><a href="#cb29-814" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">data.frame</span>(<span class="at">source =</span> <span class="fu">factor</span>(<span class="st">"posterior"</span>, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"prior"</span>, <span class="st">"posterior"</span>, <span class="st">"likelihood"</span>))),</span>
<span id="cb29-815"><a href="#cb29-815" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">xintercept =</span> map_est<span class="sc">$</span>par),</span>
<span id="cb29-816"><a href="#cb29-816" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"darkgreen"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">linewidth =</span> linewidth</span>
<span id="cb29-817"><a href="#cb29-817" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb29-818"><a href="#cb29-818" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(</span>
<span id="cb29-819"><a href="#cb29-819" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">data.frame</span>(<span class="at">source =</span> <span class="fu">factor</span>(<span class="st">"likelihood"</span>, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"prior"</span>, <span class="st">"posterior"</span>, <span class="st">"likelihood"</span>))),</span>
<span id="cb29-820"><a href="#cb29-820" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">xintercept =</span> eta_i_max_likelihood),</span>
<span id="cb29-821"><a href="#cb29-821" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"darkred"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">linewidth =</span> linewidth</span>
<span id="cb29-822"><a href="#cb29-822" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb29-823"><a href="#cb29-823" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="at">prior =</span> <span class="st">"darkblue"</span>, </span>
<span id="cb29-824"><a href="#cb29-824" aria-hidden="true" tabindex="-1"></a>                                <span class="at">posterior =</span> <span class="st">"darkgreen"</span>, </span>
<span id="cb29-825"><a href="#cb29-825" aria-hidden="true" tabindex="-1"></a>                                <span class="at">likelihood =</span> <span class="st">"darkred"</span>)) <span class="sc">+</span></span>
<span id="cb29-826"><a href="#cb29-826" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>source, <span class="at">scales =</span> <span class="st">"free"</span>, <span class="at">ncol =</span> <span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb29-827"><a href="#cb29-827" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb29-828"><a href="#cb29-828" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">expression</span>(eta[i]),</span>
<span id="cb29-829"><a href="#cb29-829" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"(Unnormalized) probability density"</span>,</span>
<span id="cb29-830"><a href="#cb29-830" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Comparison of prior, likelihood, and posterior"</span>,</span>
<span id="cb29-831"><a href="#cb29-831" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Source"</span></span>
<span id="cb29-832"><a href="#cb29-832" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb29-833"><a href="#cb29-833" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb29-834"><a href="#cb29-834" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span>
<span id="cb29-835"><a href="#cb29-835" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-836"><a href="#cb29-836" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-837"><a href="#cb29-837" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-838"><a href="#cb29-838" aria-hidden="true" tabindex="-1"></a>This clearly demonstrates how the posterior is influenced by both the prior and the likelihood, with the MAP estimate (mode of the posterior, green dashed line) reflecting a balance between these two sources of information.</span>
<span id="cb29-839"><a href="#cb29-839" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-840"><a href="#cb29-840" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-841"><a href="#cb29-841" aria-hidden="true" tabindex="-1"></a><span class="fu"># Conclusion {#map-rrepro-conclusion}</span></span>
<span id="cb29-842"><a href="#cb29-842" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-843"><a href="#cb29-843" aria-hidden="true" tabindex="-1"></a>This simple example illustrates how to estimate the individual parameter $\eta_i$ (which translates to an individual clearance $CL_i$) for a single subject using a Bayesian approach. We have seen that the posterior distribution, often summarized by its mode (the MAP or EBE estimate), represents a compromise between the prior and the likelihood. This powerful technique enables the continuous integration of prior knowledge with new data and is very useful for many pharmacometric workflows. With that, I conclude this blog post and hope you enjoyed it. If you have any questions or feedback, please feel free to leave a comment.</span>
<span id="cb29-844"><a href="#cb29-844" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-845"><a href="#cb29-845" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-846"><a href="#cb29-846" aria-hidden="true" tabindex="-1"></a><span class="ot">[^1]: </span>*MAP* estimates are also known as *Empirical Bayes Estimates* (EBE).</span>
<span id="cb29-847"><a href="#cb29-847" aria-hidden="true" tabindex="-1"></a><span class="ot">[^2]: </span>Depending on the estimation algorithm.</span>
<span id="cb29-848"><a href="#cb29-848" aria-hidden="true" tabindex="-1"></a><span class="ot">[^3]: </span>The dense sampling in combination with a simple additive error model for RUV led to a scenario where the posterior was nearly equal to the likelihood. Therefore, I have increased the additive error and introduced a proportional term as well. This places the posterior in the middle and I can recycle the old dataset I have simulated before. </span>
<span id="cb29-849"><a href="#cb29-849" aria-hidden="true" tabindex="-1"></a><span class="ot">[^4]: </span>Actually, this took me quite some time to figure out. I was using the model from the previous blogpost, which only had an additive error and was missing the <span class="in">`INTERACTION`</span> option (which doesn't matter if you are just using a constant additive error). With the newly introduced proportional error, I then had a mismatch between my calculations and the reference and I couldn't figure out why. The missing <span class="in">`INTERACTION`</span> was the solution, as with the introduction of the proportional error the RUV does not remain constant (which NONMEM is assuming when <span class="in">`INTERACTION`</span> is missing). Lesson learned!</span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>