<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Marian Klose">
<meta name="dcterms.date" content="2025-07-31">
<meta name="description" content="Supercharging LLMs by building agentic workflows.">

<title>Using ChatGPT from the command line – Marian Klose</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../img/favicon.ico" rel="icon">
<script src="../../site_libs/cookie-consent/cookie-consent.js"></script>
<link href="../../site_libs/cookie-consent/cookie-consent.css" rel="stylesheet">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-e31584831b205ffbb2d98406f31c2a5b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-1YZKR6EN7R"></script>

<script type="text/plain" cookie-consent="tracking">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-1YZKR6EN7R', { 'anonymize_ip': true});
</script>

<script type="text/javascript" charset="UTF-8">
document.addEventListener('DOMContentLoaded', function () {
cookieconsent.run({
  "notice_banner_type":"simple",
  "consent_type":"express",
  "palette":"light",
  "language":"en",
  "page_load_consent_levels":["strictly-necessary"],
  "notice_banner_reject_button_hide":false,
  "preferences_center_close_button_hide":false,
  "website_name":""
  ,
"language":"en"
  });
});
</script> 
  


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Marian Klose</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../publications/publications.html"> 
<span class="menu-text">Publications</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../cv/cv.html"> 
<span class="menu-text">CV</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../posts.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">Using ChatGPT from the command line</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
                  <div>
        <div class="description">
          Supercharging LLMs by building agentic workflows.
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">ChatGPT</div>
                <div class="quarto-category">openai</div>
                <div class="quarto-category">LLM</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p><a href="https://github.com/marianklose">Marian Klose</a> <a href="https://orcid.org/0009-0005-1706-6289" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">July 31, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#prologue" id="toc-prologue" class="nav-link active" data-scroll-target="#prologue">Prologue</a>
  <ul class="collapse">
  <li><a href="#motivation" id="toc-motivation" class="nav-link" data-scroll-target="#motivation">Motivation</a></li>
  <li><a href="#why-python" id="toc-why-python" class="nav-link" data-scroll-target="#why-python">Why python?</a></li>
  </ul></li>
  <li><a href="#setup" id="toc-setup" class="nav-link" data-scroll-target="#setup">Setup</a>
  <ul class="collapse">
  <li><a href="#creating-an-account" id="toc-creating-an-account" class="nav-link" data-scroll-target="#creating-an-account">Creating an account</a></li>
  <li><a href="#retrieve-your-api-key" id="toc-retrieve-your-api-key" class="nav-link" data-scroll-target="#retrieve-your-api-key">Retrieve your API key</a></li>
  <li><a href="#saving-your-api-key-as-an-environmental-variable" id="toc-saving-your-api-key-as-an-environmental-variable" class="nav-link" data-scroll-target="#saving-your-api-key-as-an-environmental-variable">Saving your API key as an environmental variable</a></li>
  <li><a href="#setting-up-python" id="toc-setting-up-python" class="nav-link" data-scroll-target="#setting-up-python">Setting up Python</a></li>
  </ul></li>
  <li><a href="#our-first-prompt" id="toc-our-first-prompt" class="nav-link" data-scroll-target="#our-first-prompt">Our first prompt</a></li>
  <li><a href="#custom-instructions" id="toc-custom-instructions" class="nav-link" data-scroll-target="#custom-instructions">Custom instructions</a></li>
  <li><a href="#structured-outputs" id="toc-structured-outputs" class="nav-link" data-scroll-target="#structured-outputs">Structured outputs</a></li>
  <li><a href="#a-pharmacometric-example" id="toc-a-pharmacometric-example" class="nav-link" data-scroll-target="#a-pharmacometric-example">A pharmacometric example</a></li>
  <li><a href="#agentic-workflows" id="toc-agentic-workflows" class="nav-link" data-scroll-target="#agentic-workflows">Agentic workflows</a></li>
  <li><a href="#epilogue" id="toc-epilogue" class="nav-link" data-scroll-target="#epilogue">Epilogue</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<section id="prologue" class="level1">
<h1>Prologue</h1>
<section id="motivation" class="level2">
<h2 class="anchored" data-anchor-id="motivation">Motivation</h2>
<p>Large language models (LLMs) are sneaking more and more into our daily workflows. There is surely a debate whether they deserve the hype, but in general they seem to be quite useful for low-risk but repetitive tasks that tend to eat up our time and focus. While we can use the graphical user interface to run these models, a more effective and much more powerful way is to run them directly from the command line using R or Python. By doing so we can supercharge their usefulness and create tailored, automated solutions for our specific solutions without the pain of clicking through a web interface. I have recently digged a bit into this topic and I am surely still scratching the surface of what is possible. In this post, I’ll simply walk through my first steps using ChatGPT from the command line in Python, and highlight a few features/funcitons that I found helpful. In the end, we will have a very simplistic agentic workflow that is able to extract structured information from some NONMEM model code. Sounds good? Let’s get started!</p>
</section>
<section id="why-python" class="level2">
<h2 class="anchored" data-anchor-id="why-python">Why python?</h2>
<p>OpenAI provides official Software Development Kits (SDKs) for interacting with their API in several programming languages, such as JavaScript and Python. These SDKs make sending requests and processing responses relatively painless and have the official support of OpenAI. While Python is not super popular in our pharmacometric community and also I am personally much more more comfortable in R, I chose Python for these kind of tasks. The existence of a well-maintained, well-documented and ready-to-use SDK simply makes our lives much easier. You can interact with their API directly via raw HTTP requests, but I guess that is just painful and comes with a lot of overhead.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="snake.jpg" class="img-fluid figure-img"></p>
<figcaption>A snake, not Python.</figcaption>
</figure>
</div>
<p>For those wanting to stick to R, there’s also the promising <a href="https://ellmer.tidyverse.org/">ellmer package</a> which has been recently released. It integrates LLM access directly into the <code>tidyverse</code> ecosystem (which we all love). I haven’t tried it out yet, but it could become a very attractive option for R users. Currently they are in version <code>0.3.0</code> and I guess there is still a lot of development happening, but with the support of Posit and the tidyverse development team it will surely be a great option in the future! Feel free to comment if you have gathered some experience.</p>
</section>
</section>
<section id="setup" class="level1">
<h1>Setup</h1>
<p>Let’s start with the essentials. For the setup, we’ll essentially follow OpenAI’s official <a href="https://platform.openai.com/docs/quickstart?language-preference=python">Quickstart guide for developers</a>.</p>
<p>Because the documentation may change over time, I guess referring directly to that guide is more robust than relying on any hard-coded details I would include here. Luckily their documentation is great and I found it quite easy to get started.</p>
<section id="creating-an-account" class="level2">
<h2 class="anchored" data-anchor-id="creating-an-account">Creating an account</h2>
<p>If we want to access ChatGPT from the command line, we first need an OpenAI account. We can simply head to the <a href="https://platform.openai.com/signup">OpenAI platform</a> and create an account. So far, creating an account is free. However, once we start sending prompts via our API key, usage will be billed. For our use-cases this will just be a couple of cents, and you can always check the expected billing in your dashboard.</p>
</section>
<section id="retrieve-your-api-key" class="level2">
<h2 class="anchored" data-anchor-id="retrieve-your-api-key">Retrieve your API key</h2>
<p>If we want to use ChatGPT from the command line, we will have to authenticate ourselves so that OpenAI knows whom to bill. An API key is a long, random string used to authenticate and authorize access to the API. Think of it like a password (and handle it with the same care to avoid excessive bills from some stranger). Since every prompt we send incurs a (usually small) cost, we don’t want to share our API keys with anyone. Once we’ve successfully created the account, we can now generate an API key at <a href="https://platform.openai.com/api-keys">this page of the dashboard</a>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="api_keys.png" class="img-fluid figure-img"></p>
<figcaption>A screenshot of the API keys dashboard.</figcaption>
</figure>
</div>
<p>From the screenshot, you can see that I have an API key for my laptop starting with <code>sk-....YLUA</code>. Now we have to make it accessible to Python, so we can authenticate ourselves when making requests.</p>
</section>
<section id="saving-your-api-key-as-an-environmental-variable" class="level2">
<h2 class="anchored" data-anchor-id="saving-your-api-key-as-an-environmental-variable">Saving your API key as an environmental variable</h2>
<p>We want to avoid typing the API key each time or hard-coding it into a script. Hard-coding it would be like pasting a password in plain text or putting it on a post-it somewhere. A much safer approach is to store the API key as an environment variable (and there are even safer options). On Windows, we can do this by searching for <em>System environment variables</em> in the Windows search bar or we simply use PowerShell to set it:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>powershell</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>setx OPENAI_API_KEY <span class="st">"your_api_key_here"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
<p>We have to make sure to name the environment variable exactly <code>OPENAI_API_KEY</code>. The openai Python package looks for this specific name when we initialize it to link the prompts to our account. Very nice, our API key is ready to be used!</p>
</section>
<section id="setting-up-python" class="level2">
<h2 class="anchored" data-anchor-id="setting-up-python">Setting up Python</h2>
<p>I won’t go into the details of installing Python itself, as there are many excellent tutorials out there for that. Of course we have to take care of some packages and dependencies, and we install it with Python’s package installer <code>pip</code>:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>powershell</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>pip install openai</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
<p>And that’s it! We’ve now installed the OpenAI package and set up our API key as an environment variable. Next, we can move on to sending our first prompt.</p>
</section>
</section>
<section id="our-first-prompt" class="level1">
<h1>Our first prompt</h1>
<p>Sending a request to ChatGPT from the command line is surprisingly straightforward. Let’s walk through it step by step. First, we load our packages and initialize the OpenAI client:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>python</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load packages</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> openai <span class="im">import</span> OpenAI</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co"># initialize openai client</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>client <span class="op">=</span> OpenAI()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
<p>By initializing the client by calling <code>OpenAI()</code>, Python will look for the <code>OPENAI_API_KEY</code> environmental variable and get the client started. Now we can already send our first prompt. Here, we’ll use the <code>gpt-4o</code> model, but <a href="https://platform.openai.com/docs/models">many other models</a> are available.</p>
<p>Notably, we’ll use the <code>Responses API</code>, which is newer than the <code>Chat Completions API</code>. OpenAI has stated that Chat Completions will remain supported, but future features will likely appear first in the Responses API. The general idea is the same, though the syntax differs slightly.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>python</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># send request</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> client.responses.create(</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"gpt-4o"</span>,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">input</span><span class="op">=</span><span class="st">"Write a short joke about pharmacokinetics."</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
<p>Notice that we’re providing input only as a single text string here. This mirrors what we often do in the graphical user interface. In more advanced use cases, we can also define multiple roles:</p>
<ul>
<li><strong>System</strong>: sets the model’s behavior, tone, and style (like giving ChatGPT a personality or a set of instructions).</li>
<li><strong>User</strong>: the actual prompt, just as we’d type in the ChatGPT web interface.</li>
</ul>
<p>This gives us more control and consistency when building automated workflows. We will come back alter to define the system or developer instructions to get more fine-tuned control over the model responses.</p>
<p>Let’s have a look at what the returned object contains:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>python</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># print full object</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(response)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Response(id='resp_02c4bc042c3e5d2b00694b2fd4b508819c8a6a3acc743239f5', created_at=1766535124.0, error=None, incomplete_details=None, instructions=None, metadata={}, model='gpt-4o-2024-08-06', object='response', output=[ResponseOutputMessage(id='msg_02c4bc042c3e5d2b00694b2fd5401c819cb64ee377f3da5f22', content=[ResponseOutputText(annotations=[], text="Why did the molecule break up with the drug?\n\nIt couldn't handle its rate of absorption!", type='output_text', logprobs=[])], role='assistant', status='completed', type='message')], parallel_tool_calls=True, temperature=1.0, tool_choice='auto', tools=[], top_p=1.0, background=False, conversation=None, max_output_tokens=None, max_tool_calls=None, previous_response_id=None, prompt=None, prompt_cache_key=None, prompt_cache_retention=None, reasoning=Reasoning(effort=None, generate_summary=None, summary=None), safety_identifier=None, service_tier='default', status='completed', text=ResponseTextConfig(format=ResponseFormatText(type='text'), verbosity='medium'), top_logprobs=0, truncation='disabled', usage=ResponseUsage(input_tokens=17, input_tokens_details=InputTokensDetails(cached_tokens=0), output_tokens=19, output_tokens_details=OutputTokensDetails(reasoning_tokens=0), total_tokens=36), user=None, billing={'payer': 'developer'}, completed_at=1766535125, store=True)</code></pre>
</div>
</div>
<p>The full object contains a lot of metadata, but in most cases we only care about the generated text. We can retrieve it like this:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>python</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># print object</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(response.output_text)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Why did the molecule break up with the drug?

It couldn't handle its rate of absorption!</code></pre>
</div>
</div>
<p>And there we have it, our first command-line prompt completed and we received a bad joke about pharmacokinetics. Sure, it’s just a joke for now, but the real power will reveal itself soon (hopefully). Next, we’ll look at slightly more advanced features that allow us to make ChatGPT far more useful in our day-to-day workflows.</p>
</section>
<section id="custom-instructions" class="level1">
<h1>Custom instructions</h1>
<p>One of the advantages of the command-line setup over the web interface is the ability to give developer-level instructions. We can pass these via the instructions parameter in <code>client.responses.create()</code>.</p>
<p>According to the documentation, these instructions tell the model how to behave while generating a response, such as tone, goals, formatting, or examples of correct responses. Importantly, they have higher priority than anything written in the input prompt.</p>
<p>These instructions are a major part of prompt engineering, a field that ist quite important to get the expected answers from these models. It gives us much more control over the model’s behavior, especially when we are designing agent-based workflows (see later on) where each “agent” plays a defined and specialized role.</p>
<p>Let’s take a very simple example where we tell the model to explain concepts in short, easy-to-understand sentences. This is in contrast to the often lengthy sentences with which ChatGPT often responds to our requests:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>python</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># send request</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> client.responses.create(</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"gpt-4o"</span>,</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    instructions<span class="op">=</span><span class="st">"You are an experienced teacher who explains concepts in multiple, short sentences with a maximum of 10 words per sentence and simple, easy-to-understand language."</span>,</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">input</span><span class="op">=</span><span class="st">"Explain the role of shrinkage in pharmacometric NLME models."</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="co"># show answer</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>response.output_text</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>‘Shrinkage assesses the accuracy of parameter estimates. NLME models, it estimates how data affects parameter variability. shrinkage indicates limited data influence on random effects. shrinkage suggests more reliable random effect estimates. helps interpret model reliability and predictions. guides model improvement and helps refine data collection.’</p>
</div>
<p>Would I want every explanation in my life phrased like this? Probably not. I just want to make a point here: custom instructions let us shape the output style in a way that is most useful to our actual use-case.</p>
</section>
<section id="structured-outputs" class="level1">
<h1>Structured outputs</h1>
<p>Another, even more powerful API feauture (if you ask me) is <strong>structured outputs</strong>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="structure.jpg" class="img-fluid figure-img"></p>
<figcaption>Structures are important.</figcaption>
</figure>
</div>
<p>As you are probably aware, ChatGPT typically returns free-form text. That’s fine for many tasks but messy for automation or whenever you want to properly postprocess the output of an answer. Structured outputs let us force the model to return data in a predictable format (for example, a numeric value, a JSON object, or a list of parameters). The documentation for structured outputs currently lives <a href="https://platform.openai.com/docs/guides/structured-outputs?api-mode=responses">here</a>, feel free to check it out.</p>
<p>Under the hood, this works via the <code>Pydantic</code> library (for data validation and parsing). We simply define <code>Pydantic</code> classes that describe the output format, then pass this expected output structure to the API call. The model will then return data in exactly that format, allowing us to do any kind of postprocessing. First, we will have to install Pydantic:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>powershell</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>pip install pydantic</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
<p>Then we load the package into our session:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>python</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load packages</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pydantic <span class="im">import</span> BaseModel, Field</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
<p>And now we are able to define the type with which ChatGPT will answer our prompt. For now, we define only a single field in our <code>NumericAnswer</code> class, which is the value. By setting its type to <code>float</code>, ChatGPT will be constrained to return a numeric value such as <code>1.643</code> instead of a text-based response.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>python</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># define class</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> NumericAnswer(BaseModel):</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  value: <span class="bu">float</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
<p>We can now pass this <code>NumericAnswer</code> class to ChatGPT, but this time we use <code>client.responses.parse()</code> which is designed to handle such structured output cases.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>python</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># prompt chatgpt</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> client.responses.parse(</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"gpt-4o"</span>,</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">input</span><span class="op">=</span><span class="st">"What is 14 minus 2?"</span>,</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    text_format<span class="op">=</span>NumericAnswer,</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="co"># show answer</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>response.output_parsed</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>NumericAnswer(value=12.0)</code></pre>
</div>
</div>
<p>We receive an instance of our pre-defined <code>NumericAnswer</code> class as output, which already contains the answer from ChatGPT. In this case it is <code>12.0</code>. This value can be accessed directly using the predefined value key that was specified when the class was created. As confirmed by the <code>type()</code> function, the content is stored as a <code>float</code>, making further postprocessing straightforward.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>python</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># show value</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>response.output_parsed.value</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>12.0</code></pre>
</div>
</div>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>python</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># show type</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span>(response.output_parsed.value)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'float'&gt;</code></pre>
</div>
</div>
<p>This is great, isn’t it? Let’s convert our knowledge into a simple example that is closer to our pharmacometric community.</p>
</section>
<section id="a-pharmacometric-example" class="level1">
<h1>A pharmacometric example</h1>
<p>Let’s say we want to automatically extract parameter names and their initial values from a NONMEM model file. In case you are doing a systematic review of published NONMEM models, you might find a utility like this helpful. Here is our example NONMEM model code, which is taken from <a href="https://pkpd-info.com/NONMEM/Model_templates.php">pkpd-info</a>:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>python</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># define model</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>model_text <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="st">;; 1. Based on: 001</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="st">;; 2. Description: drug</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="st">;; x1. Author: www.pkpd-info.com</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="st">$PROBLEM PK model</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="st">$INPUT  ;; Pas aan naar dataset</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="st">  CENSOR AORTA=DROP ID DATE=DROP TIME AMT EVID MDV TAD DV        </span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="st">$DATA datafile.CSV IGNORE=C </span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="st">$SUBROUTINES </span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="st">  ADVAN3 TRANS4         ;; data 2-comp (iv)</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a><span class="st">$PK                 </span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a><span class="st">  LTVCL = LOG(THETA(3))</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a><span class="st">  MU_1 = LTVCL          ;; MU_1 referencing </span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a><span class="st">  CL =  EXP(MU_1 + ETA(1))</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a><span class="st">  LTVV1 = LOG(THETA(4))</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a><span class="st">  MU_2 = LTVV1</span></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a><span class="st">  V1 = EXP(MU_2 + ETA(2))</span></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a><span class="st">  Q = THETA(5)</span></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a><span class="st">  V2 = THETA(6)</span></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a><span class="st">  S1 = V1</span></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a><span class="st">$THETA              ;; set realistic initial estimates</span></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a><span class="st">  (0, 0.5)  ;1 prop</span></span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a><span class="st">  (0, 0.1)  ;2 add</span></span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a><span class="st">  (0, 30)       ;3 CL</span></span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a><span class="st">  (0, 200)      ;4 V1</span></span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a><span class="st">  (0, 30)       ;5 Q</span></span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a><span class="st">  (0, 200)      ;6 V2</span></span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a><span class="st">$OMEGA BLOCK(2)</span></span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a><span class="st">  0.09      ; IIV-CL</span></span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a><span class="st">  0.01 0.09 ; IIV-V</span></span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a><span class="st">$SIGMA</span></span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a><span class="st">  1 FIX  ;residual variability</span></span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a><span class="st">$ERROR              ;; Based on linear data and proportional and additive error</span></span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a><span class="st">  IPRED = F</span></span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a><span class="st">  IRES = DV-IPRED</span></span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a><span class="st">  W = IPRED*THETA(1)+THETA(2)</span></span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a><span class="st">  IF (W.EQ.0) W = 1</span></span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a><span class="st">  IWRES = IRES/W</span></span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a><span class="st">  Y= IPRED+W*ERR(1)</span></span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a><span class="st">$EST METHOD=1 MAXEVAL=99999 SIG=3 PRINT=5 NOABORT POSTHOC INTERACTION   ;; Estimation method FOCE+interaction</span></span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a><span class="st">$COV PRINT=E UNCONDITIONAL</span></span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true" tabindex="-1"></a><span class="st">$TABLE ID TAD IPRED IWRES CWRES EVID MDV TIME NOPRINT ONEHEADER FILE=SDTAB001</span></span>
<span id="cb19-59"><a href="#cb19-59" aria-hidden="true" tabindex="-1"></a><span class="st">$TABLE ID CL V1 Q V2 ETA1 ETA2 NOPRINT ONEHEADER FILE=PATAB001</span></span>
<span id="cb19-60"><a href="#cb19-60" aria-hidden="true" tabindex="-1"></a><span class="st">$TABLE ID NOPRINT ONEHEADER FILE=COTAB001</span></span>
<span id="cb19-61"><a href="#cb19-61" aria-hidden="true" tabindex="-1"></a><span class="st">$TABLE ID NOPRINT ONEHEADER FILE=CATAB001</span></span>
<span id="cb19-62"><a href="#cb19-62" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
<p>We now want ChatGPT to</p>
<ul>
<li>Find all <code>$THETA</code> entries</li>
<li>Extract the parameter name</li>
<li>Extract the initial value</li>
</ul>
<p>and report all this in a <em>structured</em> format. First, we define a <code>Pydantic</code> class for a single parameter:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>python</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># define class per parameter</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> OneParameter(BaseModel):</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    name: <span class="bu">str</span> <span class="op">=</span> Field(..., description<span class="op">=</span><span class="st">"The name of the parameter excluding any strings, typically provided as a comment next to the initial value."</span>)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    initial_value: <span class="bu">float</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
<p>As you can see, within the freshly defined <code>OneParameter</code> object, the name of the parameter has to be a <code>string</code> and the initial value has to be of type <code>float</code>. Mixing types within one class is not a problem, and having multiple key-value pairs is also possible. But more to that later.</p>
<p>Please note that we can provide <em>custom descriptions</em> to the field by using the <code>str = Field()</code> notation. This adds some custom instructions in defining what we expect for this field, and helps to get the correct output for this class.</p>
<p>But we are not done yet. There are multiple parameters in the model code, and we want to extract them all. Currently we would simply get one of the parameters. But as we do not want to hard-code the number of expected parameters, this is a task that should be handled by the LLM.</p>
<p>Luckily, we can simply define a list within a nested class, to indicate that there might be multiple elements. The number of elements will be determined by ChatGPT.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>python</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># define class per parameter</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MultipleParameters(BaseModel):</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    parameter_list: <span class="bu">list</span>[OneParameter]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
<p>Very convenient! We simply define a new class, which will be our output class, and expect it to contain a list of <code>OneParameter</code> objects. We do not have to define the length of this list, so depending on the model code we paste as input, the list will hopefully be filled accordingly.</p>
<p>Now we just need to create our response. Let’s see if this works properly. It is worth noting that we also provide some instructions via the <code>instructions</code> argument to clarify that we are interested only in <code>$THETA</code> and to give a bit of context. The predefined <code>model_text</code> will be passed, without further instructions or text, via the input argument. The previously defined <code>MultipleParameters</code> class, which expects a list of <code>OneParameter</code> classes, will be our <code>text_format</code>.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>python</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># prompt chatgpt</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> client.responses.parse(</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"gpt-4o"</span>,</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">input</span><span class="op">=</span>model_text,</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    instructions<span class="op">=</span><span class="st">"You are a helpful assistant that reliably extracts the $THETA parameters, specifially the names and the initial values from NONMEM model code"</span>,</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    text_format<span class="op">=</span>MultipleParameters,</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="co"># show answer</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>response.output_parsed</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>MultipleParameters(parameter_list=[OneParameter(name='prop', initial_value=0.5), OneParameter(name='add', initial_value=0.1), OneParameter(name='CL', initial_value=30.0), OneParameter(name='V1', initial_value=200.0), OneParameter(name='Q', initial_value=30.0), OneParameter(name='V2', initial_value=200.0)])</code></pre>
</div>
</div>
<p>This is very useful because we have provided messy and unstructured NONMEM code, and with a bit of explanation and a defined output structure, we can quickly extract useful information from the code that enables structured postprocessing. We can now also directly access the values of a particular element:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>python</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># show name </span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>response.output_parsed.parameter_list[<span class="dv">1</span>].name</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>'add'</code></pre>
</div>
</div>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>python</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># show value</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>response.output_parsed.parameter_list[<span class="dv">1</span>].initial_value</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>0.1</code></pre>
</div>
</div>
<p>We can use the <code>response</code> object to create a simple table that summarizes the name and the intial value, making it a bit more accessible:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>python</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load pandas</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="co"># define dataframe based on response</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame([</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"name"</span>: p.name, <span class="st">"initial"</span>: p.initial_value}</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> p <span class="kw">in</span> response.output_parsed.parameter_list</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a><span class="co"># show df</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>df</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>   name  initial
0  prop      0.5
1   add      0.1
2    CL     30.0
3    V1    200.0
4     Q     30.0
5    V2    200.0</code></pre>
</div>
</div>
<p>Great! This is definitely handy. But please be aware that - as with any other use of LLMs - we cannot be fully certain that it will work perfectly every time. Hallucinations and errors can occur, so we should never rely on such operations without performing sanity checks. Still, it is easy to see how such a tool can be helpful when systematically extracting data from unstructured text.</p>
</section>
<section id="agentic-workflows" class="level1">
<h1>Agentic workflows</h1>
<p>There is much more to learn and explore, and the landscape is changing almost daily. Probably the most exciting thing (to me) are <strong>agentic workflows</strong>, which are worth a closer look.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="robot.jpg" class="img-fluid figure-img"></p>
<figcaption>A single agent.</figcaption>
</figure>
</div>
<p>Agents can be thought of as model-based units designed to be best at a specific, pre-defined task. They operate based on the above-mentioned custom instructions, structured output formats, and a defined model version (like <code>gpt-4o</code>). Here we can combine all our tools and knowledge.</p>
<p>An important feature of agents is the ability to define so-called <em>handovers</em>. This allows one agent to decide on its own to delegate a task to another agent that is better suited for it. This can be extremely powerful!</p>
<p>By using this approach, we can create a capable network of agents that is able to handle complex tasks. With handovers in place, a single, higher-level triage agent can direct requests to the appropriate expert agent and collect their answers.</p>
<p>To illustrate this, let’s replicate the earlier example, but this time using an simple agent network. For this, we first need to install the <code>OpenAI Agents SDK</code> library, which was made to deal with such agents more conveniently.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>powershell</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load pandas</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>pip install openai<span class="sc">-</span>agents</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
<p>Once this was successful, we can again load some agent-specific modules:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>python</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load pandas</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> agents <span class="im">import</span> Agent, Runner</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
<p>In a next step, we can create an agent that simply mirrors the behavior of our model example above:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>python</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># define agent</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>theta_agent <span class="op">=</span> Agent(</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  name<span class="op">=</span><span class="st">"Theta Extraction Agent"</span>,</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  model<span class="op">=</span><span class="st">"gpt-4o"</span>,</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  instructions<span class="op">=</span><span class="st">"You are a helpful assistant that reliably extracts the $THETA parameters, specifially the names and the initial values from NONMEM model code"</span>,</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>  output_type<span class="op">=</span>MultipleParameters,</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>  handoff_description<span class="op">=</span><span class="st">"Specialist agent that extracts $THETA parameters with their names and initial values"</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
<p>Please note that the setup and arguments are quite similar, but we now define it using <code>Agent()</code> instead of <code>client.responses.parse()</code>, and <code>text_format</code> is replaced by <code>output_type.</code> One key difference is the <code>handoff_description</code> argument, which will become important later. This description provides additional context so that the triage agent (responsible for delegating tasks) can select the appropriate expert agent to handle the request. Another difference is the absence of the <code>input=model_text</code> argument, as we are now defining the agent with custom instructions and output format while keeping it agnostic to specific prompts. The input prompt will only be provided when we actually run the agent, which is what we will do next.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>python</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># run the agent with the model code</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>result_theta <span class="op">=</span> Runner.run_sync(theta_agent, <span class="ss">f"Please extract the parameters from this model: </span><span class="sc">{</span>model_text<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="co"># show output</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>result_theta</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>RunResult(input='Please extract the parameters from this model: \n;; 1. Based on: 001\n;; 2. Description: drug\n;; x1. Author: www.pkpd-info.com\n\n$PROBLEM PK model\n\n$INPUT \t;; Pas aan naar dataset\n  CENSOR AORTA=DROP ID DATE=DROP TIME AMT EVID MDV TAD DV\t\t \n\n$DATA datafile.CSV IGNORE=C \n\n$SUBROUTINES \n  ADVAN3 TRANS4 \t\t;; data 2-comp (iv)\n\n$PK \t\t\t\t\n  LTVCL = LOG(THETA(3))\n  MU_1 = LTVCL \t\t\t;; MU_1 referencing \n  CL =  EXP(MU_1 + ETA(1))\n  \n  LTVV1 = LOG(THETA(4))\n  MU_2 = LTVV1\n  V1 = EXP(MU_2 + ETA(2))\n  \n  Q = THETA(5)\n  V2 = THETA(6)\n  \n  S1 = V1\n\n$THETA  \t\t\t;; set realistic initial estimates\n  (0, 0.5) \t;1 prop\n  (0, 0.1) \t;2 add\n  (0, 30)   \t;3 CL\n  (0, 200)  \t;4 V1\n  (0, 30)   \t;5 Q\n  (0, 200)  \t;6 V2\n\n$OMEGA BLOCK(2)\n  0.09\t\t; IIV-CL\n  0.01 0.09\t; IIV-V\n\n$SIGMA\n  1 FIX  ;residual variability\n\n$ERROR  \t\t\t;; Based on linear data and proportional and additive error\n  IPRED = F\n  IRES = DV-IPRED\n  W = IPRED*THETA(1)+THETA(2)\n  IF (W.EQ.0) W = 1\n  IWRES = IRES/W\n  Y= IPRED+W*ERR(1)\n\n$EST METHOD=1 MAXEVAL=99999 SIG=3 PRINT=5 NOABORT POSTHOC INTERACTION  \t;; Estimation method FOCE+interaction\n\n$COV PRINT=E UNCONDITIONAL\n\n$TABLE ID TAD IPRED IWRES CWRES EVID MDV TIME NOPRINT ONEHEADER FILE=SDTAB001\n$TABLE ID CL V1 Q V2 ETA1 ETA2 NOPRINT ONEHEADER FILE=PATAB001\n$TABLE ID NOPRINT ONEHEADER FILE=COTAB001\n$TABLE ID NOPRINT ONEHEADER FILE=CATAB001\n', new_items=[MessageOutputItem(agent=Agent(name='Theta Extraction Agent', handoff_description='Specialist agent that extracts $THETA parameters with their names and initial values', tools=[], mcp_servers=[], mcp_config={}, instructions='You are a helpful assistant that reliably extracts the $THETA parameters, specifially the names and the initial values from NONMEM model code', prompt=None, handoffs=[], model='gpt-4o', model_settings=ModelSettings(temperature=None, top_p=None, frequency_penalty=None, presence_penalty=None, tool_choice=None, parallel_tool_calls=None, truncation=None, max_tokens=None, reasoning=None, verbosity=None, metadata=None, store=None, prompt_cache_retention=None, include_usage=None, response_include=None, top_logprobs=None, extra_query=None, extra_body=None, extra_headers=None, extra_args=None), input_guardrails=[], output_guardrails=[], output_type=&lt;class '__main__.MultipleParameters'&gt;, hooks=None, tool_use_behavior='run_llm_again', reset_tool_choice=True), raw_item=ResponseOutputMessage(id='msg_01aa6f38b96c4f5900694b2fe4e8588195b67c658bab4e489d', content=[ResponseOutputText(annotations=[], text='{"parameter_list":[{"name":"prop","initial_value":0.5},{"name":"add","initial_value":0.1},{"name":"CL","initial_value":30},{"name":"V1","initial_value":200},{"name":"Q","initial_value":30},{"name":"V2","initial_value":200}]}', type='output_text', logprobs=[])], role='assistant', status='completed', type='message'), type='message_output_item')], raw_responses=[ModelResponse(output=[ResponseOutputMessage(id='msg_01aa6f38b96c4f5900694b2fe4e8588195b67c658bab4e489d', content=[ResponseOutputText(annotations=[], text='{"parameter_list":[{"name":"prop","initial_value":0.5},{"name":"add","initial_value":0.1},{"name":"CL","initial_value":30},{"name":"V1","initial_value":200},{"name":"Q","initial_value":30},{"name":"V2","initial_value":200}]}', type='output_text', logprobs=[])], role='assistant', status='completed', type='message')], usage=Usage(requests=1, input_tokens=721, input_tokens_details=InputTokensDetails(cached_tokens=0), output_tokens=67, output_tokens_details=OutputTokensDetails(reasoning_tokens=0), total_tokens=788, request_usage_entries=[]), response_id='resp_01aa6f38b96c4f5900694b2fe463048195820ab3bbedcc17df')], final_output=MultipleParameters(parameter_list=[OneParameter(name='prop', initial_value=0.5), OneParameter(name='add', initial_value=0.1), OneParameter(name='CL', initial_value=30.0), OneParameter(name='V1', initial_value=200.0), OneParameter(name='Q', initial_value=30.0), OneParameter(name='V2', initial_value=200.0)]), input_guardrail_results=[], output_guardrail_results=[], tool_input_guardrail_results=[], tool_output_guardrail_results=[], context_wrapper=RunContextWrapper(context=None, usage=Usage(requests=1, input_tokens=721, input_tokens_details=InputTokensDetails(cached_tokens=0), output_tokens=67, output_tokens_details=OutputTokensDetails(reasoning_tokens=0), total_tokens=788, request_usage_entries=[RequestUsage(input_tokens=721, output_tokens=67, total_tokens=788, input_tokens_details=InputTokensDetails(cached_tokens=0), output_tokens_details=OutputTokensDetails(reasoning_tokens=0))])), _last_agent=Agent(name='Theta Extraction Agent', handoff_description='Specialist agent that extracts $THETA parameters with their names and initial values', tools=[], mcp_servers=[], mcp_config={}, instructions='You are a helpful assistant that reliably extracts the $THETA parameters, specifially the names and the initial values from NONMEM model code', prompt=None, handoffs=[], model='gpt-4o', model_settings=ModelSettings(temperature=None, top_p=None, frequency_penalty=None, presence_penalty=None, tool_choice=None, parallel_tool_calls=None, truncation=None, max_tokens=None, reasoning=None, verbosity=None, metadata=None, store=None, prompt_cache_retention=None, include_usage=None, response_include=None, top_logprobs=None, extra_query=None, extra_body=None, extra_headers=None, extra_args=None), input_guardrails=[], output_guardrails=[], output_type=&lt;class '__main__.MultipleParameters'&gt;, hooks=None, tool_use_behavior='run_llm_again', reset_tool_choice=True))</code></pre>
</div>
</div>
<p>Okay, great! Again a lot of meta data, and we can perform a similar operation (as described above) to extract the parameters in a tabular format.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>python</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>pd.DataFrame([</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"name"</span>: p.name, <span class="st">"initial"</span>: p.initial_value}</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> p <span class="kw">in</span> result_theta.final_output.parameter_list</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>   name  initial
0  prop      0.5
1   add      0.1
2    CL     30.0
3    V1    200.0
4     Q     30.0
5    V2    200.0</code></pre>
</div>
</div>
<p>Please note that <code>result_theta</code> no longer contains a structure named <code>output_parsed</code>; it is now called <code>final_output</code>.</p>
<p>So far, we have defined an agent that can be reused for various prompts, but it does not yet provide significant additional benefits. To make the example more useful and novel, we will introduce another agent that can generate a short summary of different parts of a model code. These two agents will later be our agentic workflow, once we combine it with a separate traige agent for task delegation. Again, we will create a custom <code>Pydantic</code> class for the output with field descriptions and use it to define our custom agent.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>python</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># define class per parameter</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ModelSummary(BaseModel):</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  structural: <span class="bu">str</span> <span class="op">=</span> Field(..., description<span class="op">=</span><span class="st">"A short and concise summary about the structural model (excluding covariate effects and stochastic elements). For example: Is it a one-, two-, or three-compartment structure?"</span>)</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  stochastic: <span class="bu">str</span> <span class="op">=</span> Field(..., description<span class="op">=</span><span class="st">"A short and concise summary about the stochastic model (excluding residual variability). For example: On which parameters do we have interindividual or interoccasion variability included?"</span>)</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>  residual: <span class="bu">str</span> <span class="op">=</span> Field(..., description<span class="op">=</span><span class="st">"A short and concise summary about the residual unexplained variability / error model (excluding IIV or IOV). For example: Do we have an additive, a proportional, or a combined additive-proportional error model?"</span>)</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="co"># define agent</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>summary_agent <span class="op">=</span> Agent(</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>  name<span class="op">=</span><span class="st">"Model Summary Agent"</span>,</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>  model<span class="op">=</span><span class="st">"gpt-4o"</span>,</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>  instructions<span class="op">=</span><span class="st">"You are a helpful assistant that provides a short and concise summary for various aspects of a given NONMEM model code"</span>,</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>  output_type<span class="op">=</span>ModelSummary,</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>  handoff_description<span class="op">=</span><span class="st">"Specialist agent that summarizes important aspects of various aspects of a given NONMEM model code"</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a><span class="co"># run the agent with the model code</span></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>result_summary <span class="op">=</span> Runner.run_sync(summary_agent, <span class="ss">f"Please give me a structured summary for this model: </span><span class="sc">{</span>model_text<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a><span class="co"># show as table</span></span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>result_summary.final_output.structural</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>'Two-compartment model with parameters CL, V1, Q, and V2.'</code></pre>
</div>
</div>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>python</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>result_summary.final_output.stochastic</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>'Interindividual variability (IIV) on CL and V1 using a 2x2 Omega block structure.'</code></pre>
</div>
</div>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>python</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>result_summary.final_output.residual</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>'Combined proportional and additive error model.'</code></pre>
</div>
</div>
<p>Great, we now have two independent agents, each specialized in a specific aspect of extracting information from the model code. The next step is to define a single “meta-agent” that takes a given request and delegates it to the appropriate agent. Such agents are often referred to as “triage agents.”</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>python</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># define triage agent</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>triage_agent <span class="op">=</span> Agent(</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"Triage agent"</span>,</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    instructions<span class="op">=</span>(</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Help the user with their NONMEM model code."</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"If they ask about the model parameters and their initials, handoff to the theta extraction agent."</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"If they want to get a structured summary of the code, handoff to the model summary agent."</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>    handoffs<span class="op">=</span>[theta_agent, summary_agent]</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
<p>As you can see, this is now a high-level triage agent designed to delegate tasks to the previously defined, more specialized agents. The specialized agents are defined via the <code>handoffs</code> argument. As with any agent, it is important to provide clear and meaningful instructions; if the results do not meet our expectations, it is always a good idea to revisit and refine these instructions. Such <em>prompt engineering</em> can often improve outcomes. With this setup, we can now go ahead and ask the general triage agent a question about the model parameters, hoping that it will correctly forward the request to the <code>theta_agent</code>.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>python</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># run the agent </span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>result_triage <span class="op">=</span> Runner.run_sync(triage_agent, <span class="ss">f"What initial parameter estimates have been defined for the attached model? </span><span class="sc">{</span>model_text<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[non-fatal] Tracing: server error 503, retrying.</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># show output</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>result_triage.final_output.parameter_list</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[OneParameter(name='prop', initial_value=0.5), OneParameter(name='add', initial_value=0.1), OneParameter(name='CL', initial_value=30.0), OneParameter(name='V1', initial_value=200.0), OneParameter(name='Q', initial_value=30.0), OneParameter(name='V2', initial_value=200.0)]</code></pre>
</div>
</div>
<p>Great, this worked quite well! Let’s see if the other use case works just as smoothly.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>python</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># run the agent </span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>result_triage <span class="op">=</span> Runner.run_sync(triage_agent, <span class="ss">f"Can you quickly summarize the attached model? </span><span class="sc">{</span>model_text<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="co"># show output</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>result_triage.final_output.structural</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>'Two-compartment model with first-order elimination.'</code></pre>
</div>
</div>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>python</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>result_triage.final_output.stochastic</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>'Interindividual variability on CL and V1 (correlated).'</code></pre>
</div>
</div>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>python</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>result_triage.final_output.residual</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>'Combined additive and proportional error model.'</code></pre>
</div>
</div>
<p>Perfect! With that we have demonstrated how to build a powerful agent framework using a very simple example. But the possibilities are limitless and you can think much bigger when you consider that each lower-level agent can also have its own handoffs. All you need is to identify your use case and then build your customized framework.</p>
</section>
<section id="epilogue" class="level1">
<h1>Epilogue</h1>
<p>I am sure there is still plenty left to explore, and new features appear quietly every week. I am always suprised when I check the documentations which new tools have popped-up since my last visit. In my opinion, well‑set‑up agents for small, low‑risk tasks can make our day‑to‑day work a bit smoother and free up time for things that need more focus. Still, even with simple tasks, it’s worth giving the outputs a quick check to be sure everything makes sense, and of course topics such as data protection have to be considered. I hope these first steps were useful to you, and I’d be happy to hear what you think. See you next time!</p>


<!-- -->

</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{klose2025,
  author = {Klose, Marian},
  title = {Using {ChatGPT} from the Command Line},
  date = {2025-07-31},
  url = {https://marian-klose.com/posts/command_line_chatgpt/index.html},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-klose2025" class="csl-entry quarto-appendix-citeas" role="listitem">
Klose, Marian. 2025. <span>“Using ChatGPT from the Command Line.”</span>
July 31, 2025. <a href="https://marian-klose.com/posts/command_line_chatgpt/index.html">https://marian-klose.com/posts/command_line_chatgpt/index.html</a>.
</div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<input type="hidden" id="giscus-base-theme" value="light">
<input type="hidden" id="giscus-alt-theme" value="dark">
<script>
  function loadGiscus() {
    // Function to get the theme based on body class
    const getTheme = () => {
      let baseTheme = document.getElementById('giscus-base-theme').value;
      let altTheme = document.getElementById('giscus-alt-theme').value;
      return document.body.classList.contains('quarto-dark') ? altTheme : baseTheme;
    };
    const script = document.createElement("script");
    script.src = "https://giscus.app/client.js";
    script.async = true;
    script.dataset.repo = "marianklose/personal-website";
    script.dataset.repoId = "R_kgDOLLh1WA";
    script.dataset.category = "Comments";
    script.dataset.categoryId = "DIC_kwDOLLh1WM4CjMUX";
    script.dataset.mapping = "pathname";
    script.dataset.reactionsEnabled = "1";
    script.dataset.emitMetadata = "0";
    script.dataset.inputPosition = "bottom";
    script.dataset.theme = getTheme();
    script.dataset.lang = "en";
    script.crossOrigin = "anonymous";
    // Append the script to the desired div instead of at the end of the body
    document.getElementById("quarto-content").appendChild(script);
  }
  loadGiscus();
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb54" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Using ChatGPT from the command line"</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="an">description:</span><span class="co"> "Supercharging LLMs by building agentic workflows."</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="co">  - name: Marian Klose</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a><span class="co">    url: https://github.com/marianklose</span></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a><span class="co">    orcid: 0009-0005-1706-6289</span></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> 2025-07-31</span></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a><span class="an">categories:</span><span class="co"> [ChatGPT, openai, LLM] </span></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a><span class="an">image:</span><span class="co"> preview.jpg</span></span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a><span class="an">draft:</span><span class="co"> false</span></span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a><span class="an">draft-mode:</span><span class="co"> visible</span></span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a><span class="an">echo:</span><span class="co"> true</span></span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span></span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a><span class="co">  freeze: true # never re-render during project render (dependencies might change over time)</span></span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a><span class="co">  echo: true</span></span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a><span class="co">  message: false</span></span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a><span class="co">  warning: false</span></span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a><span class="an">citation:</span><span class="co"> </span></span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a><span class="co">  url: https://marian-klose.com/posts/command_line_chatgpt/index.html</span></span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a><span class="co">    number-sections: false</span></span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: true</span></span>
<span id="cb54-26"><a href="#cb54-26" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb54-27"><a href="#cb54-27" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb54-28"><a href="#cb54-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-29"><a href="#cb54-29" aria-hidden="true" tabindex="-1"></a><span class="fu"># Prologue</span></span>
<span id="cb54-30"><a href="#cb54-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-31"><a href="#cb54-31" aria-hidden="true" tabindex="-1"></a><span class="fu">## Motivation</span></span>
<span id="cb54-32"><a href="#cb54-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-33"><a href="#cb54-33" aria-hidden="true" tabindex="-1"></a>Large language models (LLMs) are sneaking more and more into our daily workflows. There is surely a debate whether they deserve the hype, but in general they seem to be quite useful for low-risk but repetitive tasks that tend to eat up our time and focus. While we can use the graphical user interface to run these models, a more effective and much more powerful way is to run them directly from the command line using R or Python. By doing so we can supercharge their usefulness and create tailored, automated solutions for our specific solutions without the pain of clicking through a web interface. I have recently digged a bit into this topic and I am surely still scratching the surface of what is possible. In this post, I'll simply walk through my first steps using ChatGPT from the command line in Python, and highlight a few features/funcitons that I found helpful. In the end, we will have a very simplistic agentic workflow that is able to extract structured information from some NONMEM model code. Sounds good? Let's get started!</span>
<span id="cb54-34"><a href="#cb54-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-35"><a href="#cb54-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-36"><a href="#cb54-36" aria-hidden="true" tabindex="-1"></a><span class="fu">## Why python?</span></span>
<span id="cb54-37"><a href="#cb54-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-38"><a href="#cb54-38" aria-hidden="true" tabindex="-1"></a>OpenAI provides official Software Development Kits (SDKs) for interacting with their API in several programming languages, such as JavaScript and Python. These SDKs make sending requests and processing responses relatively painless and have the official support of OpenAI. While Python is not super popular in our pharmacometric community and also I am personally much more more comfortable in R, I chose Python for these kind of tasks. The existence of a well-maintained, well-documented and ready-to-use SDK simply makes our lives much easier. You can interact with their API directly via raw HTTP requests, but I guess that is just painful and comes with a lot of overhead.  </span>
<span id="cb54-39"><a href="#cb54-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-40"><a href="#cb54-40" aria-hidden="true" tabindex="-1"></a><span class="al">![A snake, not Python.](snake.jpg)</span></span>
<span id="cb54-41"><a href="#cb54-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-42"><a href="#cb54-42" aria-hidden="true" tabindex="-1"></a>For those wanting to stick to R, there’s also the promising <span class="co">[</span><span class="ot">ellmer package</span><span class="co">](https://ellmer.tidyverse.org/)</span>  which has been recently released. It integrates LLM access directly into the <span class="in">`tidyverse`</span> ecosystem (which we all love). I haven’t tried it out yet, but it could become a very attractive option for R users. Currently they are in version <span class="in">`0.3.0`</span> and I guess there is still a lot of development happening, but with the support of Posit and the tidyverse development team it will surely be a great option in the future! Feel free to comment if you have gathered some experience.</span>
<span id="cb54-43"><a href="#cb54-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-44"><a href="#cb54-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-45"><a href="#cb54-45" aria-hidden="true" tabindex="-1"></a><span class="fu"># Setup</span></span>
<span id="cb54-46"><a href="#cb54-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-47"><a href="#cb54-47" aria-hidden="true" tabindex="-1"></a>Let's start with the essentials. For the setup, we’ll essentially follow OpenAI’s official <span class="co">[</span><span class="ot">Quickstart guide for developers</span><span class="co">](https://platform.openai.com/docs/quickstart?language-preference=python)</span>.</span>
<span id="cb54-48"><a href="#cb54-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-49"><a href="#cb54-49" aria-hidden="true" tabindex="-1"></a>Because the documentation may change over time, I guess referring directly to that guide is more robust than relying on any hard-coded details I would include here. Luckily their documentation is great and I found it quite easy to get started.</span>
<span id="cb54-50"><a href="#cb54-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-51"><a href="#cb54-51" aria-hidden="true" tabindex="-1"></a><span class="fu">## Creating an account</span></span>
<span id="cb54-52"><a href="#cb54-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-53"><a href="#cb54-53" aria-hidden="true" tabindex="-1"></a>If we want to access ChatGPT from the command line, we first need an OpenAI account. We can simply head to the <span class="co">[</span><span class="ot">OpenAI platform</span><span class="co">](https://platform.openai.com/signup)</span> and create an account. So far, creating an account is free. However, once we start sending prompts via our API key, usage will be billed. For our use-cases this will just be a couple of cents, and you can always check the expected billing in your dashboard.</span>
<span id="cb54-54"><a href="#cb54-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-55"><a href="#cb54-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-56"><a href="#cb54-56" aria-hidden="true" tabindex="-1"></a><span class="fu">## Retrieve your API key</span></span>
<span id="cb54-57"><a href="#cb54-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-58"><a href="#cb54-58" aria-hidden="true" tabindex="-1"></a>If we want to use ChatGPT from the command line, we will have to authenticate ourselves so that OpenAI knows whom to bill. An API key is a long, random string used to authenticate and authorize access to the API. Think of it like a password (and handle it with the same care to avoid excessive bills from some stranger). Since every prompt we send incurs a (usually small) cost, we don’t want to share our API keys with anyone. Once we’ve successfully created the account, we can now generate an API key at <span class="co">[</span><span class="ot">this page of the dashboard</span><span class="co">](https://platform.openai.com/api-keys)</span>.</span>
<span id="cb54-59"><a href="#cb54-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-60"><a href="#cb54-60" aria-hidden="true" tabindex="-1"></a><span class="al">![A screenshot of the API keys dashboard.](api_keys.png)</span></span>
<span id="cb54-61"><a href="#cb54-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-62"><a href="#cb54-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-63"><a href="#cb54-63" aria-hidden="true" tabindex="-1"></a>From the screenshot, you can see that I have an API key for my laptop starting with <span class="in">`sk-....YLUA`</span>. Now we have to make it accessible to Python, so we can authenticate ourselves when making requests.</span>
<span id="cb54-64"><a href="#cb54-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-65"><a href="#cb54-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-66"><a href="#cb54-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-67"><a href="#cb54-67" aria-hidden="true" tabindex="-1"></a><span class="fu">## Saving your API key as an environmental variable</span></span>
<span id="cb54-68"><a href="#cb54-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-69"><a href="#cb54-69" aria-hidden="true" tabindex="-1"></a>We want to avoid typing the API key each time or hard-coding it into a script. Hard-coding it would be like pasting a password in plain text or putting it on a post-it somewhere. A much safer approach is to store the API key as an environment variable (and there are even safer options). On Windows, we can do this by searching for *System environment variables* in the Windows search bar or we simply use PowerShell to set it:</span>
<span id="cb54-70"><a href="#cb54-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-71"><a href="#cb54-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-72"><a href="#cb54-72" aria-hidden="true" tabindex="-1"></a><span class="in">```{r filename="powershell"}</span></span>
<span id="cb54-73"><a href="#cb54-73" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb54-74"><a href="#cb54-74" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: false</span></span>
<span id="cb54-75"><a href="#cb54-75" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: false</span></span>
<span id="cb54-76"><a href="#cb54-76" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb54-77"><a href="#cb54-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-78"><a href="#cb54-78" aria-hidden="true" tabindex="-1"></a>setx OPENAI_API_KEY <span class="st">"your_api_key_here"</span></span>
<span id="cb54-79"><a href="#cb54-79" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-80"><a href="#cb54-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-81"><a href="#cb54-81" aria-hidden="true" tabindex="-1"></a>We have to make sure to name the environment variable exactly <span class="in">`OPENAI_API_KEY`</span>. The openai Python package looks for this specific name when we initialize it to link the prompts to our account. Very nice, our API key is ready to be used!</span>
<span id="cb54-82"><a href="#cb54-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-83"><a href="#cb54-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-84"><a href="#cb54-84" aria-hidden="true" tabindex="-1"></a><span class="fu">## Setting up Python</span></span>
<span id="cb54-85"><a href="#cb54-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-86"><a href="#cb54-86" aria-hidden="true" tabindex="-1"></a>I won’t go into the details of installing Python itself, as there are many excellent tutorials out there for that. Of course we have to take care of some packages and dependencies, and we install it with Python’s package installer <span class="in">`pip`</span>: </span>
<span id="cb54-87"><a href="#cb54-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-88"><a href="#cb54-88" aria-hidden="true" tabindex="-1"></a><span class="in">```{r filename="powershell"}</span></span>
<span id="cb54-89"><a href="#cb54-89" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb54-90"><a href="#cb54-90" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: false</span></span>
<span id="cb54-91"><a href="#cb54-91" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: false</span></span>
<span id="cb54-92"><a href="#cb54-92" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb54-93"><a href="#cb54-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-94"><a href="#cb54-94" aria-hidden="true" tabindex="-1"></a>pip install openai</span>
<span id="cb54-95"><a href="#cb54-95" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-96"><a href="#cb54-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-97"><a href="#cb54-97" aria-hidden="true" tabindex="-1"></a>And that’s it! We've now installed the OpenAI package and set up our API key as an environment variable. Next, we can move on to sending our first prompt.</span>
<span id="cb54-98"><a href="#cb54-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-99"><a href="#cb54-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-100"><a href="#cb54-100" aria-hidden="true" tabindex="-1"></a><span class="fu"># Our first prompt</span></span>
<span id="cb54-101"><a href="#cb54-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-102"><a href="#cb54-102" aria-hidden="true" tabindex="-1"></a>Sending a request to ChatGPT from the command line is surprisingly straightforward. Let’s walk through it step by step. First, we load our packages and initialize the OpenAI client:</span>
<span id="cb54-103"><a href="#cb54-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-104"><a href="#cb54-104" aria-hidden="true" tabindex="-1"></a><span class="in">```{python filename="python"}</span></span>
<span id="cb54-105"><a href="#cb54-105" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb54-106"><a href="#cb54-106" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: false</span></span>
<span id="cb54-107"><a href="#cb54-107" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: false</span></span>
<span id="cb54-108"><a href="#cb54-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-109"><a href="#cb54-109" aria-hidden="true" tabindex="-1"></a><span class="co"># load packages</span></span>
<span id="cb54-110"><a href="#cb54-110" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> openai <span class="im">import</span> OpenAI</span>
<span id="cb54-111"><a href="#cb54-111" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb54-112"><a href="#cb54-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-113"><a href="#cb54-113" aria-hidden="true" tabindex="-1"></a><span class="co"># initialize openai client</span></span>
<span id="cb54-114"><a href="#cb54-114" aria-hidden="true" tabindex="-1"></a>client <span class="op">=</span> OpenAI()</span>
<span id="cb54-115"><a href="#cb54-115" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-116"><a href="#cb54-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-117"><a href="#cb54-117" aria-hidden="true" tabindex="-1"></a>By initializing the client by calling <span class="in">`OpenAI()`</span>, Python will look for the <span class="in">`OPENAI_API_KEY`</span> environmental variable and get the client started. Now we can already send our first prompt. Here, we’ll use the <span class="in">`gpt-4o`</span> model, but <span class="co">[</span><span class="ot">many other models</span><span class="co">](https://platform.openai.com/docs/models)</span> are available.</span>
<span id="cb54-118"><a href="#cb54-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-119"><a href="#cb54-119" aria-hidden="true" tabindex="-1"></a>Notably, we’ll use the <span class="in">`Responses API`</span>, which is newer than the <span class="in">`Chat Completions API`</span>. OpenAI has stated that Chat Completions will remain supported, but future features will likely appear first in the Responses API. The general idea is the same, though the syntax differs slightly.</span>
<span id="cb54-120"><a href="#cb54-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-121"><a href="#cb54-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-122"><a href="#cb54-122" aria-hidden="true" tabindex="-1"></a><span class="in">```{python filename="python"}</span></span>
<span id="cb54-123"><a href="#cb54-123" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb54-124"><a href="#cb54-124" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: false</span></span>
<span id="cb54-125"><a href="#cb54-125" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: false</span></span>
<span id="cb54-126"><a href="#cb54-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-127"><a href="#cb54-127" aria-hidden="true" tabindex="-1"></a><span class="co"># send request</span></span>
<span id="cb54-128"><a href="#cb54-128" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> client.responses.create(</span>
<span id="cb54-129"><a href="#cb54-129" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"gpt-4o"</span>,</span>
<span id="cb54-130"><a href="#cb54-130" aria-hidden="true" tabindex="-1"></a>    <span class="bu">input</span><span class="op">=</span><span class="st">"Write a short joke about pharmacokinetics."</span></span>
<span id="cb54-131"><a href="#cb54-131" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb54-132"><a href="#cb54-132" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-133"><a href="#cb54-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-134"><a href="#cb54-134" aria-hidden="true" tabindex="-1"></a>Notice that we’re providing input only as a single text string here. This mirrors what we often do in the graphical user interface. In more advanced use cases, we can also define multiple roles:</span>
<span id="cb54-135"><a href="#cb54-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-136"><a href="#cb54-136" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**System**: sets the model’s behavior, tone, and style (like giving ChatGPT a personality or a set of instructions).</span>
<span id="cb54-137"><a href="#cb54-137" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**User**: the actual prompt, just as we’d type in the ChatGPT web interface.</span>
<span id="cb54-138"><a href="#cb54-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-139"><a href="#cb54-139" aria-hidden="true" tabindex="-1"></a>This gives us more control and consistency when building automated workflows. We will come back alter to define the system or developer instructions to get more fine-tuned control over the model responses.</span>
<span id="cb54-140"><a href="#cb54-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-141"><a href="#cb54-141" aria-hidden="true" tabindex="-1"></a>Let’s have a look at what the returned object contains:</span>
<span id="cb54-142"><a href="#cb54-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-143"><a href="#cb54-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-144"><a href="#cb54-144" aria-hidden="true" tabindex="-1"></a><span class="in">```{python filename="python"}</span></span>
<span id="cb54-145"><a href="#cb54-145" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb54-146"><a href="#cb54-146" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: false</span></span>
<span id="cb54-147"><a href="#cb54-147" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: false</span></span>
<span id="cb54-148"><a href="#cb54-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-149"><a href="#cb54-149" aria-hidden="true" tabindex="-1"></a><span class="co"># print full object</span></span>
<span id="cb54-150"><a href="#cb54-150" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(response)</span>
<span id="cb54-151"><a href="#cb54-151" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-152"><a href="#cb54-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-153"><a href="#cb54-153" aria-hidden="true" tabindex="-1"></a>The full object contains a lot of metadata, but in most cases we only care about the generated text. We can retrieve it like this:</span>
<span id="cb54-154"><a href="#cb54-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-155"><a href="#cb54-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-156"><a href="#cb54-156" aria-hidden="true" tabindex="-1"></a><span class="in">```{python filename="python"}</span></span>
<span id="cb54-157"><a href="#cb54-157" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb54-158"><a href="#cb54-158" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: false</span></span>
<span id="cb54-159"><a href="#cb54-159" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: false</span></span>
<span id="cb54-160"><a href="#cb54-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-161"><a href="#cb54-161" aria-hidden="true" tabindex="-1"></a><span class="co"># print object</span></span>
<span id="cb54-162"><a href="#cb54-162" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(response.output_text)</span>
<span id="cb54-163"><a href="#cb54-163" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-164"><a href="#cb54-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-165"><a href="#cb54-165" aria-hidden="true" tabindex="-1"></a>And there we have it, our first command-line prompt completed and we received a bad joke about pharmacokinetics. Sure, it’s just a joke for now, but the real power will reveal itself soon (hopefully). Next, we’ll look at slightly more advanced features that allow us to make ChatGPT far more useful in our day-to-day workflows.</span>
<span id="cb54-166"><a href="#cb54-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-167"><a href="#cb54-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-168"><a href="#cb54-168" aria-hidden="true" tabindex="-1"></a><span class="fu"># Custom instructions</span></span>
<span id="cb54-169"><a href="#cb54-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-170"><a href="#cb54-170" aria-hidden="true" tabindex="-1"></a>One of the advantages of the command-line setup over the web interface is the ability to give developer-level instructions. We can pass these via the instructions parameter in <span class="in">`client.responses.create()`</span>.</span>
<span id="cb54-171"><a href="#cb54-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-172"><a href="#cb54-172" aria-hidden="true" tabindex="-1"></a>According to the documentation, these instructions tell the model how to behave while generating a response, such as tone, goals, formatting, or examples of correct responses. Importantly, they have higher priority than anything written in the input prompt.</span>
<span id="cb54-173"><a href="#cb54-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-174"><a href="#cb54-174" aria-hidden="true" tabindex="-1"></a>These instructions are a major part of prompt engineering, a field that ist quite important to get the expected answers from these models. It gives us much more control over the model’s behavior, especially when we are designing agent-based workflows (see later on) where each “agent” plays a defined and specialized role.</span>
<span id="cb54-175"><a href="#cb54-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-176"><a href="#cb54-176" aria-hidden="true" tabindex="-1"></a>Let’s take a very simple example where we tell the model to explain concepts in short, easy-to-understand sentences. This is in contrast to the often lengthy sentences with which ChatGPT often responds to our requests:</span>
<span id="cb54-177"><a href="#cb54-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-178"><a href="#cb54-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-179"><a href="#cb54-179" aria-hidden="true" tabindex="-1"></a><span class="in">```{python filename="python"}</span></span>
<span id="cb54-180"><a href="#cb54-180" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb54-181"><a href="#cb54-181" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: false</span></span>
<span id="cb54-182"><a href="#cb54-182" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: false</span></span>
<span id="cb54-183"><a href="#cb54-183" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: asis</span></span>
<span id="cb54-184"><a href="#cb54-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-185"><a href="#cb54-185" aria-hidden="true" tabindex="-1"></a><span class="co"># send request</span></span>
<span id="cb54-186"><a href="#cb54-186" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> client.responses.create(</span>
<span id="cb54-187"><a href="#cb54-187" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"gpt-4o"</span>,</span>
<span id="cb54-188"><a href="#cb54-188" aria-hidden="true" tabindex="-1"></a>    instructions<span class="op">=</span><span class="st">"You are an experienced teacher who explains concepts in multiple, short sentences with a maximum of 10 words per sentence and simple, easy-to-understand language."</span>,</span>
<span id="cb54-189"><a href="#cb54-189" aria-hidden="true" tabindex="-1"></a>    <span class="bu">input</span><span class="op">=</span><span class="st">"Explain the role of shrinkage in pharmacometric NLME models."</span></span>
<span id="cb54-190"><a href="#cb54-190" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb54-191"><a href="#cb54-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-192"><a href="#cb54-192" aria-hidden="true" tabindex="-1"></a><span class="co"># show answer</span></span>
<span id="cb54-193"><a href="#cb54-193" aria-hidden="true" tabindex="-1"></a>response.output_text</span>
<span id="cb54-194"><a href="#cb54-194" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-195"><a href="#cb54-195" aria-hidden="true" tabindex="-1"></a>Would I want every explanation in my life phrased like this? Probably not. I just want to make a point here: custom instructions let us shape the output style in a way that is most useful to our actual use-case. </span>
<span id="cb54-196"><a href="#cb54-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-197"><a href="#cb54-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-198"><a href="#cb54-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-199"><a href="#cb54-199" aria-hidden="true" tabindex="-1"></a><span class="fu"># Structured outputs</span></span>
<span id="cb54-200"><a href="#cb54-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-201"><a href="#cb54-201" aria-hidden="true" tabindex="-1"></a>Another, even more powerful API feauture (if you ask me) is **structured outputs**.</span>
<span id="cb54-202"><a href="#cb54-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-203"><a href="#cb54-203" aria-hidden="true" tabindex="-1"></a><span class="al">![Structures are important.](structure.jpg)</span></span>
<span id="cb54-204"><a href="#cb54-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-205"><a href="#cb54-205" aria-hidden="true" tabindex="-1"></a>As you are probably aware, ChatGPT typically returns free-form text. That’s fine for many tasks but messy for automation or whenever you want to properly postprocess the output of an answer. Structured outputs let us force the model to return data in a predictable format (for example, a numeric value, a JSON object, or a list of parameters). The documentation for structured outputs currently lives <span class="co">[</span><span class="ot">here</span><span class="co">](https://platform.openai.com/docs/guides/structured-outputs?api-mode=responses)</span>, feel free to check it out. </span>
<span id="cb54-206"><a href="#cb54-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-207"><a href="#cb54-207" aria-hidden="true" tabindex="-1"></a>Under the hood, this works via the <span class="in">`Pydantic`</span> library (for data validation and parsing). We simply define <span class="in">`Pydantic`</span> classes that describe the output format, then pass this expected output structure to the API call. The model will then return data in exactly that format, allowing us to do any kind of postprocessing. First, we will have to install Pydantic:</span>
<span id="cb54-208"><a href="#cb54-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-209"><a href="#cb54-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-210"><a href="#cb54-210" aria-hidden="true" tabindex="-1"></a><span class="in">```{r filename="powershell"}</span></span>
<span id="cb54-211"><a href="#cb54-211" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb54-212"><a href="#cb54-212" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: false</span></span>
<span id="cb54-213"><a href="#cb54-213" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: false</span></span>
<span id="cb54-214"><a href="#cb54-214" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb54-215"><a href="#cb54-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-216"><a href="#cb54-216" aria-hidden="true" tabindex="-1"></a>pip install pydantic</span>
<span id="cb54-217"><a href="#cb54-217" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-218"><a href="#cb54-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-219"><a href="#cb54-219" aria-hidden="true" tabindex="-1"></a>Then we load the package into our session:</span>
<span id="cb54-220"><a href="#cb54-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-221"><a href="#cb54-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-222"><a href="#cb54-222" aria-hidden="true" tabindex="-1"></a><span class="in">```{python filename="python"}</span></span>
<span id="cb54-223"><a href="#cb54-223" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb54-224"><a href="#cb54-224" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: false</span></span>
<span id="cb54-225"><a href="#cb54-225" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: false</span></span>
<span id="cb54-226"><a href="#cb54-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-227"><a href="#cb54-227" aria-hidden="true" tabindex="-1"></a><span class="co"># load packages</span></span>
<span id="cb54-228"><a href="#cb54-228" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pydantic <span class="im">import</span> BaseModel, Field</span>
<span id="cb54-229"><a href="#cb54-229" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-230"><a href="#cb54-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-231"><a href="#cb54-231" aria-hidden="true" tabindex="-1"></a>And now we are able to define the type with which ChatGPT will answer our prompt. For now, we define only a single field in our <span class="in">`NumericAnswer`</span> class, which is the value. By setting its type to <span class="in">`float`</span>, ChatGPT will be constrained to return a numeric value such as <span class="in">`1.643`</span> instead of a text-based response.</span>
<span id="cb54-232"><a href="#cb54-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-233"><a href="#cb54-233" aria-hidden="true" tabindex="-1"></a><span class="in">```{python filename="python"}</span></span>
<span id="cb54-234"><a href="#cb54-234" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb54-235"><a href="#cb54-235" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: false</span></span>
<span id="cb54-236"><a href="#cb54-236" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: false</span></span>
<span id="cb54-237"><a href="#cb54-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-238"><a href="#cb54-238" aria-hidden="true" tabindex="-1"></a><span class="co"># define class</span></span>
<span id="cb54-239"><a href="#cb54-239" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> NumericAnswer(BaseModel):</span>
<span id="cb54-240"><a href="#cb54-240" aria-hidden="true" tabindex="-1"></a>  value: <span class="bu">float</span></span>
<span id="cb54-241"><a href="#cb54-241" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-242"><a href="#cb54-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-243"><a href="#cb54-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-244"><a href="#cb54-244" aria-hidden="true" tabindex="-1"></a>We can now pass this <span class="in">`NumericAnswer`</span> class to ChatGPT, but this time we use <span class="in">`client.responses.parse()`</span> which is designed to handle such structured output cases.</span>
<span id="cb54-245"><a href="#cb54-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-246"><a href="#cb54-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-247"><a href="#cb54-247" aria-hidden="true" tabindex="-1"></a><span class="in">```{python filename="python"}</span></span>
<span id="cb54-248"><a href="#cb54-248" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb54-249"><a href="#cb54-249" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: false</span></span>
<span id="cb54-250"><a href="#cb54-250" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: false</span></span>
<span id="cb54-251"><a href="#cb54-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-252"><a href="#cb54-252" aria-hidden="true" tabindex="-1"></a><span class="co"># prompt chatgpt</span></span>
<span id="cb54-253"><a href="#cb54-253" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> client.responses.parse(</span>
<span id="cb54-254"><a href="#cb54-254" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"gpt-4o"</span>,</span>
<span id="cb54-255"><a href="#cb54-255" aria-hidden="true" tabindex="-1"></a>    <span class="bu">input</span><span class="op">=</span><span class="st">"What is 14 minus 2?"</span>,</span>
<span id="cb54-256"><a href="#cb54-256" aria-hidden="true" tabindex="-1"></a>    text_format<span class="op">=</span>NumericAnswer,</span>
<span id="cb54-257"><a href="#cb54-257" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb54-258"><a href="#cb54-258" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-259"><a href="#cb54-259" aria-hidden="true" tabindex="-1"></a><span class="co"># show answer</span></span>
<span id="cb54-260"><a href="#cb54-260" aria-hidden="true" tabindex="-1"></a>response.output_parsed</span>
<span id="cb54-261"><a href="#cb54-261" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-262"><a href="#cb54-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-263"><a href="#cb54-263" aria-hidden="true" tabindex="-1"></a>We receive an instance of our pre-defined <span class="in">`NumericAnswer`</span> class as output, which already contains the answer from ChatGPT. In this case it is <span class="in">`12.0`</span>. This value can be accessed directly using the predefined value key that was specified when the class was created. As confirmed by the <span class="in">`type()`</span> function, the content is stored as a <span class="in">`float`</span>, making further postprocessing straightforward.</span>
<span id="cb54-264"><a href="#cb54-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-265"><a href="#cb54-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-266"><a href="#cb54-266" aria-hidden="true" tabindex="-1"></a><span class="in">```{python filename="python"}</span></span>
<span id="cb54-267"><a href="#cb54-267" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb54-268"><a href="#cb54-268" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: false</span></span>
<span id="cb54-269"><a href="#cb54-269" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: false</span></span>
<span id="cb54-270"><a href="#cb54-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-271"><a href="#cb54-271" aria-hidden="true" tabindex="-1"></a><span class="co"># show value</span></span>
<span id="cb54-272"><a href="#cb54-272" aria-hidden="true" tabindex="-1"></a>response.output_parsed.value</span>
<span id="cb54-273"><a href="#cb54-273" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-274"><a href="#cb54-274" aria-hidden="true" tabindex="-1"></a><span class="in">```{python filename="python"}</span></span>
<span id="cb54-275"><a href="#cb54-275" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb54-276"><a href="#cb54-276" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: false</span></span>
<span id="cb54-277"><a href="#cb54-277" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: false</span></span>
<span id="cb54-278"><a href="#cb54-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-279"><a href="#cb54-279" aria-hidden="true" tabindex="-1"></a><span class="co"># show type</span></span>
<span id="cb54-280"><a href="#cb54-280" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span>(response.output_parsed.value)</span>
<span id="cb54-281"><a href="#cb54-281" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-282"><a href="#cb54-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-283"><a href="#cb54-283" aria-hidden="true" tabindex="-1"></a>This is great, isn't it? Let's convert our knowledge into a simple example that is closer to our pharmacometric community. </span>
<span id="cb54-284"><a href="#cb54-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-285"><a href="#cb54-285" aria-hidden="true" tabindex="-1"></a><span class="fu"># A pharmacometric example</span></span>
<span id="cb54-286"><a href="#cb54-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-287"><a href="#cb54-287" aria-hidden="true" tabindex="-1"></a>Let’s say we want to automatically extract parameter names and their initial values from a NONMEM model file. In case you are doing a systematic review of published NONMEM models, you might find a utility like this helpful. Here is our example NONMEM model code, which is taken from <span class="co">[</span><span class="ot">pkpd-info</span><span class="co">](https://pkpd-info.com/NONMEM/Model_templates.php)</span>:</span>
<span id="cb54-288"><a href="#cb54-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-289"><a href="#cb54-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-290"><a href="#cb54-290" aria-hidden="true" tabindex="-1"></a><span class="in">```{python filename="python"}</span></span>
<span id="cb54-291"><a href="#cb54-291" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb54-292"><a href="#cb54-292" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: false</span></span>
<span id="cb54-293"><a href="#cb54-293" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: false</span></span>
<span id="cb54-294"><a href="#cb54-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-295"><a href="#cb54-295" aria-hidden="true" tabindex="-1"></a><span class="co"># define model</span></span>
<span id="cb54-296"><a href="#cb54-296" aria-hidden="true" tabindex="-1"></a>model_text <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb54-297"><a href="#cb54-297" aria-hidden="true" tabindex="-1"></a><span class="st">;; 1. Based on: 001</span></span>
<span id="cb54-298"><a href="#cb54-298" aria-hidden="true" tabindex="-1"></a><span class="st">;; 2. Description: drug</span></span>
<span id="cb54-299"><a href="#cb54-299" aria-hidden="true" tabindex="-1"></a><span class="st">;; x1. Author: www.pkpd-info.com</span></span>
<span id="cb54-300"><a href="#cb54-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-301"><a href="#cb54-301" aria-hidden="true" tabindex="-1"></a><span class="st">$PROBLEM PK model</span></span>
<span id="cb54-302"><a href="#cb54-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-303"><a href="#cb54-303" aria-hidden="true" tabindex="-1"></a><span class="st">$INPUT  ;; Pas aan naar dataset</span></span>
<span id="cb54-304"><a href="#cb54-304" aria-hidden="true" tabindex="-1"></a><span class="st">  CENSOR AORTA=DROP ID DATE=DROP TIME AMT EVID MDV TAD DV        </span></span>
<span id="cb54-305"><a href="#cb54-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-306"><a href="#cb54-306" aria-hidden="true" tabindex="-1"></a><span class="st">$DATA datafile.CSV IGNORE=C </span></span>
<span id="cb54-307"><a href="#cb54-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-308"><a href="#cb54-308" aria-hidden="true" tabindex="-1"></a><span class="st">$SUBROUTINES </span></span>
<span id="cb54-309"><a href="#cb54-309" aria-hidden="true" tabindex="-1"></a><span class="st">  ADVAN3 TRANS4         ;; data 2-comp (iv)</span></span>
<span id="cb54-310"><a href="#cb54-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-311"><a href="#cb54-311" aria-hidden="true" tabindex="-1"></a><span class="st">$PK                 </span></span>
<span id="cb54-312"><a href="#cb54-312" aria-hidden="true" tabindex="-1"></a><span class="st">  LTVCL = LOG(THETA(3))</span></span>
<span id="cb54-313"><a href="#cb54-313" aria-hidden="true" tabindex="-1"></a><span class="st">  MU_1 = LTVCL          ;; MU_1 referencing </span></span>
<span id="cb54-314"><a href="#cb54-314" aria-hidden="true" tabindex="-1"></a><span class="st">  CL =  EXP(MU_1 + ETA(1))</span></span>
<span id="cb54-315"><a href="#cb54-315" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb54-316"><a href="#cb54-316" aria-hidden="true" tabindex="-1"></a><span class="st">  LTVV1 = LOG(THETA(4))</span></span>
<span id="cb54-317"><a href="#cb54-317" aria-hidden="true" tabindex="-1"></a><span class="st">  MU_2 = LTVV1</span></span>
<span id="cb54-318"><a href="#cb54-318" aria-hidden="true" tabindex="-1"></a><span class="st">  V1 = EXP(MU_2 + ETA(2))</span></span>
<span id="cb54-319"><a href="#cb54-319" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb54-320"><a href="#cb54-320" aria-hidden="true" tabindex="-1"></a><span class="st">  Q = THETA(5)</span></span>
<span id="cb54-321"><a href="#cb54-321" aria-hidden="true" tabindex="-1"></a><span class="st">  V2 = THETA(6)</span></span>
<span id="cb54-322"><a href="#cb54-322" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb54-323"><a href="#cb54-323" aria-hidden="true" tabindex="-1"></a><span class="st">  S1 = V1</span></span>
<span id="cb54-324"><a href="#cb54-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-325"><a href="#cb54-325" aria-hidden="true" tabindex="-1"></a><span class="st">$THETA              ;; set realistic initial estimates</span></span>
<span id="cb54-326"><a href="#cb54-326" aria-hidden="true" tabindex="-1"></a><span class="st">  (0, 0.5)  ;1 prop</span></span>
<span id="cb54-327"><a href="#cb54-327" aria-hidden="true" tabindex="-1"></a><span class="st">  (0, 0.1)  ;2 add</span></span>
<span id="cb54-328"><a href="#cb54-328" aria-hidden="true" tabindex="-1"></a><span class="st">  (0, 30)       ;3 CL</span></span>
<span id="cb54-329"><a href="#cb54-329" aria-hidden="true" tabindex="-1"></a><span class="st">  (0, 200)      ;4 V1</span></span>
<span id="cb54-330"><a href="#cb54-330" aria-hidden="true" tabindex="-1"></a><span class="st">  (0, 30)       ;5 Q</span></span>
<span id="cb54-331"><a href="#cb54-331" aria-hidden="true" tabindex="-1"></a><span class="st">  (0, 200)      ;6 V2</span></span>
<span id="cb54-332"><a href="#cb54-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-333"><a href="#cb54-333" aria-hidden="true" tabindex="-1"></a><span class="st">$OMEGA BLOCK(2)</span></span>
<span id="cb54-334"><a href="#cb54-334" aria-hidden="true" tabindex="-1"></a><span class="st">  0.09      ; IIV-CL</span></span>
<span id="cb54-335"><a href="#cb54-335" aria-hidden="true" tabindex="-1"></a><span class="st">  0.01 0.09 ; IIV-V</span></span>
<span id="cb54-336"><a href="#cb54-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-337"><a href="#cb54-337" aria-hidden="true" tabindex="-1"></a><span class="st">$SIGMA</span></span>
<span id="cb54-338"><a href="#cb54-338" aria-hidden="true" tabindex="-1"></a><span class="st">  1 FIX  ;residual variability</span></span>
<span id="cb54-339"><a href="#cb54-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-340"><a href="#cb54-340" aria-hidden="true" tabindex="-1"></a><span class="st">$ERROR              ;; Based on linear data and proportional and additive error</span></span>
<span id="cb54-341"><a href="#cb54-341" aria-hidden="true" tabindex="-1"></a><span class="st">  IPRED = F</span></span>
<span id="cb54-342"><a href="#cb54-342" aria-hidden="true" tabindex="-1"></a><span class="st">  IRES = DV-IPRED</span></span>
<span id="cb54-343"><a href="#cb54-343" aria-hidden="true" tabindex="-1"></a><span class="st">  W = IPRED*THETA(1)+THETA(2)</span></span>
<span id="cb54-344"><a href="#cb54-344" aria-hidden="true" tabindex="-1"></a><span class="st">  IF (W.EQ.0) W = 1</span></span>
<span id="cb54-345"><a href="#cb54-345" aria-hidden="true" tabindex="-1"></a><span class="st">  IWRES = IRES/W</span></span>
<span id="cb54-346"><a href="#cb54-346" aria-hidden="true" tabindex="-1"></a><span class="st">  Y= IPRED+W*ERR(1)</span></span>
<span id="cb54-347"><a href="#cb54-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-348"><a href="#cb54-348" aria-hidden="true" tabindex="-1"></a><span class="st">$EST METHOD=1 MAXEVAL=99999 SIG=3 PRINT=5 NOABORT POSTHOC INTERACTION   ;; Estimation method FOCE+interaction</span></span>
<span id="cb54-349"><a href="#cb54-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-350"><a href="#cb54-350" aria-hidden="true" tabindex="-1"></a><span class="st">$COV PRINT=E UNCONDITIONAL</span></span>
<span id="cb54-351"><a href="#cb54-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-352"><a href="#cb54-352" aria-hidden="true" tabindex="-1"></a><span class="st">$TABLE ID TAD IPRED IWRES CWRES EVID MDV TIME NOPRINT ONEHEADER FILE=SDTAB001</span></span>
<span id="cb54-353"><a href="#cb54-353" aria-hidden="true" tabindex="-1"></a><span class="st">$TABLE ID CL V1 Q V2 ETA1 ETA2 NOPRINT ONEHEADER FILE=PATAB001</span></span>
<span id="cb54-354"><a href="#cb54-354" aria-hidden="true" tabindex="-1"></a><span class="st">$TABLE ID NOPRINT ONEHEADER FILE=COTAB001</span></span>
<span id="cb54-355"><a href="#cb54-355" aria-hidden="true" tabindex="-1"></a><span class="st">$TABLE ID NOPRINT ONEHEADER FILE=CATAB001</span></span>
<span id="cb54-356"><a href="#cb54-356" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span>
<span id="cb54-357"><a href="#cb54-357" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-358"><a href="#cb54-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-359"><a href="#cb54-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-360"><a href="#cb54-360" aria-hidden="true" tabindex="-1"></a>We now want ChatGPT to </span>
<span id="cb54-361"><a href="#cb54-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-362"><a href="#cb54-362" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Find all <span class="in">`$THETA`</span> entries</span>
<span id="cb54-363"><a href="#cb54-363" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Extract the parameter name </span>
<span id="cb54-364"><a href="#cb54-364" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Extract the initial value </span>
<span id="cb54-365"><a href="#cb54-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-366"><a href="#cb54-366" aria-hidden="true" tabindex="-1"></a>and report all this in a *structured* format. First, we define a <span class="in">`Pydantic`</span> class for a single parameter:</span>
<span id="cb54-367"><a href="#cb54-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-368"><a href="#cb54-368" aria-hidden="true" tabindex="-1"></a><span class="in">```{python filename="python"}</span></span>
<span id="cb54-369"><a href="#cb54-369" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb54-370"><a href="#cb54-370" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: false</span></span>
<span id="cb54-371"><a href="#cb54-371" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: false</span></span>
<span id="cb54-372"><a href="#cb54-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-373"><a href="#cb54-373" aria-hidden="true" tabindex="-1"></a><span class="co"># define class per parameter</span></span>
<span id="cb54-374"><a href="#cb54-374" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> OneParameter(BaseModel):</span>
<span id="cb54-375"><a href="#cb54-375" aria-hidden="true" tabindex="-1"></a>    name: <span class="bu">str</span> <span class="op">=</span> Field(..., description<span class="op">=</span><span class="st">"The name of the parameter excluding any strings, typically provided as a comment next to the initial value."</span>)</span>
<span id="cb54-376"><a href="#cb54-376" aria-hidden="true" tabindex="-1"></a>    initial_value: <span class="bu">float</span></span>
<span id="cb54-377"><a href="#cb54-377" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-378"><a href="#cb54-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-379"><a href="#cb54-379" aria-hidden="true" tabindex="-1"></a>As you can see, within the freshly defined <span class="in">`OneParameter`</span> object, the name of the parameter has to be a <span class="in">`string`</span> and the initial value has to be of type <span class="in">`float`</span>. Mixing types within one class is not a problem, and having multiple key-value pairs is also possible. But more to that later.</span>
<span id="cb54-380"><a href="#cb54-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-381"><a href="#cb54-381" aria-hidden="true" tabindex="-1"></a>Please note that we can provide *custom descriptions* to the field by using the <span class="in">`str = Field()`</span> notation. This adds some custom instructions in defining what we expect for this field, and helps to get the correct output for this class.</span>
<span id="cb54-382"><a href="#cb54-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-383"><a href="#cb54-383" aria-hidden="true" tabindex="-1"></a>But we are not done yet. There are multiple parameters in the model code, and we want to extract them all. Currently we would simply get one of the parameters. But as we do not want to hard-code the number of expected parameters, this is a task that should be handled by the LLM.</span>
<span id="cb54-384"><a href="#cb54-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-385"><a href="#cb54-385" aria-hidden="true" tabindex="-1"></a>Luckily, we can simply define a list within a nested class, to indicate that there might be multiple elements. The number of elements will be determined by ChatGPT.</span>
<span id="cb54-386"><a href="#cb54-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-387"><a href="#cb54-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-388"><a href="#cb54-388" aria-hidden="true" tabindex="-1"></a><span class="in">```{python filename="python"}</span></span>
<span id="cb54-389"><a href="#cb54-389" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb54-390"><a href="#cb54-390" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: false</span></span>
<span id="cb54-391"><a href="#cb54-391" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: false</span></span>
<span id="cb54-392"><a href="#cb54-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-393"><a href="#cb54-393" aria-hidden="true" tabindex="-1"></a><span class="co"># define class per parameter</span></span>
<span id="cb54-394"><a href="#cb54-394" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MultipleParameters(BaseModel):</span>
<span id="cb54-395"><a href="#cb54-395" aria-hidden="true" tabindex="-1"></a>    parameter_list: <span class="bu">list</span>[OneParameter]</span>
<span id="cb54-396"><a href="#cb54-396" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-397"><a href="#cb54-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-398"><a href="#cb54-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-399"><a href="#cb54-399" aria-hidden="true" tabindex="-1"></a>Very convenient! We simply define a new class, which will be our output class, and expect it to contain a list of <span class="in">`OneParameter`</span> objects. We do not have to define the length of this list, so depending on the model code we paste as input, the list will hopefully be filled accordingly.</span>
<span id="cb54-400"><a href="#cb54-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-401"><a href="#cb54-401" aria-hidden="true" tabindex="-1"></a>Now we just need to create our response. Let’s see if this works properly. It is worth noting that we also provide some instructions via the <span class="in">`instructions`</span> argument to clarify that we are interested only in <span class="in">`$THETA`</span> and to give a bit of context. The predefined <span class="in">`model_text`</span> will be passed, without further instructions or text, via the input argument. The previously defined <span class="in">`MultipleParameters`</span> class, which expects a list of <span class="in">`OneParameter`</span> classes, will be our <span class="in">`text_format`</span>.</span>
<span id="cb54-402"><a href="#cb54-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-403"><a href="#cb54-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-404"><a href="#cb54-404" aria-hidden="true" tabindex="-1"></a><span class="in">```{python filename="python"}</span></span>
<span id="cb54-405"><a href="#cb54-405" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb54-406"><a href="#cb54-406" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: false</span></span>
<span id="cb54-407"><a href="#cb54-407" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: false</span></span>
<span id="cb54-408"><a href="#cb54-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-409"><a href="#cb54-409" aria-hidden="true" tabindex="-1"></a><span class="co"># prompt chatgpt</span></span>
<span id="cb54-410"><a href="#cb54-410" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> client.responses.parse(</span>
<span id="cb54-411"><a href="#cb54-411" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"gpt-4o"</span>,</span>
<span id="cb54-412"><a href="#cb54-412" aria-hidden="true" tabindex="-1"></a>    <span class="bu">input</span><span class="op">=</span>model_text,</span>
<span id="cb54-413"><a href="#cb54-413" aria-hidden="true" tabindex="-1"></a>    instructions<span class="op">=</span><span class="st">"You are a helpful assistant that reliably extracts the $THETA parameters, specifially the names and the initial values from NONMEM model code"</span>,</span>
<span id="cb54-414"><a href="#cb54-414" aria-hidden="true" tabindex="-1"></a>    text_format<span class="op">=</span>MultipleParameters,</span>
<span id="cb54-415"><a href="#cb54-415" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb54-416"><a href="#cb54-416" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-417"><a href="#cb54-417" aria-hidden="true" tabindex="-1"></a><span class="co"># show answer</span></span>
<span id="cb54-418"><a href="#cb54-418" aria-hidden="true" tabindex="-1"></a>response.output_parsed</span>
<span id="cb54-419"><a href="#cb54-419" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-420"><a href="#cb54-420" aria-hidden="true" tabindex="-1"></a>This is very useful because we have provided messy and unstructured NONMEM code, and with a bit of explanation and a defined output structure, we can quickly extract useful information from the code that enables structured postprocessing. We can now also directly access the values of a particular element:</span>
<span id="cb54-421"><a href="#cb54-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-422"><a href="#cb54-422" aria-hidden="true" tabindex="-1"></a><span class="in">```{python filename="python"}</span></span>
<span id="cb54-423"><a href="#cb54-423" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb54-424"><a href="#cb54-424" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: false</span></span>
<span id="cb54-425"><a href="#cb54-425" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: false</span></span>
<span id="cb54-426"><a href="#cb54-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-427"><a href="#cb54-427" aria-hidden="true" tabindex="-1"></a><span class="co"># show name </span></span>
<span id="cb54-428"><a href="#cb54-428" aria-hidden="true" tabindex="-1"></a>response.output_parsed.parameter_list[<span class="dv">1</span>].name</span>
<span id="cb54-429"><a href="#cb54-429" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-430"><a href="#cb54-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-431"><a href="#cb54-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-432"><a href="#cb54-432" aria-hidden="true" tabindex="-1"></a><span class="in">```{python filename="python"}</span></span>
<span id="cb54-433"><a href="#cb54-433" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb54-434"><a href="#cb54-434" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: false</span></span>
<span id="cb54-435"><a href="#cb54-435" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: false</span></span>
<span id="cb54-436"><a href="#cb54-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-437"><a href="#cb54-437" aria-hidden="true" tabindex="-1"></a><span class="co"># show value</span></span>
<span id="cb54-438"><a href="#cb54-438" aria-hidden="true" tabindex="-1"></a>response.output_parsed.parameter_list[<span class="dv">1</span>].initial_value</span>
<span id="cb54-439"><a href="#cb54-439" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-440"><a href="#cb54-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-441"><a href="#cb54-441" aria-hidden="true" tabindex="-1"></a>We can use the <span class="in">`response`</span> object to create a simple table that summarizes the name and the intial value, making it a bit more accessible:</span>
<span id="cb54-442"><a href="#cb54-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-443"><a href="#cb54-443" aria-hidden="true" tabindex="-1"></a><span class="in">```{python filename="python"}</span></span>
<span id="cb54-444"><a href="#cb54-444" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb54-445"><a href="#cb54-445" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: false</span></span>
<span id="cb54-446"><a href="#cb54-446" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: false</span></span>
<span id="cb54-447"><a href="#cb54-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-448"><a href="#cb54-448" aria-hidden="true" tabindex="-1"></a><span class="co"># load pandas</span></span>
<span id="cb54-449"><a href="#cb54-449" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb54-450"><a href="#cb54-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-451"><a href="#cb54-451" aria-hidden="true" tabindex="-1"></a><span class="co"># define dataframe based on response</span></span>
<span id="cb54-452"><a href="#cb54-452" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame([</span>
<span id="cb54-453"><a href="#cb54-453" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"name"</span>: p.name, <span class="st">"initial"</span>: p.initial_value}</span>
<span id="cb54-454"><a href="#cb54-454" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> p <span class="kw">in</span> response.output_parsed.parameter_list</span>
<span id="cb54-455"><a href="#cb54-455" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb54-456"><a href="#cb54-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-457"><a href="#cb54-457" aria-hidden="true" tabindex="-1"></a><span class="co"># show df</span></span>
<span id="cb54-458"><a href="#cb54-458" aria-hidden="true" tabindex="-1"></a>df</span>
<span id="cb54-459"><a href="#cb54-459" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-460"><a href="#cb54-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-461"><a href="#cb54-461" aria-hidden="true" tabindex="-1"></a>Great! This is definitely handy. But please be aware that - as with any other use of LLMs - we cannot be fully certain that it will work perfectly every time. Hallucinations and errors can occur, so we should never rely on such operations without performing sanity checks. Still, it is easy to see how such a tool can be helpful when systematically extracting data from unstructured text.</span>
<span id="cb54-462"><a href="#cb54-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-463"><a href="#cb54-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-464"><a href="#cb54-464" aria-hidden="true" tabindex="-1"></a><span class="fu"># Agentic workflows</span></span>
<span id="cb54-465"><a href="#cb54-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-466"><a href="#cb54-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-467"><a href="#cb54-467" aria-hidden="true" tabindex="-1"></a>There is much more to learn and explore, and the landscape is changing almost daily. Probably the most exciting thing (to me) are **agentic workflows**, which are worth a closer look.</span>
<span id="cb54-468"><a href="#cb54-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-469"><a href="#cb54-469" aria-hidden="true" tabindex="-1"></a><span class="al">![A single agent.](robot.jpg)</span></span>
<span id="cb54-470"><a href="#cb54-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-471"><a href="#cb54-471" aria-hidden="true" tabindex="-1"></a>Agents can be thought of as model-based units designed to be best at a specific, pre-defined task. They operate based on the above-mentioned custom instructions, structured output formats, and a defined model version (like <span class="in">`gpt-4o`</span>). Here we can combine all our tools and knowledge.</span>
<span id="cb54-472"><a href="#cb54-472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-473"><a href="#cb54-473" aria-hidden="true" tabindex="-1"></a>An important feature of agents is the ability to define so-called *handovers*. This allows one agent to decide on its own to delegate a task to another agent that is better suited for it. This can be extremely powerful!</span>
<span id="cb54-474"><a href="#cb54-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-475"><a href="#cb54-475" aria-hidden="true" tabindex="-1"></a>By using this approach, we can create a capable network of agents that is able to handle complex tasks. With handovers in place, a single, higher-level triage agent can direct requests to the appropriate expert agent and collect their answers.</span>
<span id="cb54-476"><a href="#cb54-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-477"><a href="#cb54-477" aria-hidden="true" tabindex="-1"></a>To illustrate this, let’s replicate the earlier example, but this time using an simple agent network. For this, we first need to install the <span class="in">`OpenAI Agents SDK`</span> library, which was made to deal with such agents more conveniently.</span>
<span id="cb54-478"><a href="#cb54-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-479"><a href="#cb54-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-480"><a href="#cb54-480" aria-hidden="true" tabindex="-1"></a><span class="in">```{r filename="powershell"}</span></span>
<span id="cb54-481"><a href="#cb54-481" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb54-482"><a href="#cb54-482" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: false</span></span>
<span id="cb54-483"><a href="#cb54-483" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: false</span></span>
<span id="cb54-484"><a href="#cb54-484" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb54-485"><a href="#cb54-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-486"><a href="#cb54-486" aria-hidden="true" tabindex="-1"></a><span class="co"># load pandas</span></span>
<span id="cb54-487"><a href="#cb54-487" aria-hidden="true" tabindex="-1"></a>pip install openai<span class="sc">-</span>agents</span>
<span id="cb54-488"><a href="#cb54-488" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-489"><a href="#cb54-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-490"><a href="#cb54-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-491"><a href="#cb54-491" aria-hidden="true" tabindex="-1"></a>Once this was successful, we can again load some agent-specific modules:</span>
<span id="cb54-492"><a href="#cb54-492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-493"><a href="#cb54-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-494"><a href="#cb54-494" aria-hidden="true" tabindex="-1"></a><span class="in">```{python filename="python"}</span></span>
<span id="cb54-495"><a href="#cb54-495" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb54-496"><a href="#cb54-496" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: false</span></span>
<span id="cb54-497"><a href="#cb54-497" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: false</span></span>
<span id="cb54-498"><a href="#cb54-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-499"><a href="#cb54-499" aria-hidden="true" tabindex="-1"></a><span class="co"># load pandas</span></span>
<span id="cb54-500"><a href="#cb54-500" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> agents <span class="im">import</span> Agent, Runner</span>
<span id="cb54-501"><a href="#cb54-501" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-502"><a href="#cb54-502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-503"><a href="#cb54-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-504"><a href="#cb54-504" aria-hidden="true" tabindex="-1"></a>In a next step, we can create an agent that simply mirrors the behavior of our model example above:</span>
<span id="cb54-505"><a href="#cb54-505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-506"><a href="#cb54-506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-507"><a href="#cb54-507" aria-hidden="true" tabindex="-1"></a><span class="in">```{python filename="python"}</span></span>
<span id="cb54-508"><a href="#cb54-508" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb54-509"><a href="#cb54-509" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: false</span></span>
<span id="cb54-510"><a href="#cb54-510" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: false</span></span>
<span id="cb54-511"><a href="#cb54-511" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-512"><a href="#cb54-512" aria-hidden="true" tabindex="-1"></a><span class="co"># define agent</span></span>
<span id="cb54-513"><a href="#cb54-513" aria-hidden="true" tabindex="-1"></a>theta_agent <span class="op">=</span> Agent(</span>
<span id="cb54-514"><a href="#cb54-514" aria-hidden="true" tabindex="-1"></a>  name<span class="op">=</span><span class="st">"Theta Extraction Agent"</span>,</span>
<span id="cb54-515"><a href="#cb54-515" aria-hidden="true" tabindex="-1"></a>  model<span class="op">=</span><span class="st">"gpt-4o"</span>,</span>
<span id="cb54-516"><a href="#cb54-516" aria-hidden="true" tabindex="-1"></a>  instructions<span class="op">=</span><span class="st">"You are a helpful assistant that reliably extracts the $THETA parameters, specifially the names and the initial values from NONMEM model code"</span>,</span>
<span id="cb54-517"><a href="#cb54-517" aria-hidden="true" tabindex="-1"></a>  output_type<span class="op">=</span>MultipleParameters,</span>
<span id="cb54-518"><a href="#cb54-518" aria-hidden="true" tabindex="-1"></a>  handoff_description<span class="op">=</span><span class="st">"Specialist agent that extracts $THETA parameters with their names and initial values"</span></span>
<span id="cb54-519"><a href="#cb54-519" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb54-520"><a href="#cb54-520" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-521"><a href="#cb54-521" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-522"><a href="#cb54-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-523"><a href="#cb54-523" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-524"><a href="#cb54-524" aria-hidden="true" tabindex="-1"></a>Please note that the setup and arguments are quite similar, but we now define it using <span class="in">`Agent()`</span> instead of <span class="in">`client.responses.parse()`</span>, and <span class="in">`text_format`</span> is replaced by <span class="in">`output_type.`</span> One key difference is the <span class="in">`handoff_description`</span> argument, which will become important later. This description provides additional context so that the triage agent (responsible for delegating tasks) can select the appropriate expert agent to handle the request. Another difference is the absence of the <span class="in">`input=model_text`</span> argument, as we are now defining the agent with custom instructions and output format while keeping it agnostic to specific prompts. The input prompt will only be provided when we actually run the agent, which is what we will do next.</span>
<span id="cb54-525"><a href="#cb54-525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-526"><a href="#cb54-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-527"><a href="#cb54-527" aria-hidden="true" tabindex="-1"></a><span class="in">```{python filename="python"}</span></span>
<span id="cb54-528"><a href="#cb54-528" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb54-529"><a href="#cb54-529" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: false</span></span>
<span id="cb54-530"><a href="#cb54-530" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: false</span></span>
<span id="cb54-531"><a href="#cb54-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-532"><a href="#cb54-532" aria-hidden="true" tabindex="-1"></a><span class="co"># run the agent with the model code</span></span>
<span id="cb54-533"><a href="#cb54-533" aria-hidden="true" tabindex="-1"></a>result_theta <span class="op">=</span> Runner.run_sync(theta_agent, <span class="ss">f"Please extract the parameters from this model: </span><span class="sc">{</span>model_text<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb54-534"><a href="#cb54-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-535"><a href="#cb54-535" aria-hidden="true" tabindex="-1"></a><span class="co"># show output</span></span>
<span id="cb54-536"><a href="#cb54-536" aria-hidden="true" tabindex="-1"></a>result_theta</span>
<span id="cb54-537"><a href="#cb54-537" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-538"><a href="#cb54-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-539"><a href="#cb54-539" aria-hidden="true" tabindex="-1"></a>Okay, great! Again a lot of meta data, and we can perform a similar operation (as described above) to extract the parameters in a tabular format.</span>
<span id="cb54-540"><a href="#cb54-540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-541"><a href="#cb54-541" aria-hidden="true" tabindex="-1"></a><span class="in">```{python filename="python"}</span></span>
<span id="cb54-542"><a href="#cb54-542" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb54-543"><a href="#cb54-543" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: false</span></span>
<span id="cb54-544"><a href="#cb54-544" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: false</span></span>
<span id="cb54-545"><a href="#cb54-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-546"><a href="#cb54-546" aria-hidden="true" tabindex="-1"></a>pd.DataFrame([</span>
<span id="cb54-547"><a href="#cb54-547" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"name"</span>: p.name, <span class="st">"initial"</span>: p.initial_value}</span>
<span id="cb54-548"><a href="#cb54-548" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> p <span class="kw">in</span> result_theta.final_output.parameter_list</span>
<span id="cb54-549"><a href="#cb54-549" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb54-550"><a href="#cb54-550" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-551"><a href="#cb54-551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-552"><a href="#cb54-552" aria-hidden="true" tabindex="-1"></a>Please note that <span class="in">`result_theta`</span> no longer contains a structure named <span class="in">`output_parsed`</span>; it is now called <span class="in">`final_output`</span>. </span>
<span id="cb54-553"><a href="#cb54-553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-554"><a href="#cb54-554" aria-hidden="true" tabindex="-1"></a>So far, we have defined an agent that can be reused for various prompts, but it does not yet provide significant additional benefits. To make the example more useful and novel, we will introduce another agent that can generate a short summary of different parts of a model code. These two agents will later be our agentic workflow, once we combine it with a separate traige agent for task delegation. Again, we will create a custom <span class="in">`Pydantic`</span> class for the output with field descriptions and use it to define our custom agent.</span>
<span id="cb54-555"><a href="#cb54-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-556"><a href="#cb54-556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-557"><a href="#cb54-557" aria-hidden="true" tabindex="-1"></a><span class="in">```{python filename="python"}</span></span>
<span id="cb54-558"><a href="#cb54-558" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb54-559"><a href="#cb54-559" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: false</span></span>
<span id="cb54-560"><a href="#cb54-560" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: false</span></span>
<span id="cb54-561"><a href="#cb54-561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-562"><a href="#cb54-562" aria-hidden="true" tabindex="-1"></a><span class="co"># define class per parameter</span></span>
<span id="cb54-563"><a href="#cb54-563" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ModelSummary(BaseModel):</span>
<span id="cb54-564"><a href="#cb54-564" aria-hidden="true" tabindex="-1"></a>  structural: <span class="bu">str</span> <span class="op">=</span> Field(..., description<span class="op">=</span><span class="st">"A short and concise summary about the structural model (excluding covariate effects and stochastic elements). For example: Is it a one-, two-, or three-compartment structure?"</span>)</span>
<span id="cb54-565"><a href="#cb54-565" aria-hidden="true" tabindex="-1"></a>  stochastic: <span class="bu">str</span> <span class="op">=</span> Field(..., description<span class="op">=</span><span class="st">"A short and concise summary about the stochastic model (excluding residual variability). For example: On which parameters do we have interindividual or interoccasion variability included?"</span>)</span>
<span id="cb54-566"><a href="#cb54-566" aria-hidden="true" tabindex="-1"></a>  residual: <span class="bu">str</span> <span class="op">=</span> Field(..., description<span class="op">=</span><span class="st">"A short and concise summary about the residual unexplained variability / error model (excluding IIV or IOV). For example: Do we have an additive, a proportional, or a combined additive-proportional error model?"</span>)</span>
<span id="cb54-567"><a href="#cb54-567" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-568"><a href="#cb54-568" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-569"><a href="#cb54-569" aria-hidden="true" tabindex="-1"></a><span class="co"># define agent</span></span>
<span id="cb54-570"><a href="#cb54-570" aria-hidden="true" tabindex="-1"></a>summary_agent <span class="op">=</span> Agent(</span>
<span id="cb54-571"><a href="#cb54-571" aria-hidden="true" tabindex="-1"></a>  name<span class="op">=</span><span class="st">"Model Summary Agent"</span>,</span>
<span id="cb54-572"><a href="#cb54-572" aria-hidden="true" tabindex="-1"></a>  model<span class="op">=</span><span class="st">"gpt-4o"</span>,</span>
<span id="cb54-573"><a href="#cb54-573" aria-hidden="true" tabindex="-1"></a>  instructions<span class="op">=</span><span class="st">"You are a helpful assistant that provides a short and concise summary for various aspects of a given NONMEM model code"</span>,</span>
<span id="cb54-574"><a href="#cb54-574" aria-hidden="true" tabindex="-1"></a>  output_type<span class="op">=</span>ModelSummary,</span>
<span id="cb54-575"><a href="#cb54-575" aria-hidden="true" tabindex="-1"></a>  handoff_description<span class="op">=</span><span class="st">"Specialist agent that summarizes important aspects of various aspects of a given NONMEM model code"</span></span>
<span id="cb54-576"><a href="#cb54-576" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb54-577"><a href="#cb54-577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-578"><a href="#cb54-578" aria-hidden="true" tabindex="-1"></a><span class="co"># run the agent with the model code</span></span>
<span id="cb54-579"><a href="#cb54-579" aria-hidden="true" tabindex="-1"></a>result_summary <span class="op">=</span> Runner.run_sync(summary_agent, <span class="ss">f"Please give me a structured summary for this model: </span><span class="sc">{</span>model_text<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb54-580"><a href="#cb54-580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-581"><a href="#cb54-581" aria-hidden="true" tabindex="-1"></a><span class="co"># show as table</span></span>
<span id="cb54-582"><a href="#cb54-582" aria-hidden="true" tabindex="-1"></a>result_summary.final_output.structural</span>
<span id="cb54-583"><a href="#cb54-583" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-584"><a href="#cb54-584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-585"><a href="#cb54-585" aria-hidden="true" tabindex="-1"></a><span class="in">```{python filename="python"}</span></span>
<span id="cb54-586"><a href="#cb54-586" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb54-587"><a href="#cb54-587" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: false</span></span>
<span id="cb54-588"><a href="#cb54-588" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: false</span></span>
<span id="cb54-589"><a href="#cb54-589" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-590"><a href="#cb54-590" aria-hidden="true" tabindex="-1"></a>result_summary.final_output.stochastic</span>
<span id="cb54-591"><a href="#cb54-591" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-592"><a href="#cb54-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-593"><a href="#cb54-593" aria-hidden="true" tabindex="-1"></a><span class="in">```{python filename="python"}</span></span>
<span id="cb54-594"><a href="#cb54-594" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb54-595"><a href="#cb54-595" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: false</span></span>
<span id="cb54-596"><a href="#cb54-596" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: false</span></span>
<span id="cb54-597"><a href="#cb54-597" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-598"><a href="#cb54-598" aria-hidden="true" tabindex="-1"></a>result_summary.final_output.residual</span>
<span id="cb54-599"><a href="#cb54-599" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-600"><a href="#cb54-600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-601"><a href="#cb54-601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-602"><a href="#cb54-602" aria-hidden="true" tabindex="-1"></a>Great, we now have two independent agents, each specialized in a specific aspect of extracting information from the model code. The next step is to define a single “meta-agent” that takes a given request and delegates it to the appropriate agent. Such agents are often referred to as “triage agents.”</span>
<span id="cb54-603"><a href="#cb54-603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-604"><a href="#cb54-604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-605"><a href="#cb54-605" aria-hidden="true" tabindex="-1"></a><span class="in">```{python filename="python"}</span></span>
<span id="cb54-606"><a href="#cb54-606" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb54-607"><a href="#cb54-607" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: false</span></span>
<span id="cb54-608"><a href="#cb54-608" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: false</span></span>
<span id="cb54-609"><a href="#cb54-609" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-610"><a href="#cb54-610" aria-hidden="true" tabindex="-1"></a><span class="co"># define triage agent</span></span>
<span id="cb54-611"><a href="#cb54-611" aria-hidden="true" tabindex="-1"></a>triage_agent <span class="op">=</span> Agent(</span>
<span id="cb54-612"><a href="#cb54-612" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"Triage agent"</span>,</span>
<span id="cb54-613"><a href="#cb54-613" aria-hidden="true" tabindex="-1"></a>    instructions<span class="op">=</span>(</span>
<span id="cb54-614"><a href="#cb54-614" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Help the user with their NONMEM model code."</span></span>
<span id="cb54-615"><a href="#cb54-615" aria-hidden="true" tabindex="-1"></a>        <span class="st">"If they ask about the model parameters and their initials, handoff to the theta extraction agent."</span></span>
<span id="cb54-616"><a href="#cb54-616" aria-hidden="true" tabindex="-1"></a>        <span class="st">"If they want to get a structured summary of the code, handoff to the model summary agent."</span></span>
<span id="cb54-617"><a href="#cb54-617" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb54-618"><a href="#cb54-618" aria-hidden="true" tabindex="-1"></a>    handoffs<span class="op">=</span>[theta_agent, summary_agent]</span>
<span id="cb54-619"><a href="#cb54-619" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb54-620"><a href="#cb54-620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-621"><a href="#cb54-621" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-622"><a href="#cb54-622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-623"><a href="#cb54-623" aria-hidden="true" tabindex="-1"></a>As you can see, this is now a high-level triage agent designed to delegate tasks to the previously defined, more specialized agents. The specialized agents are defined via the <span class="in">`handoffs`</span> argument. As with any agent, it is important to provide clear and meaningful instructions; if the results do not meet our expectations, it is always a good idea to revisit and refine these instructions. Such *prompt engineering* can often improve outcomes. With this setup, we can now go ahead and ask the general triage agent a question about the model parameters, hoping that it will correctly forward the request to the <span class="in">`theta_agent`</span>.</span>
<span id="cb54-624"><a href="#cb54-624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-625"><a href="#cb54-625" aria-hidden="true" tabindex="-1"></a><span class="in">```{python filename="python"}</span></span>
<span id="cb54-626"><a href="#cb54-626" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb54-627"><a href="#cb54-627" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: false</span></span>
<span id="cb54-628"><a href="#cb54-628" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: false</span></span>
<span id="cb54-629"><a href="#cb54-629" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-630"><a href="#cb54-630" aria-hidden="true" tabindex="-1"></a><span class="co"># run the agent </span></span>
<span id="cb54-631"><a href="#cb54-631" aria-hidden="true" tabindex="-1"></a>result_triage <span class="op">=</span> Runner.run_sync(triage_agent, <span class="ss">f"What initial parameter estimates have been defined for the attached model? </span><span class="sc">{</span>model_text<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb54-632"><a href="#cb54-632" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-633"><a href="#cb54-633" aria-hidden="true" tabindex="-1"></a><span class="co"># show output</span></span>
<span id="cb54-634"><a href="#cb54-634" aria-hidden="true" tabindex="-1"></a>result_triage.final_output.parameter_list</span>
<span id="cb54-635"><a href="#cb54-635" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-636"><a href="#cb54-636" aria-hidden="true" tabindex="-1"></a>Great, this worked quite well! Let’s see if the other use case works just as smoothly.</span>
<span id="cb54-637"><a href="#cb54-637" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-638"><a href="#cb54-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-639"><a href="#cb54-639" aria-hidden="true" tabindex="-1"></a><span class="in">```{python filename="python"}</span></span>
<span id="cb54-640"><a href="#cb54-640" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb54-641"><a href="#cb54-641" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: false</span></span>
<span id="cb54-642"><a href="#cb54-642" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: false</span></span>
<span id="cb54-643"><a href="#cb54-643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-644"><a href="#cb54-644" aria-hidden="true" tabindex="-1"></a><span class="co"># run the agent </span></span>
<span id="cb54-645"><a href="#cb54-645" aria-hidden="true" tabindex="-1"></a>result_triage <span class="op">=</span> Runner.run_sync(triage_agent, <span class="ss">f"Can you quickly summarize the attached model? </span><span class="sc">{</span>model_text<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb54-646"><a href="#cb54-646" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-647"><a href="#cb54-647" aria-hidden="true" tabindex="-1"></a><span class="co"># show output</span></span>
<span id="cb54-648"><a href="#cb54-648" aria-hidden="true" tabindex="-1"></a>result_triage.final_output.structural</span>
<span id="cb54-649"><a href="#cb54-649" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-650"><a href="#cb54-650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-651"><a href="#cb54-651" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-652"><a href="#cb54-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-653"><a href="#cb54-653" aria-hidden="true" tabindex="-1"></a><span class="in">```{python filename="python"}</span></span>
<span id="cb54-654"><a href="#cb54-654" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb54-655"><a href="#cb54-655" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: false</span></span>
<span id="cb54-656"><a href="#cb54-656" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: false</span></span>
<span id="cb54-657"><a href="#cb54-657" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-658"><a href="#cb54-658" aria-hidden="true" tabindex="-1"></a>result_triage.final_output.stochastic</span>
<span id="cb54-659"><a href="#cb54-659" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-660"><a href="#cb54-660" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-661"><a href="#cb54-661" aria-hidden="true" tabindex="-1"></a><span class="in">```{python filename="python"}</span></span>
<span id="cb54-662"><a href="#cb54-662" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb54-663"><a href="#cb54-663" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: false</span></span>
<span id="cb54-664"><a href="#cb54-664" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: false</span></span>
<span id="cb54-665"><a href="#cb54-665" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-666"><a href="#cb54-666" aria-hidden="true" tabindex="-1"></a>result_triage.final_output.residual</span>
<span id="cb54-667"><a href="#cb54-667" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-668"><a href="#cb54-668" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-669"><a href="#cb54-669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-670"><a href="#cb54-670" aria-hidden="true" tabindex="-1"></a>Perfect! With that we have demonstrated how to build a powerful agent framework using a very simple example. But the possibilities are limitless and you can think much bigger when you consider that each lower-level agent can also have its own handoffs. All you need is to identify your use case and then build your customized framework.</span>
<span id="cb54-671"><a href="#cb54-671" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-672"><a href="#cb54-672" aria-hidden="true" tabindex="-1"></a><span class="fu"># Epilogue</span></span>
<span id="cb54-673"><a href="#cb54-673" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-674"><a href="#cb54-674" aria-hidden="true" tabindex="-1"></a>I am sure there is still plenty left to explore, and new features appear quietly every week. I am always suprised when I check the documentations which new tools have popped-up since my last visit. In my opinion, well‑set‑up agents for small, low‑risk tasks can make our day‑to‑day work a bit smoother and free up time for things that need more focus. Still, even with simple tasks, it’s worth giving the outputs a quick check to be sure everything makes sense, and of course topics such as data protection have to be considered. I hope these first steps were useful to you, and I’d be happy to hear what you think. See you next time!</span>
<span id="cb54-675"><a href="#cb54-675" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">

<div class="cookie-consent-footer"><a href="#" id="open_preferences_center">Cookie Preferences</a></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>