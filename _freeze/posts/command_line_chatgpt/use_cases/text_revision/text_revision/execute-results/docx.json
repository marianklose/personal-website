{
  "hash": "a192363682c6241ce0c979fe366948fb",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: \"ChatGPT based comments on a scientific manuscript\"\nauthor: \"Marian Klose\"\ndate: now\ncallout-appearance: minimal\nexecute:\n  echo: true\n  message: false\n  warning: false\nformat: \n    docx: default\n---\n\n\n\n# Library\n\n::: {.cell execution_count=1}\n``` {.python .cell-code}\n# Load packages\nimport math\nimport nltk\nfrom nltk.tokenize import sent_tokenize\nfrom openai import OpenAI\nimport json\nfrom docx import Document\nfrom pydantic import BaseModel\nfrom datetime import datetime\n```\n:::\n\n\n# NLTK options\n\n::: {.cell execution_count=2}\n``` {.python .cell-code}\n# download the punkt tokenizer\nnltk.download(\"punkt_tab\")\n```\n\n::: {.cell-output .cell-output-display execution_count=2}\n```\nTrue\n```\n:::\n:::\n\n\n# OpenAI options\n\n::: {.cell execution_count=3}\n``` {.python .cell-code}\n# Initialize OpenAI client\nclient = OpenAI()\n\n# Define model\ngpt_model = \"gpt-4o\"\n```\n:::\n\n\n# Functions\n\n::: {.cell execution_count=4}\n``` {.python .cell-code}\n# Function to split text into n nearly equal chunks\ndef split_text_into_enumerated_sentences(text):\n    sentences = sent_tokenize(text)\n    enumerated_sentences = {i + 1: sentence for i, sentence in enumerate(sentences)}\n    return enumerated_sentences\n\n# Function to split the enumerated dictionary into n parts\ndef split_enumerated_sentences_into_chunks(enumerated_sentences, n_chunks):\n    total_sentences = len(enumerated_sentences)\n    chunk_size = math.ceil(total_sentences / n_chunks)\n    chunks = []\n    keys = list(enumerated_sentences.keys())\n    for i in range(0, total_sentences, chunk_size):\n        chunk = {key: enumerated_sentences[key] for key in keys[i:i + chunk_size]}\n        chunks.append(chunk)\n    return chunks\n\n# Function to add a comment to a sentence in Word format (for quarto / pandoc)\ndef add_word_comment(sentence, comment):\n    date = datetime.now().isoformat()\n    return f'[{comment}]{{.comment-start id=\"0\" author=\"ChatGPT\" date=\"{date}\"}}{sentence}[]{{.comment-end id=\"0\"}}'\n```\n:::\n\n\n# Read and process text\n\n::: {.cell execution_count=5}\n``` {.python .cell-code}\n# Load the document\ndoc_path = \"pharmacokinetics.docx\"\ndocument = Document(doc_path)\n\n# Extract full text from the docx\nfull_text = \"\\n\".join([para.text for para in document.paragraphs])\n\n# Split the text into an enumerated dictionary of sentences\nenumerated_sentences = split_text_into_enumerated_sentences(full_text)\n\n# Display the result from element 0 to 5\nprint(list(enumerated_sentences.items())[0:5])\n\n# Split the enumerated sentences into n chunks\nchunks = split_enumerated_sentences_into_chunks(enumerated_sentences, 2)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[(1, 'Pharmacokinetics\\nPharmacokinetics (from Ancient Greek pharmakon \"drug\" and kinetikos \"moving, putting in motion\"; see chemical kinetics), sometimes abbreviated as PK, is a branch of pharmacology dedicated to describing how the body affects a specific substance after administration.'), (2, '[1] The substances of interest include any chemical xenobiotic such as pharmaceutical drugs, pesticides, food additives, cosmetics, etc.'), (3, 'It attempts to analyze chemical metabolism and to discover the fate of a chemical from the moment that it is administered up to the point at which it is completely eliminated from the body.'), (4, \"Pharmacokinetics is based on mathematical modeling that places great emphasis on the relationship between drug plasma concentration and the time elapsed since the drug's administration.\"), (5, 'Pharmacokinetics is the study of how an organism affects the drug, whereas pharmacodynamics (PD) is the study of how the drug affects the organism.')]\n```\n:::\n:::\n\n\n# System and user messages\n\n::: {.cell execution_count=6}\n``` {.python .cell-code}\n# Define system and base user messages for review\nsystem_message = \"You are a professor reviewing a scientific manuscript. You receive a text excerpt for review and each sentence of the text has an unique identifier. Your job is to provide a structured output in a JSON style to indicate for which identifier you have feedback and what the feedback is.\"\nbase_user_message = (\n    \"Please review the following text excerpt for style, errors, conciseness, and understandability. \"\n    \"Provide concise (!) comments for single sentences. Your answer should be short. \"\n    \"Provide structured feedback in JSON format indicating for which sentence you have which feedback.\"\n    \"It is very important that you do not have to provide feedback for every sentence and you should only provide feedback if you have something to say.\"\n)\n```\n:::\n\n\n# Define JSON structure\n\n::: {.cell execution_count=7}\n``` {.python .cell-code}\n# define the pydantic structure for a single sentence feedback\nclass SingleSentenceFeedback(BaseModel):\n    sentence_id: int\n    feedback: str\n\n# define the pydantic structure for a list of feedbacks\nclass MultipleSentencesFeedback(BaseModel):\n    feedback_list: list[SingleSentenceFeedback]\n```\n:::\n\n\n# Process each chunk\n\n::: {.cell execution_count=8}\n``` {.python .cell-code}\n# Collect feedback for all chunks\nall_feedback = []\n\n# Loop over each chunk, call the API, and process the response\nfor idx, chunk in enumerate(chunks):\n    # print message to user\n    print(f\"Processing chunk {idx + 1}/{len(chunks)}\")\n\n    # Prepare user message for the current chunk as JSON\n    user_message = f\"{base_user_message}\\n\\nExcerpt:\\n{json.dumps(chunk)}\"\n\n    try:\n        # Make the API request\n        completion = client.beta.chat.completions.parse(\n            model=gpt_model,\n            messages=[\n                {\"role\": \"system\", \"content\": system_message},\n                {\"role\": \"user\", \"content\": user_message}\n            ],\n            response_format=MultipleSentencesFeedback\n        )\n\n        # Extract the parsed response \n        feedback = completion.choices[0].message.parsed\n\n        # Extend the all_feedback object\n        all_feedback.extend(feedback.feedback_list)\n\n    except Exception as e:\n        print(f\"Error at chunk {idx}: {e}\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nProcessing chunk 1/2\nProcessing chunk 2/2\n```\n:::\n:::\n\n\n# Apply comments to the document\n\n::: {.cell execution_count=9}\n``` {.python .cell-code}\n# Apply comments to the sentences\nfor feedback_item in all_feedback:\n    sentence_id = feedback_item.sentence_id\n    feedback_text = feedback_item.feedback\n    if sentence_id in enumerated_sentences:\n        original_sentence = enumerated_sentences[sentence_id]\n        commented_sentence = add_word_comment(original_sentence, feedback_text)\n        enumerated_sentences[sentence_id] = commented_sentence\n\n# Combine sentences back into full text\ncommented_text = \" \".join(enumerated_sentences.values())\n```\n:::\n\n\n# Print document\n\n``` {.python .cell-code}\n# Print the commented text\nprint(commented_text)\n```\n[The definition is verbose; consider simplifying the explanation of pharmacokinetics.]{.comment-start id=\"0\" author=\"ChatGPT\" date=\"2025-01-13T16:51:38.564917\"}Pharmacokinetics\nPharmacokinetics (from Ancient Greek pharmakon \"drug\" and kinetikos \"moving, putting in motion\"; see chemical kinetics), sometimes abbreviated as PK, is a branch of pharmacology dedicated to describing how the body affects a specific substance after administration.[]{.comment-end id=\"0\"} [1] The substances of interest include any chemical xenobiotic such as pharmaceutical drugs, pesticides, food additives, cosmetics, etc. It attempts to analyze chemical metabolism and to discover the fate of a chemical from the moment that it is administered up to the point at which it is completely eliminated from the body. Pharmacokinetics is based on mathematical modeling that places great emphasis on the relationship between drug plasma concentration and the time elapsed since the drug's administration. Pharmacokinetics is the study of how an organism affects the drug, whereas pharmacodynamics (PD) is the study of how the drug affects the organism. Both together influence dosing, benefit, and adverse effects, as seen in PK/PD models. [The sentence is long and can be confusing; consider breaking it into two sentences for clarity.]{.comment-start id=\"0\" author=\"ChatGPT\" date=\"2025-01-13T16:51:38.564917\"}ADME\nA number of phases occur once the drug enters into contact with the organism, these are described using the acronym ADME (or LADME if liberation is included as a separate step from absorption):\nLiberation – the process of the active ingredient separating from its pharmaceutical formulation.[]{.comment-end id=\"0\"} [3][4] See also IVIVC. Absorption – the process of a drug entering into systemic circulation from the site of administration\nDistribution – the dispersion or dissemination of substances throughout the fluids and tissues of the body. Metabolism (or biotransformation, or inactivation) – the chemical reactions of the drug and irreversible breakdown into metabolites (e.g. by metabolic enzymes such as cytochrome P450 or glucuronosyltransferase enzymes)\nExcretion – the removal of the substance or metabolites from the body. In rare cases, some drugs irreversibly accumulate in body tissue. [citation needed]\nSome textbooks combine the first two phases as the drug is often administered in an active form, which means that there is no liberation phase. Others include a phase that combines distribution, metabolism and excretion into a disposition phase. Other authors include the drug's toxicological aspect in what is known as ADME-Tox or ADMET. The two phases of metabolism and excretion can be grouped together under the title elimination. The study of these distinct phases involves the use and manipulation of basic concepts in order to understand the process dynamics. [Sentence is complex and hard to follow; break down into simpler sentences.]{.comment-start id=\"0\" author=\"ChatGPT\" date=\"2025-01-13T16:51:38.564917\"}For this reason, in order to fully comprehend the kinetics of a drug it is necessary to have detailed knowledge of a number of factors such as: the properties of the substances that act as excipients, the characteristics of the appropriate biological membranes and the way that substances can cross them, or the characteristics of the enzyme reactions that inactivate the drug.[]{.comment-end id=\"0\"} Metrics\nThe following are the most commonly measured pharmacokinetic metrics:[5] The units of the dose in the table are expressed in moles (mol) and molar (M). To express the metrics of the table in units of mass, instead of Amount of substance, simply replace 'mol' with 'g' and 'M' with 'g/L'. Similarly, other units in the table may be expressed in units of an equivalent dimension by scaling. [6] In pharmacokinetics, steady state refers to the situation where the overall intake of a drug is fairly in dynamic equilibrium with its elimination. In practice, it is generally considered that once regular dosing of a drug is started, steady state is reached after 3 to 5 times its half-life. In steady state and in linear pharmacokinetics, AUCτ=AUC∞. [8]\nModeling\nModels have been developed to simplify conceptualization of the many processes that take place in the interaction between an organism and a chemical substance. Pharmacokinetic modelling may be performed either by noncompartmental or compartmental methods. [The sentence is too complex. Split it for clarity.]{.comment-start id=\"0\" author=\"ChatGPT\" date=\"2025-01-13T16:51:38.564917\"}Multi-compartment models provide the best approximations to reality; however, the complexity involved in adding parameters with that modelling approach means that monocompartmental models and above all two compartmental models are the most-frequently used.[]{.comment-end id=\"0\"} The model outputs for a drug can be used in industry (for example, in calculating bioequivalence when designing generic drugs) or in the clinical application of pharmacokinetic concepts. Clinical pharmacokinetics provides many performance guidelines for effective and efficient use of drugs for human-health professionals and in veterinary medicine. [The sentence is vague; specify types of formulas and graphical representations.]{.comment-start id=\"0\" author=\"ChatGPT\" date=\"2025-01-13T16:51:38.564917\"}Models generally take the form of mathematical formulas that have a corresponding graphical representation.[]{.comment-end id=\"0\"} [The sentence is lengthy and could be split for easier readability.]{.comment-start id=\"0\" author=\"ChatGPT\" date=\"2025-01-13T16:51:38.564917\"}The use of these models allows an understanding of the characteristics of a molecule, as well as how a particular drug will behave given information regarding some of its basic characteristics such as its acid dissociation constant (pKa), bioavailability and solubility, absorption capacity and distribution in the organism.[]{.comment-end id=\"0\"} A variety of analysis techniques may be used to develop models, such as nonlinear regression or curve stripping. Noncompartmental analysis\nNoncompartmental methods estimate PK parameters directly from a table of concentration-time measurements. Noncompartmental methods are versatile in that they do not assume any specific model and generally produce accurate results acceptable for bioequivalence studies. Total drug exposure is most often estimated by area under the curve (AUC) methods, with the trapezoidal rule (numerical integration) the most common method. [Clarify 'length of x'; it's not immediately clear what 'x' refers to.]{.comment-start id=\"0\" author=\"ChatGPT\" date=\"2025-01-13T16:51:38.564917\"}Due to the dependence on the length of x in the trapezoidal rule, the area estimation is highly dependent on the blood/plasma sampling schedule.[]{.comment-end id=\"0\"} That is, the closer time points are, the closer the trapezoids reflect the actual shape of the concentration-time curve. The number of time points available in order to perform a successful NCA analysis should be enough to cover the absorption, distribution and elimination phase to accurately characterize the drug. Beyond AUC exposure measures, parameters such as Cmax (maximum concentration), Tmax (time to maximum concentration), CL and Vd can also be reported using NCA methods.\n\n\n",
    "supporting": [
      "text_revision_files"
    ],
    "filters": []
  }
}